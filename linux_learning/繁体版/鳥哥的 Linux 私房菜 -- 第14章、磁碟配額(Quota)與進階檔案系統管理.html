<!DOCTYPE html>
<!-- saved from url=(0048)http://linux.vbird.org/linux_basic/0420quota.php -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="Author" content="VBird, 鳥哥">
	<meta name="Description" content="可以公平使用磁碟容量的 Quota 以及可增加磁碟容量的 RAID, LVM, iSCSI 設備等介紹">
	<title>鳥哥的 Linux 私房菜 -- 第十四章、磁碟配額(Quota)與進階檔案系統管理</title>
	<style>
	</style>
	<link href="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/style_2013.css" rel="stylesheet" type="text/css">
</head>
<body>

<!--最上方的一些連結與網站介紹 -->
<div class="toparea">
<span style="text-shadow: 1px 1px 2px black;">鳥哥的 Linux 私房菜</span>
<ul>
		<li class="topareali"><a href="http://linux.vbird.org/linux_basic/0420quota.php#">第十四章、磁碟配額(Quota)與進階檔案系統管理</a></li>
		<li><a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的 Linux 私房菜首頁">繁體主站</a></li>
	<li><a href="http://linux.vbird.org/linux_basic/" title="Linux 基礎學習篇，從頭學習 Linux">基礎篇</a></li>
	<li><a href="http://linux.vbird.org/linux_server/" title="Linux 伺服器架設篇">伺服器</a></li>
	<li><a href="http://linux.vbird.org/linux_enterprise/" title="Linux 企業應用篇">企業應用</a></li>
	<li><a href="http://linux.vbird.org/linux_desktop/" title="Linux 桌面應用篇">桌面應用</a></li>
	<li><a href="http://linux.vbird.org/linux_security/" title="Linux 安全管理篇">安全管理</a></li>
	<li><a href="http://linux.vbird.org/book/" title="書籍勘誤">書籍勘誤</a></li>
	<li><a href="http://linux.vbird.org/vbird/" title="關於鳥哥的一些事情">鳥哥我</a></li>
</ul>
<iframe src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/index_2013.html" style="height: 29px; width: 150px; border:0; padding:0; margin: 0;
		position: relative; float: right; overflow: hidden"></iframe>
</div>

<div class="leftarea">
<a href="http://linux.vbird.org/linux_basic/0410accountmanager.php">&lt;&lt;</a>
</div>

<!-- 正中央的 1000 像素的內容 -->
<div class="tablearea">
<!-- 左邊的連結東東 -->
<div class="nav">
	<div style="text-align:center; line-height:1; font-size: 9pt; font-family: &#39;Times New Roman&#39;; color: #ff6600;
	padding: 5px; margin: 2px;">
		<img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/Count.cgi" alt="鳥站的上線人數統計" height="26" width="110"><br>
		since 2002/01/01
	</div>
<ul>
	<li><a href="http://linux.vbird.org/new_linux.php">新手建議</a></li>
	<li><a href="http://linux.vbird.org/howtoread.php">開始閱讀之前</a></li>
	<li><a href="http://linux.vbird.org/aboutmysite.php">網站導覽</a></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_basic">Linux 基礎文件</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/">基礎文件彙整表</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0105computers.php">0.計算機概論</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0110whatislinux.php">1.Linux是什麼</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0130designlinux.php">2.主機規劃與磁碟分割</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0157installcentos7.php">3.安裝CentOS 7.x</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0160startlinux.php">4.首次登入與man page</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0210filepermission.php">5.檔案權限與目錄配置</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0220filemanager.php">6.檔案與目錄管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0230filesystem.php">7.磁碟與檔案系統</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0240tarcompress.php">8.壓縮指令的運用</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0310vi.php">9.vim程式編輯器</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0320bash.php">10.認識與學習BASH</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0330regularex.php">11.正規表示法與文件格式化</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0340bashshell-scripts.php">12.學習shell scripts</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0410accountmanager.php">13.帳號管理與ACL</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php">14.Quota, RAID, LVM</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php">15.at, crontab, anacron</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0440processcontrol.php">16.程序管理與 SELinux</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0560daemons.php">17.認識系統服務(daemon)</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0570syslog.php">18.認識與分析登錄檔</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0510osloader.php">19.開機流程模組管理與Loader</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0610hardware.php">20.基礎系統設定與備份策略</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0520source_code_and_tarball.php">21.原始碼與 Tarball</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0520rpm_and_srpm.php">22.RPM/YUM/SRPM</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0590xwindow.php">23.X-Window 設定</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0540kernel.php">24.Linux 核心編譯</a></li>
		<li>底下尚未更新</li>
		<li><a href="http://linux.vbird.org/linux_basic/1010index.php">27.快速索引</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/1010appendix_A.php">附錄 A: GPL 條文</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/1010appendix_B.php">附錄 B: ext2/ext3</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0140spfdisk.php">SPFDISK 範例</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0150installredhat.php">安裝 RedHat 7.2</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0155installmdk.php">安裝 Mandrake 9</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0156installfc4.php">安裝 Fedora IV</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/9999questions.php">Linux 練習題</a></li>

		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/centos5.php">CentOS 5.x(2009-2014)</a>
		</li>

		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/fc4.php">Fedora-4(2005-2008)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/mandrake9.0.php">Mandrake9.0(2001-2004)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/redhat6.1/">RH6.1文件(2001前)</a>
		</li>
	</ul></li>

	<li class="nav_more"><a href="http://linux.vbird.org/linux_basic_train">Linux 基礎訓練</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic_train/">課程章節、授課方式、評分方式</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit01.php">第 01 堂課：指令列模式初探</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit02.php">第 02 堂課：指令下達與檔案管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit03.php">第 03 堂課：檔案管理與 vim</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit04.php">第 04 堂課：檔案權限與帳號管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit05.php">第 05 堂課：權限應用與程序觀察</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit06.php">第 06 堂課：基礎檔案系統管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit07.php">第 07 堂課：bash 與系統救援</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/practice1.php">期中練習</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit08.php">第 08 堂課：連續指令與資料流導向</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit09.php">第 09 堂課：正規表示法與 script</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit10.php">第 10 堂課：使用者管理與 ACL</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit11.php">第 11 堂課：基礎設定、壓縮、排程</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit12.php">第 12 堂課：管理管理與登錄檔</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit13.php">第 13 堂課：服務管理與開機流程</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit14.php">第 14 堂課：進階檔案系統管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/practice2.php">期末練習</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit15.php">第 15 堂課：Linux系統的準備</a></li>
	</ul></li>

	<li class="nav_more"><a href="http://linux.vbird.org/linux_server/">Linux 架站文件</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_server/">伺服器篇文件彙整表</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0104mytalking.php">0. 說說笑笑談 Linux server 規劃</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0107cloudandvm.php">1. 小型雲系統與主機安全強化流程</a></li>



		<li><a href="http://linux.vbird.org/linux_server/0103introduce.php">序篇</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0105beforeserver.php">1.架設伺服器前的準備工作</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0110network_basic.php">2.基礎網路概念</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0120intranet.php">3.區域網路設定</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0130internet_connect.php">4.連上 Internet</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0140networkcommand.php">5.Linux網路指令</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0150detect_network.php">6.Linux網路偵錯</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0210network-secure.php">7.網路安全,port限制,網路升級,SELinux</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0230router.php">8.路由概念與路由器</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0250simple_firewall.php">9.防火牆與 NAT 伺服器</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0270dynamic_dns.php">10.申請合法主機名稱</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0310telnetssh.php">11.遠端連線伺服器</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0340dhcp.php">12.DHCP Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0330nfs.php">13.NFS Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0430nis.php">14.NIS Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0440ntp.php">15.NTP Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0370samba.php">16.SAMBA Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0420squid.php">17.Proxy Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0460iscsi.php">18.iSCSI Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0350dns.php">19.DNS Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0360apache.php">20.WWW Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0410vsftpd.php">21.vsFTPD Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0380mail.php">22.Mail Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0450apt.php">APT/YUM Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0520openwebmail.php">OpenWebMail</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0600cluster.php">Cluster System</a></li>
		<li><a href="http://linux.vbird.org/linux_server/1000results.php">來做練習</a></li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/redhat6.1/">RH6.1文件(2001前)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/redhat9.php">Red Hat 9(2002-2005)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/centos4.php">CentOS 4(2006-2010)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/centos5.php">CentOS 5(2010-2011)</a></li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_enterprise/">Linux 企業應用</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_enterprise/">企業應用篇彙整表</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/0110network.php">1. 區域網路軟硬體設定</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/0120installation.php">2. PXE 安裝伺服器與 kickstart</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/xen.php">Xen 虛擬機器</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/cputune.php">CPU 效能優化</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/kerberos.php">kerberos 與 NFS 加密</a></li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_security/">Linux 安全管理</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_security/0420rkhunter.php">rkhunter 檢測</a></li>
		<li><a href="http://linux.vbird.org/linux_security/knockd.php">knockd</a></li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_security/old/">舊的安全文件</a>
		</li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_desktop/">Linux 桌面應用</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_desktop/0110linuxbasic.php">Linux 基礎概念</a></li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/resources.php">鳥哥彙整的資料</a>
	<ul>
		<li><a href="http://linux.vbird.org/resources.php">Linux 資料庫</a></li>
		<li><a href="http://linux.vbird.org/problem">一些問題彙整</a></li>
		<li><a href="http://linux.vbird.org/othersites">網路連結</a></li>
		<li class="nav_more"><a href="http://linux.vbird.org/solaris/">Solaris</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/apache_packages/">Apache 套件安裝</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/adsl">ADSL 相關文件</a>
		</li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/vbird/index.php">關於鳥哥</a>
	<ul>
		<li><a href="http://linux.vbird.org/vbird/vbird3.php">Why 鳥哥?</a></li>
		<li><a href="http://linux.vbird.org/vbird/vbird.php">關於鳥哥</a></li>
		<li><a href="http://linux.vbird.org/vbird/vbird2.php">關於鳥哥-2</a></li>
		<li><a href="http://linux.vbird.org/vbird/20070718-1.php">2007-07-xx</a></li>
		<li><a href="http://linux.vbird.org/vbird/20070520.php">2007-05-20</a></li>
		<li><a href="http://linux.vbird.org/vbird/20070328.php">2007-03-28</a></li>
		<li><a href="http://linux.vbird.org/vbird/20060701.php">2006-07-01</a></li>
		<li><a href="http://linux.vbird.org/vbird/20060122.php">2006-01-24</a></li>
		<li><a href="http://linux.vbird.org/vbird/20050412.php">2005-04-12</a></li>
		<li><a href="http://linux.vbird.org/vbird/20050401.php">2005-04-01</a></li>
		<li><a href="http://linux.vbird.org/vbird/20041101.php">2004-11-01</a></li>
		<li><a href="http://linux.vbird.org/vbird/20040829.php">2004-08-29</a></li>
		<li><a href="http://linux.vbird.org/vbird/20040417.php">2004-04-17</a></li>
		<li><a href="http://linux.vbird.org/vbird/20040221.php">2004-02-21</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/somepaper">網友分享</a></li>
	<li><a href="http://linux.vbird.org/faq.php">特殊問題解決</a></li>
	<!--li><a href="/download">檔案下載中心</a></li-->
	<li><a href="http://linux.vbird.org/Searching.php">網站資料搜尋</a></li>
</ul>

<p style="text-align:center; margin: 0 0 0 0 ;">
<a href="http://jigsaw.w3.org/css-validator/check/referer" target="_blank">
<img style="border:0;width:66px;height:24px" src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vcss-blue" alt="Valid CSS!">
</a>
<a href="http://validator.w3.org/check?uri=referer" target="_blank">
<img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/valid-html401" style="border:0;width:66px;height:24px" alt="Valid HTML 5" title="Valid HTML 5"></a>
</p>
<p style="text-align:center; margin: 0 0 0 0 ; line-height:1; font-size: 9pt;color: #333333; ">
今日 <img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/Count(1).cgi" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
昨日 <img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/yestoday.gif" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
本月 <img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/Count(2).cgi" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
上月 <img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/lastmonth.gif" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
</p>
</div>

<a id="top"></a>
<div class="mainarea">
<div class="block1">
<!-- 本文的檔頭部分 -->
<h1>第十四章、磁碟配額(Quota)與進階檔案系統管理</h1>
<div style="text-align:right">
	<span class="text_history">最近更新日期：2015/07/28</span>
</div>


<!-- 本文的檔頭部分 -->
<div class="abstract">
	<p>如果您的 Linux 伺服器有多個用戶經常存取資料時，為了維護所有使用者在硬碟容量的公平使用，磁碟配額 
	(Quota) 就是一項非常有用的工具！另外，如果你的用戶常常抱怨磁碟容量不夠用，那麼更進階的檔案系統就得要學習學習。
	本章我們會介紹磁碟陣列 (RAID) 及邏輯捲軸檔案系統 (LVM)，這些工具都可以幫助你管理與維護使用者可用的磁碟容量喔！</p>
</div>

<!-- 本文的連結區部分 -->
<div class="links">
<ul>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#the_quota">14.1 磁碟配額 (Quota) 的應用與實作</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#the_quota_whatis">14.1.1 什麼是 Quota</a>：
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#the_quota_use">一般用途</a>,  
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#the_quota_limit">限制</a>, 
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#the_quota_set">規範 (inode/block, soft/hard, grace time)</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_flow">14.1.2 一個 XFS 檔案系統的 Quota 的實作範例</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_flow_1">14.1.3 實作 Quota 流程-1：檔案系統的支援與觀察</a> <a href="http://linux.vbird.org/linux_basic/0420quota.php#fstab">(/etc/fstab, /etc/mtab)</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_flow_2">14.1.4 實作 Quota 流程-2：觀察 Quota 報告資料</a> (<a href="http://linux.vbird.org/linux_basic/0420quota.php#xfs_quota">xfs_quota</a>,
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#report">print, df, report, state</a>)</li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_flow_3">14.1.5 實作 Quota 流程-3：限制值設定方式</a> (<a href="http://linux.vbird.org/linux_basic/0420quota.php#limit">limit, grace_time</a>)</li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_flow_4">14.1.6 實作 Quota 流程-4：project 的限制 (針對目錄限制) (Optional)</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_manage">14.1.7 XFS quota 的管理與額外指令對照表</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#quota_nochange">14.1.8 不更動既有系統的 Quota 實例</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid">14.2 軟體磁碟陣列 (Software RAID)</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid_what">14.2.1 什麼是 RAID</a>： <a href="http://linux.vbird.org/linux_basic/0420quota.php#raid0">RAID-0</a>, <a href="http://linux.vbird.org/linux_basic/0420quota.php#raid1">RAID-1</a>,
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#raid0_1">RAID1+0</a>, <a href="http://linux.vbird.org/linux_basic/0420quota.php#raid5">RAID-5</a>, <a href="http://linux.vbird.org/linux_basic/0420quota.php#spare">Spare disk</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid_so_ha">14.2.2 software, hardware RAID</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid_setup">14.2.3 軟體磁碟陣列的設定</a>： <a href="http://linux.vbird.org/linux_basic/0420quota.php#mdadm_create">mdadm --create</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid_rescue">14.2.4 模擬 RAID 錯誤的救援模式</a>： <a href="http://linux.vbird.org/linux_basic/0420quota.php#mdadm_manage">mdadm --manage</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid_auto">14.2.5 開機自動啟動 RAID 並自動掛載</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#raid_stop">14.2.6 關閉軟體 RAID(重要！)</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm">14.3 邏輯捲軸管理員 (Logical Volume Manager)</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm_whatis">14.3.1 什麼是 LVM： PV, PE, VG, LV 的意義</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm_flow">14.3.2 LVM 實作流程</a>： <a href="http://linux.vbird.org/linux_basic/0420quota.php#the_pv">PV 階段</a>, <a href="http://linux.vbird.org/linux_basic/0420quota.php#the_vg">VG 階段</a>,
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#the_lv">LV 階段</a>, <a href="http://linux.vbird.org/linux_basic/0420quota.php#the_file">檔案系統階段</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm_large">14.3.3 放大 LV 容量</a>： <a href="http://linux.vbird.org/linux_basic/0420quota.php#xfs_growfs">xfs_growfs</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm_thin">14.3.4 使用 LVM thin Volume 讓 LVM 動態自動調整磁碟使用率</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm_snapshot">14.3.5 LVM 的磁碟快照</a>： 
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#snapshot_create">建立傳統快照</a>, 
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#snapshot_rescue">以快照還原</a>,
			<a href="http://linux.vbird.org/linux_basic/0420quota.php#snapshot_test">用於測試環境</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm_hint">14.3.6 LVM 相關指令彙整與 LVM 的關閉</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#hint">14.4 重點回顧</a></li>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#ex">14.5 本章習題</a></li>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#reference">14.6 參考資料與延伸閱讀</a></li>
	<li><a href="http://phorum.vbird.org/viewtopic.php?t=23888" target="_blank">針對本文的建議：http://phorum.vbird.org/viewtopic.php?t=23888</a></li>

</ul>
</div>
</div>


<!-- 本文的正式部分 -->
<a id="the_quota"></a>
<div class="block1">
<h2>14.1 磁碟配額 (Quota) 的應用與實作</h2>

	<p>Quota 這個玩意兒就字面上的意思來看，就是有多少『限額』的意思啦！如果是用在零用錢上面，
	就是類似『<span class="text_import2">有多少零用錢一個月</span>』的意思之類的。如果是在電腦主機的磁碟使用量上呢？以
	Linux 來說，就是有多少容量限制的意思囉。我們可以使用 quota 來讓磁碟的容量使用較為公平，
	底下我們會介紹什麼是 quota ，然後以一個完整的範例來介紹 quota 的實作喔！</p>

	<a id="the_quota_whatis"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.1 什麼是 Quota</h2>

		<p>在 Linux 系統中，由於是多人多工的環境，所以會有多人共同使用一個硬碟空間的情況發生，
		如果其中有少數幾個使用者大量的佔掉了硬碟空間的話，那勢必壓縮其他使用者的使用權力！
		因此管理員應該適當的限制硬碟的容量給使用者，以妥善的分配系統資源！避免有人抗議呀！</p>

		<p>舉例來說，我們使用者的預設家目錄都是在 /home 底下，如果 /home 是個獨立的 partition ，
		假設這個分割槽有 10G 好了，而 /home 底下共有 30 個帳號，也就是說，每個使用者平均應該會有 333MB 的空間才對。
		偏偏有個使用者在他的家目錄底下塞了好多隻影片，佔掉了 8GB 的空間，想想看，是否造成其他正常使用者的不便呢？
		如果想要讓磁碟的容量公平的分配，這個時候就得要靠 quota 的幫忙囉！</p>

		<a id="the_quota_use"></a>
		<ul class="toplist"><li>Quota 的一般用途 (<a href="http://linux.vbird.org/linux_basic/0420quota.php#ps1">註1</a>)</li></ul>

		<p>quota 比較常使用的幾個情況是：</p>
		<ul class="text_import2">
		<li>針對 WWW server ，例如：每個人的網頁空間的容量限制！</li>
		<li>針對 mail server，例如：每個人的郵件空間限制。</li>
		<li>針對 file server，例如：每個人最大的可用網路硬碟空間 (教學環境中最常見！)</li>
		</ul>

		<p>上頭講的是針對網路服務的設計，如果是針對 Linux 系統主機上面的設定那麼使用的方向有底下這一些：</p>
		<ul>
		<li><span class="text_import2">限制某一群組所能使用的最大磁碟配額 (使用群組限制)</span>：<br>
		你可以將你的主機上的使用者分門別類，有點像是目前很流行的付費與免付費會員制的情況，
		你比較喜好的那一群的使用配額就可以給高一些！呵呵！ ^_^...<br><br></li>

		<li><span class="text_import2">限制某一使用者的最大磁碟配額 (使用使用者限制)</span>：<br>
		在限制了群組之後，你也可以再繼續針對個人來進行限制，使得同一群組之下還可以有更公平的分配！<br><br></li>

		<li><span class="text_import2">限制某一目錄 (directory, project) 的最大磁碟配額</span>：<br>
		在舊版的 CentOS 當中，使用的預設檔案系統為 EXT 家族，這種檔案系統的磁碟配額主要是針對整個檔案系統來處理，所以大多針對『掛載點』進行設計。
		新的 xfs 可以使用 project 這種模式，就能夠針對個別的目錄 (非檔案系統喔) 來設計磁碟配額耶！超棒的！</li></ul>

		<p>大概有這些實際的用途啦！基本上，quota 就是在回報管理員磁碟使用率以及讓管理員管理磁碟使用情況的一個工具就是了！
		比較特別的是，XFS 的 quota 是整合到檔案系統內，並不是其他外掛的程式來管理的，因此，透過 quota 來直接回報磁碟使用率，要比 unix 工具來的快速！
		舉例來說， du 這東西會重新計算目錄下的磁碟使用率，但 xfs 可以透過 xfs_quota 來直接回報各目錄使用率，速度上是快非常多！</p>

		<a id="the_quota_limit"></a>
		<ul class="toplist"><li>Quota 的使用限制</li></ul>

		<p>雖然 quota 很好用，但是使用上還是有些限制要先瞭解的：</p>

		<ul>
		<li><span class="text_import2">在 EXT 檔案系統家族僅能針對整個 filesystem：</span><br>
		EXT 檔案系統家族在進行 quota 限制的時候，它僅能針對整個檔案系統來進行設計，無法針對某個單一的目錄來設計它的磁碟配額。
		因此，如果你想要使用不同的檔案系統進行 quota 時，請先搞清楚該檔案系統支援的情況喔！因為 XFS 已經可以使用 project 模式來設計不同目錄的磁碟配額。<br><br></li>

		<li><span class="text_import2">核心必須支援 quota ：</span><br>
		Linux 核心必須有支援 quota 這個功能才行：如果你是使用 CentOS 7.x 的預設核心，
		嘿嘿！那恭喜你了，你的系統已經預設有支援 quota 這個功能囉！如果你是自行編譯核心的，
		那麼請特別留意你是否已經『真的』開啟了 quota 這個功能？否則底下的功夫將全部都視為『白工』。<br><br></li>

		<li><span class="text_import2">只對一般身份使用者有效：</span><br>
		這就有趣了！並不是所有在 Linux 上面的帳號都可以設定 quota 呢，例如 root 就不能設定 quota ，
		因為整個系統所有的資料幾乎都是他的啊！ ^_^<br><br></li>

		<li><span class="text_import2">若啟用 SELinux，非所有目錄均可設定 quota ：</span><br>
		新版的 CentOS 預設都有啟用 SELinux 這個核心功能，該功能會加強某些細部的權限控制！由於擔心管理員不小心設定錯誤，因此預設的情況下，
		quota 似乎僅能針對 /home 進行設定而已～因此，如果你要針對其他不同的目錄進行設定，請參考到後續章節查閱解開 SELinux 限制的方法喔！
		這就不是 quota 的問題了...</li>
		</ul>

		<p>新版的 CentOS 使用的 xfs 確實比較有趣！不但無須額外的 quota 紀錄檔，也能夠針對檔案系統內的不同目錄進行配置！相當有趣！
		只是<span class="text_import2">不同的檔案系統在 quota 的處理情況上不太相同，因此這裡要特別強調，進行 quota 前，先確認你的檔案系統吧！</span></p>

		<a id="the_quota_set"></a>
		<ul class="toplist"><li>Quota 的規範設定項目：</li></ul>

		<p>quota 這玩意兒針對 XFS filesystem 的限制項目主要分為底下幾個部分：</p>

		<div class="illus">
		<ul><li>分別針對使用者、群組或個別目錄 (user, group &amp; project)：</li></ul>

		<p>XFS 檔案系統的 quota 限制中，主要是針對群組、個人或單獨的目錄進行磁碟使用率的限制！</p>

		<ul><li>容量限制或檔案數量限制 (block 或 inode)：</li></ul>

		<p>我們在<a href="http://linux.vbird.org/linux_basic/0230filesystem.php">第七章</a>談到檔案系統中，說到檔案系統主要規劃為存放屬性的 
		inode 與實際檔案資料的 block 區塊，Quota 既然是管理檔案系統，所以當然也可以管理 inode 或 block 囉！
		這兩個管理的功能為：</p>

		<ul class="text_import2" style="margin-left: 40px; list-style-type: square"><li>限制 inode 用量：可以管理使用者可以建立的『檔案數量』；</li>
		<li>限制 block 用量：管理使用者磁碟容量的限制，較常見為這種方式。</li></ul>

		<ul><li>柔性勸導與硬性規定 (soft/hard)：</li></ul>

		<p>既然是規範，當然就有限制值。不管是 inode/block ，限制值都有兩個，分別是 soft 與 hard。
		通常 hard 限制值要比 soft 還要高。舉例來說，若限制項目為 block ，可以限制 hard 為 500MBytes 而 soft
		為 400MBytes。這兩個限值的意義為：</p>

		<ul style="margin-left: 40px; list-style-type: square">
		<li>hard：表示使用者的用量絕對不會超過這個限制值，以上面的設定為例，
		使用者所能使用的磁碟容量絕對不會超過 500Mbytes ，若超過這個值則系統會鎖住該用戶的磁碟使用權；</li>
		<li style="margin-top: 10px;">soft：表示使用者在低於 soft 限值時 (此例中為 400Mbytes)，可以正常使用磁碟，但若超過 soft 
		且低於 hard 的限值 (介於 400~500Mbytes 之間時)，每次使用者登入系統時，系統會主動發出磁碟即將爆滿的警告訊息，
		且會給予一個寬限時間 (grace time)。不過，若使用者在寬限時間倒數期間就將容量再次降低於 soft 限值之下，
		則寬限時間會停止。</li>
		</ul>

		<ul><li>會倒數計時的寬限時間 (grace time)：</li></ul>

		<p>剛剛上面就談到寬限時間了！這個寬限時間只有在使用者的磁碟用量介於 soft 到 hard 之間時，才會出現且會倒數的一個咚咚！
		由於達到 hard 限值時，使用者的磁碟使用權可能會被鎖住。為了擔心使用者沒有注意到這個磁碟配額的問題，
		因此設計了 soft 。當你的磁碟用量即將到達 hard 且超過 soft  時，系統會給予警告，但也會給一段時間讓使用者自行管理磁碟。
		一般預設的寬限時間為七天，如果七天內你都不進行任何磁碟管理，那麼<span class="text_import2"> soft 
		限制值會即刻取代 hard 限值來作為 quota 的限制</span>。</p>

		<p>以上面設定的例子來說，假設你的容量高達 450MBytes 了，那七天的寬限時間就會開始倒數，
		若七天內你都不進行任何刪除檔案的動作來替你的磁碟用量瘦身，
		那麼七天後你的磁碟最大用量將變成 400MBytes (那個 soft 
		的限制值)，此時你的磁碟使用權就會被鎖住而無法新增檔案了。</p>

		</div>

		<p>整個 soft, hard, grace time 的相關性我們可以用底下的圖示來說明：</p>

	<a id="fig14.1.1"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/soft_hard.gif" alt="soft, hard, grace time 的相關性" title="soft, hard, grace time 的相關性" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.1.1、soft, hard, grace time 的相關性</div>

		<p>圖中的長條圖為使用者的磁碟容量，soft/hard 分別是限制值。只要小於 400M 就一切 OK ，
		若高於 soft 就出現 grace time 並倒數且等待使用者自行處理，若到達 hard 的限制值，
		那我們就搬張小板凳等著看好戲啦！嘿嘿！^_^！這樣圖示有清楚一點了嗎？</p>
	<br></div><br>

	<a id="quota_flow"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.2 一個 XFS 檔案系統的 Quota 實作範例</h2>

		<p>坐而言不如起而行啊，所以這裡我們使用一個範例來設計一下如何處理 Quota 的設定流程。</p>

		<ul>
		<li>目的與帳號：現在我想要讓我的專題生五個為一組，這五個人的帳號分別是 myquota1, myquota2, 
		myquota3, myquota4, myquota5，這五個用戶的密碼都是 password ，且這五個用戶所屬的初始群組都是 myquotagrp 。
		其他的帳號屬性則使用預設值。<br><br></li>
		<li>帳號的磁碟容量限制值：我想讓這五個用戶都能夠取得 300MBytes 的磁碟使用量(hard)，檔案數量則不予限制。
		此外，只要容量使用率超過 250MBytes ，就予以警告 (soft)。<br><br></li>

		<li>群組的限額 (option 1)：由於我的系統裡面還有其他用戶存在，因此我僅承認 myquotagrp 這個群組最多僅能使用 1GBytes 的容量。
		這也就是說，如果 myquota1, myquota2, myquota3 都用了 280MBytes 的容量了，那麼其他兩人最多只能使用
		(1000MB - 280x3 = 160MB) 的磁碟容量囉！這就是使用者與群組同時設定時會產生的後果。<br><br></li>

		<li>共享目錄限額 (option 2)：另一種設定方式，每個用戶還是具有自己獨立的容量限止，但是這五個人的專題共用目錄在 /home/myquota 
		這裡，該目錄請設定為其他人沒有任何權限的共享目錄空間，僅有 myquotagrp 群組擁有全部的權限。
		且無論如何，該目錄最多僅能夠接受 500MBytes 的容量。請注意，<span class="text_import2">群組 (group) 的限制與目錄 (directory/project) 無法同時並存喔</span>！
		所以底下的流程中，我們會先以群組來設計，然後再以目錄限制來進一步說明！<br><br></li>

		<li>寬限時間的限制：最後，我希望每個使用者在超過 soft 限制值之後，都還能夠有 14 天的寬限時間。</li>
		</ul>

		<p>好了，那你怎麼規範帳號以及相關的 Quota 設定呢？首先，在這個小節我們先來將帳號相關的屬性、參數及其他環境搞定再說吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 製作帳號環境時，由於有五個帳號，因此鳥哥使用 script 來建立環境！</span>
[root@study ~]# <span class="term_command">vim addaccount.sh</span>
<span class="term_write">#!/bin/bash
# 使用 script 來建立實驗 quota 所需的環境
groupadd myquotagrp
for username in myquota1 myquota2 myquota3 myquota4 myquota5
do
	useradd -g myquotagrp $username
	echo "password" | passwd --stdin $username
done
mkdir /home/myquota
chgrp myquotagrp /home/myquota
chmod 2770 /home/myquota</span>

[root@study ~]# <span class="term_command">sh addaccount.sh</span>
</pre></td></tr></tbody></table>

		<p>接下來，就讓我們來實作 Quota 的練習吧！</p>
	<br></div><br>

	<a id="quota_flow_1"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.3 實作 Quota 流程-1：檔案系統的支援與觀察</h2>

		<p>前面我們就談到，要使用 Quota 必須要核心與檔案系統支援才行！假設你已經使用了預設支援 Quota 的核心，
		那麼接下來就是要啟動檔案系統的支援啦！但是要注意，我們這邊是以 XFS 檔案系統為例的，如果你使用的是 EXT 家族，請找前一版的書籍說明喔！
		此外，<span class="text_import2">不要在根目錄底下進行 quota 設計</span>喔！因為檔案系統會變得太複雜！因此，底下我們是以 /home 這個 xfs 檔案系統為例的！
		當然啦，首先就是要來檢查看看！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">df -hT /home</span>
Filesystem              Type  Size  Used Avail Use% Mounted on
/dev/mapper/centos-home xfs   5.0G   67M  5.0G   2% <span class="term_write">/home </span>
</pre></td></tr></tbody></table>

		<p>從上面的資料來看，鳥哥這部主機的 /home 確實是獨立的 filesystem，而且確實是使用了 xfs 檔案系統！所以可以使用底下的流程囉！
		此外，由於 VFAT 檔案系統並不支援 Linux Quota 功能，所以我們得要使用 mount 查詢一下 /home 的檔案系統為何才行啊！</p>

		<a id="fstab"></a>
		<p>在過去的版本中，管理員似乎可以透過 mount -o remount 的機制來重新掛載啟動 quota 的功能，不過 XFS 檔案系統的 quota 似乎是在掛載之初就宣告了，
		因此無法使用 remount 來重新啟動 quota 功能，一定得要寫入 /etc/fstab 當中，或者是在初始掛載過程中加入這個項目，
		否則不會生效喔！那就來瞧瞧鳥哥改了 fstab 成為怎樣吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">vim /etc/fstab</span>
/dev/mapper/centos-home  /home  xfs  defaults<span class="term_write">,usrquota,grpquota</span>   0 0
<span class="term_say"># 其他項目鳥哥並沒有列出來！重點在於第四欄位！於 default 後面加上兩個參數！</span>

[root@study ~]# <span class="term_command">umount /home</span>
[root@study ~]# <span class="term_command">mount -a</span>
[root@study ~]# <span class="term_command">mount | grep home</span>
/dev/mapper/centos-home on /home type xfs (rw,relatime,seclabel,attr2,inode64,<span class="term_write">usrquota,grpquota</span>)
</pre></td></tr></tbody></table>

		<p>基本上，針對 quota 限制的項目主要有三項，如下所示：</p>

		<ul class="text_import2">
		<li>uquota/usrquota/quota：針對使用者帳號的設定</li>
		<li>gquota/grpquota：針對群組的設定</li>
		<li>pquota/prjquota：針對單一目錄的設定，但是不可與 grpquota 同時存在！</li>
		</ul>

		<p>還是要再次的強調，修改完 /etc/fstab 後，務必要測試一下！若有發生錯誤得要趕緊處理！
		因為這個檔案如果修改錯誤，是會造成無法開機完全的情況啊！切記切記！最好使用 vim 來修改啦！
		因為會有語法的檢驗，就不會讓你寫錯字了！此外，由於一般用戶的家目錄在 /home 裡面，因此針對這個項目的卸載時，
		一定要將所有一般帳號的身份登出，否則肯定無法卸載喔！留意留意！</p>
	<br></div><br>

	<a id="quota_flow_2"></a><a id="xfs_quota"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.4 實作 Quota 流程-2：觀察 Quota 報告資料</h2>

		<p>製作檔案系統支援之後，當然得要來瞧一瞧到底有沒有正確的將 quota 的管理資料列出來才好！這時我們得要使用
		xfs_quota 這個指令才行！這個指令真的是挺復雜的，因為全部的 quota 實作都是這個指令耶！所以裡面的參數有夠多！
		不過稍微觀察一下即可！先讓我們來談談觀察目前 quota 的報告內容吧！</p>

<a id="report"></a>
<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">xfs_quota -x -c "指令" [掛載點]</span>
<span class="term_say">選項與參數：
-x  ：專家模式，後續才能夠加入 -c 的指令參數喔！
-c  ：後面加的就是指令，這個小節我們先來談談數據回報的指令
指令：
      print ：單純的列出目前主機內的檔案系統參數等資料
      df    ：與原本的 df 一樣的功能，可以加上 -b (block) -i (inode) -h (加上單位) 等
      report：列出目前的 quota 項目，有 -ugr (user/group/project) 及 -bi 等資料
      state ：說明目前支援 quota 的檔案系統的資訊，有沒有起動相關項目等</span>

<span class="term_hd">範例一：列出目前系統的各的檔案系統，以及檔案系統的 quota 掛載參數支援</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "print"</span>
Filesystem          Pathname
/                   /dev/mapper/centos-root
/srv/myproject      /dev/vda4
/boot               /dev/vda2
/home               /dev/mapper/centos-home (<span class="term_write">uquota, gquota</span>)  <span class="term_note"># 所以這裡就有顯示支援囉</span>

<span class="term_hd">範例二：列出目前 /home 這個支援 quota 的載點檔案系統使用情況</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "df -h" /home</span>
Filesystem     Size   Used  Avail Use% Pathname
/dev/mapper/centos-home
               5.0G  67.0M   4.9G   1% /home
<span class="term_say"># 如上所示，其實跟原本的 df 差不多啦！只是會更正確就是了。</span>

<span class="term_hd">範例三：列出目前 /home 的所有用戶的 quota 限制值</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "report -ubih" /home</span>
User quota on /home (/dev/mapper/centos-home)
                        <span class="term_write">Blocks                            Inodes</span>
User ID      <span class="term_write">Used   Soft   Hard Warn/Grace</span>     Used   Soft   Hard Warn/Grace
---------- --------------------------------- ---------------------------------
root           4K      0      0  00 [------]      4      0      0  00 [------]
dmtsai      34.0M      0      0  00 [------]    432      0      0  00 [------]
<span class="term_say">.....(中間省略).....</span>
myquota1      12K      0      0  00 [------]      7      0      0  00 [------]
myquota2      12K      0      0  00 [------]      7      0      0  00 [------]
myquota3      12K      0      0  00 [------]      7      0      0  00 [------]
myquota4      12K      0      0  00 [------]      7      0      0  00 [------]
myquota5      12K      0      0  00 [------]      7      0      0  00 [------]
<span class="term_say"># 所以列出了所有用戶的目前的檔案使用情況，並且列出設定值。注意，最上面的 Block
# 代表這個是 block 容量限制，而 inode 則是檔案數量限制喔。另外，soft/hard 若為 0，代表沒限制</span>

<span class="term_hd">範例四：列出目前支援的 quota 檔案系統是否有起動了 quota 功能？</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "state"</span>
User quota state on /home (/dev/mapper/centos-home)
  Accounting: ON    <span class="term_note"># 有啟用計算功能</span>
  Enforcement: ON   <span class="term_note"># 有實際 quota 管制的功能</span>
  Inode: #1568 (4 blocks, 4 extents)  <span class="term_note"># 上面四行說明的是有啟動 user 的限制能力</span>
Group quota state on /home (/dev/mapper/centos-home)
  Accounting: ON
  Enforcement: ON
  Inode: #1569 (5 blocks, 5 extents)  <span class="term_note"># 上面四行說明的是有啟動 group 的限制能力</span>
Project quota state on /home (/dev/mapper/centos-home)
  Accounting: OFF
  Enforcement: OFF
  Inode: #1569 (5 blocks, 5 extents)  <span class="term_note"># 上面四行說明的是 project 並未支援</span>
Blocks grace time: [7 days 00:00:30]  <span class="term_note"># 底下則是 grace time 的項目</span>
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]
</pre></td></tr></tbody></table>

		<p>在預設的情況下， xfs_quota 的 report 指令會將支援的 user/group/prject 相關資料列出來，如果只是想要某個特定的項目，
		例如我們上面要求僅列出用戶的資料時，就在 report 後面加上 -u 即可喔！這樣就能夠觀察目前的相關設定資訊了。
		要注意，限制的項目有 block/inode 同時可以針對每個項目來設定 soft/hard 喔！接下來實際的設定看看吧！</p>
	<br></div><br>

	<a id="quota_flow_3"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.5 實作 Quota 流程-3：限制值設定方式</h2>

		<p>確認檔案系統的 quota 支援順利啟用後，也能夠觀察到相關的 quota 限制，接下來就是要實際的給予用戶/群組限制囉！
		回去瞧瞧，我們需要每個用戶 250M/300M 的容量限制，群組共 950M/1G 的容量限制，同時 grace time 設定為 14 天喔！
		實際的語法與設定流程來瞧瞧：</p>

<a id="limit"></a>
<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">xfs_quota -x -c "limit [-ug] b[soft|hard]=N i[soft|hard]=N name"</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "timer [-ug] [-bir] Ndays"</span>
<span class="term_say">選項與參數：
limit ：實際限制的項目，可以針對 user/group 來限制，限制的項目有
        bsoft/bhard : block 的 soft/hard 限制值，可以加單位
        isoft/ihard : inode 的 soft/hard 限制值
        name        : 就是用戶/群組的名稱啊！
timer ：用來設定 grace time 的項目喔，也是可以針對 user/group 以及 block/inode 設定</span>

<span class="term_hd">範例一：設定好用戶們的 block 限制值 (題目中沒有要限制 inode 啦！)</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota1" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota2" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota3" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota4" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -u bsoft=250M bhard=300M myquota5" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "report -ubih" /home</span>
User quota on /home (/dev/mapper/centos-home)
                        Blocks                            Inodes
User ID      Used   Soft   Hard Warn/Grace     Used   Soft   Hard Warn/Grace
---------- --------------------------------- ---------------------------------
myquota1      12K   <span class="term_write">250M   300M</span>  00 [------]      7      0      0  00 [------]

<span class="term_hd">範例二：設定好 myquotagrp 的 block 限制值</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -g bsoft=950M bhard=1G myquotagrp" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "report -gbih" /home</span>
Group quota on /home (/dev/mapper/centos-home)
                        Blocks                            Inodes
Group ID     Used   Soft   Hard Warn/Grace     Used   Soft   Hard Warn/Grace
---------- --------------------------------- ---------------------------------
myquotagrp    60K   <span class="term_write">950M     1G</span>  00 [------]     36      0      0  00 [------]

<span class="term_hd">範例三：設定一下 grace time 變成 14 天吧！</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "timer -ug -b 14days" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "state" /home</span>
User quota state on /home (/dev/mapper/centos-home)
<span class="term_say">.....(中間省略).....</span>
Blocks grace time: [<span class="term_write">14 days</span> 00:00:30]
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]

<span class="term_hd">範例四：以 myquota1 用戶測試 quota 是否真的實際運作呢？</span>
[root@study ~]# <span class="term_command">su - myquota1</span>
[myquota1@study ~]$ <span class="term_command">dd if=/dev/zero of=123.img bs=1M count=310</span>
dd: error writing ‘123.img’: Disk quota exceeded
300+0 records in
299+0 records out
314552320 bytes (315 MB) copied, 0.181088 s, 1.7 GB/s
[myquota1@study ~]$ <span class="term_command">ll -h</span>
-rw-r--r--. 1 myquota1 myquotagrp <span class="term_write">300M</span> Jul 24 21:38 123.img

[myquota1@study ~]$ <span class="term_command">exit</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "report -ubh" /home</span>
User quota on /home (/dev/mapper/centos-home)
                        Blocks
User ID      Used   Soft   Hard Warn/Grace
---------- ---------------------------------
<span class="term_write">myquota1     300M   250M   300M  00 [13 days]</span>
myquota2      12K   250M   300M  00 [------]
<span class="term_say"># 因為 myquota1 的磁碟用量已經破表，所以當然就會出現那個可怕的 grace time 囉！</span>
</pre></td></tr></tbody></table>

		<p>這樣就直接製做好 quota 囉！看起來也是挺簡單啦！</p>

	<br></div><br>

	<a id="quota_flow_4"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.6 實作 Quota 流程-4：project 的限制 (針對目錄限制) (Optional)</h2>

		<p>現在讓我們來想一想，如果需要限制的是目錄而不是群組時，那該如何處理呢？舉例來說，我們要限制的是 /home/myquota 這個目錄本身，
		而不是針對 myquotagrp 這個群組啊！這兩種設定方法的意義不同喔！例如，前一個小節談到的測試範例來說，
		myquota1 已經消耗了 300M 的容量，而 /home/myquota 其實還沒有任何的使用量 (因為在 myquota1 的家目錄做的 dd 指令)。
		不過如果你使用了 xfs_quota -x -c "report -h" /home 這個指令來查看，就會發現其實 myquotagrp 已經用掉了 300M 了！
		如此一來，對於目錄的限制來說，就不會有效果！</p>

		<p>為了解決這個問題，因此我們這個小節要來設定那個很有趣的 project 項目！只是這個項目不可以跟 group 同時設定喔！
		因此我們得要取消 group 設定並且加入 project 設定才行。那就來實驗看看。</p>

		<div class="illus">
		<ul><li>修改 /etc/fstab 內的檔案系統支援參數</li></ul>

		<p>首先，要將 grpquota 的參數取消，然後加入 prjquota ，並且卸載 /home 再重新掛載才行！那就來測試看看！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先修改 /etc/fstab 的參數，並啟動檔案系統的支援</span>
[root@study ~]# <span class="term_command">vim /etc/fstab</span>
/dev/mapper/centos-home /home xfs  defaults,usrquota,<span class="term_write"><span style="text-decoration: line-through">grpquota,</span>prjquota</span>  0 0
<span class="term_say"># 記得， grpquota 與 prjquota 不可同時設定喔！所以上面刪除 grpquota 加入 prjquota</span>

[root@study ~]# <span class="term_command">umount /home</span>
[root@study ~]# <span class="term_command">mount -a</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "state"</span>
User quota state on /home (/dev/mapper/centos-home)
  Accounting: ON
  Enforcement: ON
  Inode: #1568 (4 blocks, 4 extents)
Group quota state on /home (/dev/mapper/centos-home)
  Accounting: OFF         <span class="term_note">&lt;==已經取消囉！</span>
  Enforcement: OFF
  Inode: N/A
Project quota state on /home (/dev/mapper/centos-home)
  Accounting: ON          <span class="term_note">&lt;==確實啟動囉！</span>
  Enforcement: ON
  Inode: N/A
Blocks grace time: [7 days 00:00:30]
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]
</pre></td></tr></tbody></table>

		<ul><li>規範目錄、專案名稱(project)與專案 ID</li></ul>

		<p>目錄的設定比較奇怪，他必須要指定一個所謂的『專案名稱、專案識別碼』來規範才行！而且還需要用到兩個設定檔！
		這個讓鳥哥覺得比較怪一些就是了。現在，我們要規範的目錄是 /home/myquota 目錄，這個目錄我們給個 myquotaproject 的專案名稱，
		這個專案名稱給個 11 的識別碼，這個都是自己指定的，若不喜歡就自己指定另一個吧！鳥哥的指定方式如下：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 2.1 指定專案識別碼與目錄的對應在 /etc/projects</span>
[root@study ~]# <span class="term_command">echo "11:/home/myquota" &gt;&gt; /etc/projects</span>

<span class="term_hd"># 2.2 規範專案名稱與識別碼的對應在 /etc/projid</span>
[root@study ~]# <span class="term_command">echo "myquotaproject:11" &gt;&gt; /etc/projid</span>

<span class="term_hd"># 2.3 初始化專案名稱</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "project -s myquotaproject"</span>
Setting up project myquotaproject (path /home/myquota)...
Processed 1 (/etc/projects and cmdline) paths for project myquotaproject with recursion 
depth infinite (-1).    <span class="term_note"># 會閃過這些訊息！是 OK 的！別擔心！</span>

[root@study ~]# <span class="term_command">xfs_quota -x -c "print " /home</span>
Filesystem          Pathname
/home               /dev/mapper/centos-home (uquota, pquota)
/home/myquota       /dev/mapper/centos-home (project 11, <span class="term_write">myquotaproject</span>)
<span class="term_say"># 這個 print 功能很不錯！可以完整的查看到相對應的各項檔案系統與 project 目錄對應！</span>

[root@study ~]# <span class="term_command">xfs_quota -x -c "report -pbih " /home</span>
Project quota on /home (/dev/mapper/centos-home)
                        Blocks                            Inodes
Project ID       Used   Soft   Hard Warn/Grace     Used   Soft   Hard Warn/Grace
---------- --------------------------------- ---------------------------------
myquotaproject      0      0      0  00 [------]      1      0      0  00 [------]
<span class="term_say"># 喔耶！確定有抓到這個專案名稱囉！接下來準備設定吧！</span>
</pre></td></tr></tbody></table>

		<ul><li>實際設定規範與測試</li></ul>

		<p>依據本章的說明，我們要將 /home/myquota 指定為 500M 的容量限制，那假設到 450M 為 soft 的限制好了！
		那麼設定就會變成這樣囉：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 3.1 先來設定好這個 project 吧！設定的方式同樣使用 limit 的 bsoft/bhard 喔！：</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "limit -p bsoft=450M bhard=500M myquotaproject" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "report -pbih " /home</span>
Project quota on /home (/dev/mapper/centos-home)
                            Blocks                            Inodes
Project ID       Used   Soft   Hard Warn/Grace     Used   Soft   Hard Warn/Grace
---------- --------------------------------- ---------------------------------
myquotaproject      0   <span class="term_write">450M   500M</span>  00 [------]      1      0      0  00 [------]

[root@study ~]# <span class="term_command">dd if=/dev/zero of=/home/myquota/123.img bs=1M count=510</span>
dd: error writing '/home/myquota/123.img': No space left on device
501+0 records in
500+0 records out
524288000 bytes (524 MB) copied, 0.96296 s, 544 MB/s
<span class="term_say"># 你看！連 root 在該目錄底下建立檔案時，也會被擋掉耶！這才是完整的針對目錄的規範嘛！讚！</span>
</pre></td></tr></tbody></table>

		</div>

		<p>這樣就設定好了囉！未來如果你還想要針對某些個目錄進行限制，那麼就修改 /etc/projects, /etc/projid 設定一下規範，
		然後直接處理目錄的初始化與設定，就完成設定了！好簡單！</p>

		<p>當鳥哥跟同事分享這個 project 的功能時，強者我同事蔡董大大說，剛剛好！他有些朋友要求在 WWW 的服務中，要針對某些目錄進行容量的限制！
		但是因為容量之前僅針對用戶進行限制，如此一來，由於 WWW 服務都是一個名為 httpd 的帳號管理的，因此所有 WWW 服務所產生的檔案資料，
		就全部屬於 httpd 這個帳號，那就無法針對某些特定的目錄進行限制了。<span class="text_import2">有了這個 project 之後，就能夠針對不同的目錄做容量限制！
		而不用管在裡頭建立檔案的檔案擁有者</span>！哇！這真是太棒了！實務應用給各位了解囉！ ^_^</p>

	<br></div><br>

	<a id="quota_manage"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.7 XFS quota 的管理與額外指令對照表</h2>

		<p>不管多完美的系統，總是需要可能的突發狀況應付手段啊！所以，接下來我們就來談談，那麼萬一如果你需要暫停 quota 的限制，
		或者是重新啟動 quota 的限制時，該如何處理呢？還是使用 xfs_quota 啦！增加幾個內部指令即可：</p>

		<ul>
		<li><span class="text_import2">disable</span>：暫時取消 quota 的限制，但其實系統還是在計算 quota 中，只是沒有管制而已！應該算最有用的功能囉！</li>
		<li><span class="text_import2">enable</span>：就是回復到正常管制的狀態中，與 disable 可以互相取消、啟用！</li>
		<li><span class="text_import2">off</span>：完全關閉 quota 的限制，使用了這個狀態後，你只有卸載再重新掛載才能夠再次的啟動 quota 喔！也就是說，
		用了 off 狀態後，你無法使用 enable 再次復原 quota 的管制喔！注意不要亂用這個狀態！一般建議用 disable 即可，除非你需要執行 remove 的動作！</li>
		<li><span class="text_import2">remove</span>：必須要在 off 的狀態下才能夠執行的指令～這個 remove 可以『移除』quota 的限制設定，例如要取消 project 的設定，
		無須重新設定為 0 喔！只要 remove -p 就可以了！</li>
		</ul>

		<p>現在就讓我們來測試一下管理的方式吧：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 暫時關閉 XFS 檔案系統的 quota 限制功能</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "disable -up" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "state" /home</span>
User quota state on /home (/dev/mapper/centos-home)
<span class="term_write">  Accounting: ON
  Enforcement: OFF</span>   <span class="term_note">&lt;== 意思就是有在計算，但沒有強制管制的意思</span>
  Inode: #1568 (4 blocks, 4 extents)
Group quota state on /home (/dev/mapper/centos-home)
  Accounting: OFF
  Enforcement: OFF
  Inode: N/A
Project quota state on /home (/dev/mapper/centos-home)
<span class="term_write">  Accounting: ON
  Enforcement: OFF</span>
  Inode: N/A
Blocks grace time: [7 days 00:00:30]
Inodes grace time: [7 days 00:00:30]
Realtime Blocks grace time: [7 days 00:00:30]

[root@study ~]# <span class="term_command">dd if=/dev/zero of=/home/myquota/123.img bs=1M count=520</span>
520+0 records in
520+0 records out  <span class="term_note"># 見鬼！竟然沒有任何錯誤發生了！</span>
545259520 bytes (545 MB) copied, 0.308407 s, 180 MB/s

[root@study ~]# <span class="term_command">xfs_quota -x -c "report -pbh" /home</span>
Project quota on /home (/dev/mapper/centos-home)
                        Blocks
Project ID       Used   Soft   Hard Warn/Grace
---------- ---------------------------------
myquotaproject   <span class="term_write">520M</span>   450M   500M  00 [-none-]
<span class="term_say"># 其實，還真的有超過耶！只是因為 disable 的關係，所以沒有強制限制住就是了！</span>

[root@study ~]# <span class="term_command">xfs_quota -x -c "enable -up" /home</span>  <span class="term_note"># 重新啟動 quota 限制</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/home/myquota/123.img bs=1M count=520</span>
dd: error writing ‘/home/myquota/123.img’: No space left on device
<span class="term_say"># 又開始有限制！這就是 enable/disable 的相關對應功能喔！暫時關閉/啟動用的！</span>

<span class="term_hd"># 完全關閉 quota 的限制行為吧！同時取消 project 的功能試看看！</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "off -up" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "enable -up" /home</span>
XFS_QUOTAON: Function not implemented
<span class="term_say"># 您瞧瞧！沒有辦法重新啟動！因為已經完全的關閉了 quota 的功能！所以得要 umouont/mount 才行！</span>

[root@study ~]# <span class="term_command">umount /home; mount -a</span>
<span class="term_say"># 這個時候使用 report 以及 state 時，管制限制的內容又重新回來了！好！來瞧瞧如何移除project</span>

[root@study ~]# <span class="term_command">xfs_quota -x -c "off -up" /home</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "remove -p" /home</span>
[root@study ~]# <span class="term_command">umount /home; mount -a</span>
[root@study ~]# <span class="term_command">xfs_quota -x -c "report -phb" /home</span>
Project quota on /home (/dev/mapper/centos-home)
                        Blocks
Project ID       Used   Soft   Hard Warn/Grace
---------- ---------------------------------
myquotaproject   500M      <span class="term_write">0      0</span>  00 [------]
<span class="term_say"># 嘿嘿！全部歸零！就是『移除』所有限制值的意思！</span>
</pre></td></tr></tbody></table>

		<p>請注意上表中最後一個練習，那個 remove -p 是『移除所有的 project 控制列表』的意思！也就是說，如果你有在 /home 設定多個 project 的限制，
		那麼 remove 會刪的一個也不留喔！如果想要回復設定值，那...只能一個一個重新設定回去了！沒有好辦法！</p>

		<p>上面就是 XFS 檔案系統的簡易 quota 處理流程～那如果你是使用 EXT 家族呢？能不能使用 quota 
		呢？除了參考<a href="http://linux.vbird.org/linux_basic/0420quota/0420quota-centos5.php">上一版</a>的文件之外，鳥哥這裡也列出相關的參考指令/設定檔案給你對照參考！
		沒學過的可以看看流程，有學過的可以對照瞭解！ ^_^</p>

<table class="news" style="width: 95%">
<tbody><tr class="theader"><td>設定流程項目</td><td>XFS檔案系統</td><td>EXT家族</td></tr>
<tr class="tcenter"><td>/etc/fstab參數設定</td><td>usrquota/grpquota/prjquota</td><td>usrquota/grpquota</td></tr>
<tr class="tcenter"><td>quota 設定檔</td><td>不需要</td><td>quotacheck</td></tr>
<tr class="tcenter"><td>設定用戶/群組限制值</td><td>xfs_quota -x -c "limit..."</td><td>edquota 或 setquota</td></tr>
<tr class="tcenter"><td>設定 grace time</td><td>xfs_quota -x -c "timer..."</td><td>edquota</td></tr>
<tr class="tcenter"><td>設定目錄限制值</td><td>xfs_quota -x -c "limit..."</td><td>無</td></tr>
<tr class="tcenter"><td>觀察報告</td><td>xfs_quota -x -c "report..."</td><td>repquota 或 quota</td></tr>
<tr class="tcenter"><td>啟動與關閉 quota 限制</td><td>xfs_quota -x -c "[disable|enable]..."</td><td>quotaoff, quotaon</td></tr>
<tr class="tcenter"><td>發送警告信給用戶</td><td>目前版本尚未支援</td><td>warnquota</td></tr>
</tbody></table><br>

	<br></div><br>

	<a id="quota_nochange"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.1.8 不更動既有系統的 quota 實例</h2>

		<p>想一想，如果你的主機原先沒有想到要設定成為郵件主機，所以並沒有規劃將郵件信箱所在的 /var/spool/mail/
		目錄獨立成為一個 partition ，然後目前你的主機已經沒有辦法新增或分割出任何新的分割槽了。那我們知道 quota 的支援與檔案系統有關，
		所以並無法跨檔案系統來設計 quota 的 project 功能啊！因此，你是否就無法針對 mail 的使用量給予 quota 的限制呢？</p>

		<p>此外，如果你想要讓使用者的郵件信箱與家目錄的總體磁碟使用量為固定，那又該如何是好？
		由於 /home 及 /var/spool/mail 根本不可能是同一個 filesystem (除非是都不分割，使用根目錄，才有可能整合在一起)，
		所以，該如何進行這樣的 quota 限制呢？</p>

		<p>其實沒有那麼難啦！既然 quota 是針對 filesystem 來進行限制，假設你又已經有 /home 這個獨立的分割槽了，那麼你只要：</p>
		<ol>
		<li>將 /var/spool/mail 這個目錄完整的移動到 /home 底下；</li>
		<li>利用 ln -s /home/mail /var/spool/mail 來建立連結資料；</li>
		<li>將 /home 進行 quota 限額設定</li>
		</ol>

		<p>只要這樣的一個小步驟，嘿嘿！您家主機的郵件就有一定的限額囉！當然囉！您也可以依據不同的使用者與群組來設定
		quota 然後同樣的以上面的方式來進行 link 的動作！嘿嘿嘿！就有不同的限額針對不同的使用者提出囉！很方便吧！^_^</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		朋友們需要注意的是，由於目前新的 distributions 大多有使用 SELinux 的機制，
		因此你要進行如同上面的目錄搬移時，在許多情況下可能會有使用上的限制喔！或許你得要先暫時關閉 SELinux 才能測試，
		也或許你得要自行修改 SELinux 的規則才行喔！
		</fieldset><br>	</div>
</div>


<a id="raid"></a>
<div class="block1">
<h2>14.2 軟體磁碟陣列 (Software RAID)</h2>

	<p>在過去鳥哥還年輕的時代，我們能使用的硬碟容量都不大，幾十 GB 的容量就是大硬碟了！但是某些情況下，我們需要很大容量的儲存空間，
	例如鳥哥在跑的空氣品質模式所輸出的資料檔案一個案例通常需要好幾 GB ，連續跑個幾個案例，磁碟容量就不夠用了。
	此時我該如何是好？其實可以透過一種儲存機制，稱為磁碟陣列
	(RAID) 的就是了。這種機制的功能是什麼？他有哪些等級？什麼是硬體、軟體磁碟陣列？Linux 支援什麼樣的軟體磁碟陣列？
	底下就讓我們來談談！</p>

	<a id="raid_what"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.2.1 什麼是 RAID</h2>

		<p>磁碟陣列全名是『 Redundant Arrays of Independent Disks, RAID 』，英翻中的意思為：獨立容錯式磁碟陣列，舊稱為容錯式廉價磁碟陣列，
		反正就稱為磁碟陣列即可！RAID 可以透過一個技術(軟體或硬體)，將多個較小的磁碟整合成為一個較大的磁碟裝置；
		而這個較大的磁碟功能可不止是儲存而已，他還具有資料保護的功能呢。整個 RAID 由於選擇的等級 (level)
		不同，而使得整合後的磁碟具有不同的功能，基本常見的 level 有這幾種(<a href="http://linux.vbird.org/linux_basic/0420quota.php#ps2">註2</a>)：</p>

		<a id="raid0"></a>
		<ul class="toplist"><li>RAID-0 (等量模式, stripe)：效能最佳</li></ul>

		<p>這種模式如果使用相同型號與容量的磁碟來組成時，效果較佳。這種模式的 RAID 會將磁碟先切出等量的區塊 (名為chunk，一般可設定 4K~1M 之間)，
		然後當一個檔案要寫入 RAID 時，該檔案會依據 chunk 的大小切割好，之後再依序放到各個磁碟裡面去。由於每個磁碟會交錯的存放資料，
		因此當你的資料要寫入 RAID 時，資料會被等量的放置在各個磁碟上面。舉例來說，你有兩顆磁碟組成 RAID-0 ，
		當你有 100MB 的資料要寫入時，每個磁碟會各被分配到 50MB 的儲存量。RAID-0 的示意圖如下所示：</p>

	<a id="fig14.2.1"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/raid0.gif" alt="RAID-0 的磁碟寫入示意圖" title="RAID-0 的磁碟寫入示意圖" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.2.1、RAID-0 的磁碟寫入示意圖</div>

		<p>上圖的意思是，在組成 RAID-0 時，每顆磁碟 (Disk A 與 Disk B) 都會先被區隔成為小區塊 (chunk)。
		當有資料要寫入 RAID 時，資料會先被切割成符合小區塊的大小，然後再依序一個一個的放置到不同的磁碟去。
		由於資料已經先被切割並且依序放置到不同的磁碟上面，因此每顆磁碟所負責的資料量都降低了！照這樣的情況來看，
		<span class="text_import2">越多顆磁碟組成的 RAID-0 效能會越好，因為每顆負責的資料量就更低了</span>！
		這表示我的資料可以分散讓多顆磁碟來儲存，當然效能會變的更好啊！此外，磁碟總容量也變大了！
		因為每顆磁碟的容量最終會加總成為 RAID-0 的總容量喔！</p>

		<p>只是使用此等級你必須要自行負擔資料損毀的風險，由上圖我們知道檔案是被切割成為適合每顆磁碟分割區塊的大小，
		然後再依序放置到各個磁碟中。想一想，如果某一顆磁碟損毀了，那麼檔案資料將缺一塊，此時這個檔案就損毀了。
		由於每個檔案都是這樣存放的，因此<span class="text_import2"> RAID-0 只要有任何一顆磁碟損毀，在 RAID 
		上面的所有資料都會遺失而無法讀取</span>。</p>

		<p>另外，如果使用不同容量的磁碟來組成 RAID-0 時，由於資料是一直等量的依序放置到不同磁碟中，當小容量磁碟的區塊被用完了，
		那麼所有的資料都將被寫入到最大的那顆磁碟去。舉例來說，我用 200G 與 500G 組成 RAID-0 ，
		那麼最初的 400GB 資料可同時寫入兩顆磁碟 (各消耗 200G 的容量)，後來再加入的資料就只能寫入 500G 的那顆磁碟中了。
		此時的效能就變差了，因為只剩下一顆可以存放資料嘛！</p>

		<a id="raid1"></a>
		<ul class="toplist"><li>RAID-1 (映射模式, mirror)：完整備份</li></ul>

		<p>這種模式也是需要相同的磁碟容量的，最好是一模一樣的磁碟啦！如果是不同容量的磁碟組成 RAID-1 
		時，那麼總容量將以最小的那一顆磁碟為主！這種模式主要是『<span class="text_import2">讓同一份資料，完整的保存在兩顆磁碟上頭</span>』。舉例來說，如果我有一個 100MB 
		的檔案，且我僅有兩顆磁碟組成 RAID-1 時， 那麼這兩顆磁碟將會同步寫入 100MB 到他們的儲存空間去。
		因此，<span class="text_import2">整體 RAID 的容量幾乎少了 50%</span>。由於兩顆硬碟內容一模一樣，好像鏡子映照出來一樣，
		所以我們也稱他為 mirror 模式囉～</p>

	<a id="fig14.2.2"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/raid1.gif" alt="RAID-1 的磁碟寫入示意圖" title="RAID-1 的磁碟寫入示意圖" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.2.2、RAID-1 的磁碟寫入示意圖</div>

		<p>如上圖所示，一份資料傳送到 RAID-1 之後會被分為兩股，並分別寫入到各個磁碟裡頭去。
		由於同一份資料會被分別寫入到其他不同磁碟，因此如果要寫入 100MB 時，資料傳送到 I/O 匯流排後會被複製多份到各個磁碟，
		結果就是資料量感覺變大了！因此在大量寫入 RAID-1 的情況下，寫入的效能可能會變的非常差 (因為我們只有一個南橋啊！)。
		好在如果你使用的是硬體 RAID (磁碟陣列卡) 時，磁碟陣列卡會主動的複製一份而不使用系統的 I/O 匯流排，效能方面則還可以。
		如果使用軟體磁碟陣列，可能效能就不好了。</p>

		<p>由於兩顆磁碟內的資料一模一樣，所以任何一顆硬碟損毀時，你的資料還是可以完整的保留下來的！
		所以我們可以說， <span class="text_import2">RAID-1 最大的優點大概就在於資料的備份吧！不過由於磁碟容量有一半用在備份，
		因此總容量會是全部磁碟容量的一半而已</span>。雖然 RAID-1 
		的寫入效能不佳，不過讀取的效能則還可以啦！這是因為資料有兩份在不同的磁碟上面，如果多個 processes 
		在讀取同一筆資料時， RAID 會自行取得最佳的讀取平衡。</p>

		<a id="raid0_1"></a>
		<ul class="toplist"><li>RAID 1+0，RAID 0+1</li></ul>

		<p>RAID-0 的效能佳但是資料不安全，RAID-1 的資料安全但是效能不佳，那麼能不能將這兩者整合起來設定 RAID 呢？
		可以啊！那就是 RAID 1+0 或 RAID 0+1。所謂的 RAID 1+0 就是： (1)先讓兩顆磁碟組成 RAID 1，並且這樣的設定共有兩組；
		(2)將這兩組 RAID 1 再組成一組 RAID 0。這就是 RAID 1+0 囉！反過來說，RAID 0+1 就是先組成 RAID-0 再組成 RAID-1 的意思。</p>

	<a id="fig14.2.3"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/raid1+0.jpg" alt="RAID-1+0 的磁碟寫入示意圖" title="RAID-1+0 的磁碟寫入示意圖" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.2.3、RAID-1+0 的磁碟寫入示意圖</div>

		<p>如上圖所示，Disk A + Disk B 組成第一組 RAID 1，Disk C + Disk D 組成第二組 RAID 1，
		然後這兩組再整合成為一組 RAID 0。如果我有 100MB 的資料要寫入，則由於 RAID 0 的關係，
		兩組 RAID 1 都會寫入 50MB，又由於 RAID 1 的關係，因此每顆磁碟就會寫入 50MB 而已。
		如此一來不論哪一組 RAID 1 的磁碟損毀，由於是 RAID 1 的映像資料，因此就不會有任何問題發生了！這也是目前儲存設備廠商最推薦的方法！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		為何會推薦 RAID 1+0 呢？想像你有 20 顆磁碟組成的系統，每兩顆組成一個 RAID1，因此你就有總共 10組可以自己復原的系統了！
		然後這 10組再組成一個新的 RAID0，速度立刻拉升 10倍了！同時要注意，因為每組 RAID1 是個別獨立存在的，因此任何一顆磁碟損毀，
		資料都是從另一顆磁碟直接複製過來重建，並不像 RAID5/RAID6 必須要整組 RAID 的磁碟共同重建一顆獨立的磁碟系統！效能上差非常多！
		而且 RAID 1 與 RAID 0 是不需要經過計算的 (striping) ！讀寫效能也比其他的 RAID 等級好太多了！
		</fieldset><br>
		<a id="raid5"></a>
		<ul class="toplist"><li>RAID 5：效能與資料備份的均衡考量</li></ul>

		<p>RAID-5 至少需要三顆以上的磁碟才能夠組成這種類型的磁碟陣列。這種磁碟陣列的資料寫入有點類似 RAID-0 ，
		不過每個循環的寫入過程中 (striping)，在每顆磁碟還加入一個同位檢查資料 (Parity) ，這個資料會記錄其他磁碟的備份資料，
		用於當有磁碟損毀時的救援。RAID-5 讀寫的情況有點像底下這樣：</p>

	<a id="fig14.2.4"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/raid5.gif" alt="RAID-5 的磁碟寫入示意圖" title="RAID-5 的磁碟寫入示意圖" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.2.4、RAID-5 的磁碟寫入示意圖</div>

		<p>如上圖所示，每個循環寫入時，都會有部分的同位檢查碼 (parity) 被記錄起來，並且記錄的同位檢查碼每次都記錄在不同的磁碟，
		因此，任何一個磁碟損毀時都能夠藉由其他磁碟的檢查碼來重建原本磁碟內的資料喔！不過需要注意的是，
		由於有同位檢查碼，因此<span class="text_import2"> RAID 5 的總容量會是整體磁碟數量減一顆。以上圖為例，
		原本的 3 顆磁碟只會剩下 (3-1)=2 顆磁碟的容量。而且當損毀的磁碟數量大於等於兩顆時，這整組 RAID 5 的資料就損毀了。
		因為 RAID 5 預設僅能支援一顆磁碟的損毀情況</span>。</p>

		<p>在讀寫效能的比較上，讀取的效能還不賴！與 RAID-0 有的比！不過寫的效能就不見得能夠增加很多！
		這是因為要寫入 RAID 5 的資料還得要經過計算同位檢查碼 (parity) 的關係。由於加上這個計算的動作，
		所以寫入的效能與系統的硬體關係較大！尤其當使用軟體磁碟陣列時，同位檢查碼是透過 CPU 去計算而非專職的磁碟陣列卡，
		因此效能方面還需要評估。</p>

		<p>另外，由於 RAID 5 僅能支援一顆磁碟的損毀，因此近來還有發展出另外一種等級，就是 RAID 6 ，這個 RAID 6 
		則使用兩顆磁碟的容量作為 parity 的儲存，因此整體的磁碟容量就會少兩顆，但是允許出錯的磁碟數量就可以達到兩顆了！
		也就是在 RAID 6 的情況下，同時兩顆磁碟損毀時，資料還是可以救回來！</p>

		<a id="spare"></a>
		<ul class="toplist"><li>Spare Disk：預備磁碟的功能：</li></ul>

		<p>當磁碟陣列的磁碟損毀時，就得要將壞掉的磁碟拔除，然後換一顆新的磁碟。換成新磁碟並且順利啟動磁碟陣列後，
		磁碟陣列就會開始主動的重建 (rebuild) 原本壞掉的那顆磁碟資料到新的磁碟上！然後你磁碟陣列上面的資料就復原了！
		這就是磁碟陣列的優點。不過，我們還是得要動手拔插硬碟，除非你的系統有支援熱拔插，否則通常得要關機才能這麼做。</p>

		<p>為了讓系統可以即時的在壞掉硬碟時主動的重建，因此就需要預備磁碟 (spare disk) 的輔助。
		所謂的 spare disk 就是一顆或多顆沒有包含在原本磁碟陣列等級中的磁碟，這顆磁碟平時並不會被磁碟陣列所使用，
		當磁碟陣列有任何磁碟損毀時，則這顆 spare disk 會被主動的拉進磁碟陣列中，並將壞掉的那顆硬碟移出磁碟陣列！
		然後立即重建資料系統。如此你的系統則可以永保安康啊！若你的磁碟陣列有支援熱拔插那就更完美了！
		直接將壞掉的那顆磁碟拔除換一顆新的，再將那顆新的設定成為 spare disk ，就完成了！</p>

		<p>舉例來說，鳥哥之前所待的研究室有一個磁碟陣列可允許 16 顆磁碟的數量，不過我們只安裝了 10 顆磁碟作為 RAID 5。
		每顆磁碟的容量為 250GB，我們用了一顆磁碟作為 spare disk ，並將其他的 9 顆設定為一個 RAID 5，
		因此這個磁碟陣列的總容量為： (9-1)*250G=2000G。運作了一兩年後真的有一顆磁碟壞掉了，我們後來看燈號才發現！
		不過對系統沒有影響呢！因為 spare disk 主動的加入支援，壞掉的那顆拔掉換顆新的，並重新設定成為 spare 後，
		系統內的資料還是完整無缺的！嘿嘿！真不錯！</p>

		<ul class="toplist"><li>磁碟陣列的優點</li></ul>

		<p>說的口沫橫飛，重點在哪裡呢？其實你的系統如果需要磁碟陣列的話，其實重點在於：</p>

		<ol class="text_import2">
		<li>資料安全與可靠性：指的並非網路資訊安全，而是當硬體 (指磁碟) 損毀時，資料是否還能夠安全的救援或使用之意；</li>
		<li>讀寫效能：例如 RAID 0 可以加強讀寫效能，讓你的系統 I/O 部分得以改善；</li>
		<li>容量：可以讓多顆磁碟組合起來，故單一檔案系統可以有相當大的容量。</li>
		</ol>

		<p>尤其資料的可靠性與完整性更是使用 RAID 的考量重點！畢竟硬體壞掉換掉就好了，軟體資料損毀那可不是鬧著玩的！
		所以企業界為何需要大量的 RAID 來做為檔案系統的硬體基準，現在您有點瞭解了吧？那依據這三個重點，我們來列表看看上面幾個重要的 RAID 
		等級各有哪些優點吧！假設有 n 顆磁碟組成的 RAID 設定喔！</p>

<table class="news" style="width: 95%">
<tbody><tr class="theader"><td style="width: 20%">項目</td><td style="width: 16%">RAID0</td><td style="width: 16%">RAID1</td><td style="width: 16%">RAID10</td><td style="width: 16%">RAID5</td><td style="width: 16%">RAID6</td></tr>
<tr class="tcenter"><td>最少磁碟數</td><td>2</td><td>2</td><td>4</td><td>3</td><td>4</td></tr>
<tr class="tcenter"><td>最大容錯磁碟數(1)</td><td>無</td><td>n-1</td><td>n/2</td><td>1</td><td>2</td></tr>
<tr class="tcenter"><td>資料安全性(1)</td><td>完全沒有</td><td>最佳</td><td>最佳</td><td>好</td><td>比 RAID5 好</td></tr>
<tr class="tcenter"><td>理論寫入效能(2)</td><td>n</td><td>1</td><td>n/2</td><td>&lt;n-1</td><td>&lt;n-2</td></tr>
<tr class="tcenter"><td>理論讀出效能(2)</td><td>n</td><td>n</td><td>n</td><td>&lt;n-1</td><td>&lt;n-2</td></tr>
<tr class="tcenter"><td>可用容量(3)</td><td>n</td><td>1</td><td>n/2</td><td>n-1</td><td>n-2</td></tr>
<tr class="tcenter"><td>一般應用</td><td>強調效能但資料不重要的環境</td><td>資料與備份</td><td>伺服器、雲系統常用</td><td>資料與備份</td><td>資料與備份</td></tr>


</tbody></table>
		<p>註：因為 RAID5, RAID6 讀寫都需要經過 parity 的計算機制，因此讀/寫效能都不會剛好滿足於使用的磁碟數量喔！</p>

		<p>另外，根據使用的情況不同，一般推薦的磁碟陣列等級也不太一樣。以鳥哥為例，在鳥哥的跑空氣品質模式之後的輸出資料，動輒幾百 GB 的單一大檔案資料，
		這些情況鳥哥會選擇放在 RAID6 的陣列環境下，這是考量到資料保全與總容量的應用，因為 RAID 6 的效能已經足以應付模式讀入所需的環境。</p>

		<p>近年來鳥哥也比較積極在作一些雲程式環境的設計，在雲環境下，確保每個虛擬機器能夠快速的反應以及提供資料保全是最重要的部份！
		因此效能方面比較弱的 RAID5/RAID6 是不考慮的，總結來說，大概就剩下 RAID10 能夠滿足雲環境的效能需求了。在某些更特別的環境下，
		如果搭配 SSD 那才更具有效能上的優勢哩！</p>

	<br></div><br>

	<a id="raid_so_ha"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.2.2 software, hardware RAID</h2>

		<p>為何磁碟陣列又分為硬體與軟體呢？所謂的硬體磁碟陣列 (hardware RAID) 是透過磁碟陣列卡來達成陣列的目的。
		磁碟陣列卡上面有一塊專門的晶片在處理 RAID 的任務，因此在效能方面會比較好。在很多任務 (例如 RAID 5 的同位檢查碼計算)
		磁碟陣列並不會重複消耗原本系統的 I/O 匯流排，理論上效能會較佳。此外目前一般的中高階磁碟陣列卡都支援熱拔插，
		亦即在不關機的情況下抽換損壞的磁碟，對於系統的復原與資料的可靠性方面非常的好用。</p>

		<p>不過一塊好的磁碟陣列卡動不動就上萬元台幣，便宜的在主機板上面『附贈』的磁碟陣列功能可能又不支援某些高階功能，
		例如低階主機板若有磁碟陣列晶片，通常僅支援到 RAID0 與 RAID1 ，鳥哥喜歡的 RAID6 並沒有支援。
		此外，作業系統也必須要擁有磁碟陣列卡的驅動程式，才能夠正確的捉到磁碟陣列所產生的磁碟機！</p>

		<p>由於磁碟陣列有很多優秀的功能，然而硬體磁碟陣列卡偏偏又貴的很～因此就有發展出利用軟體來模擬磁碟陣列的功能，
		這就是所謂的軟體磁碟陣列 (software RAID)。軟體磁碟陣列主要是透過軟體來模擬陣列的任務，
		因此會損耗較多的系統資源，比如說 CPU 的運算與 I/O 匯流排的資源等。不過目前我們的個人電腦實在已經非常快速了，
		因此以前的速度限制現在已經不存在！所以我們可以來玩一玩軟體磁碟陣列！</p>

		<p>我們的 CentOS 提供的軟體磁碟陣列為 mdadm 這套軟體，這套軟體會<span class="text_import2">以 partition
		或 disk 為磁碟的單位</span>，也就是說，你不需要兩顆以上的磁碟，只要有兩個以上的分割槽 (partition)
		就能夠設計你的磁碟陣列了。此外， mdadm 支援剛剛我們前面提到的 RAID0/RAID1/RAID5/spare disk 等！
		而且提供的管理機制還可以達到類似熱拔插的功能，可以線上 (檔案系統正常使用) 進行分割槽的抽換！
		使用上也非常的方便呢！</p>

		<p>另外你必須要知道的是，硬體磁碟陣列在 Linux 底下看起來就是一顆實際的大磁碟，因此硬體磁碟陣列的裝置檔名為
		/dev/sd[a-p] ，因為使用到 SCSI 的模組之故。至於<span class="text_import2">軟體磁碟陣列則是系統模擬的，因此使用的裝置檔名是系統的裝置檔，
		檔名為 /dev/md0, /dev/md1...</span>，兩者的裝置檔名並不相同！不要搞混了喔！因為很多朋友常常覺得奇怪，
		怎麼他的 RAID 檔名跟我們這裡測試的軟體 RAID 檔名不同，所以這裡特別強調說明喔！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		Intel 的南橋附贈的磁碟陣列功能，在 windows 底下似乎是完整的磁碟陣列，但是在 Linux 底下則被視為是軟體磁碟陣列的一種！
		因此如果你有設定過 Intel 的南橋晶片磁碟陣列，那在 Linux 底下反而還會是 /dev/md126, /dev/md127 等等裝置檔名，
		而他的分割槽竟然是 /dev/md126p1, /dev/md126p2... 之類的喔！比較特別，所以這裡加強說明！
		</fieldset><br>	</div><br>

	<a id="raid_setup"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.2.3 軟體磁碟陣列的設定</h2>

		<p>軟體磁碟陣列的設定很簡單呢！簡單到讓你很想笑喔！因為你只要使用一個指令即可！那就是 mdadm 這個指令。
		這個指令在建立 RAID 的語法有點像這樣：</p>

<a id="mdadm_create"></a>
<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mdadm --detail /dev/md0</span>
[root@study ~]# <span class="term_command">mdadm --create /dev/md[0-9] --auto=yes --level=[015] --chunk=NK \</span>
&gt; <span class="term_command">--raid-devices=N --spare-devices=N /dev/sdx /dev/hdx...</span>
<span class="term_say">選項與參數：
--create          ：為建立 RAID 的選項；
--auto=yes        ：決定建立後面接的軟體磁碟陣列裝置，亦即 /dev/md0, /dev/md1...
--chunk=Nk        ：決定這個裝置的 chunk 大小，也可以當成 stripe 大小，一般是 64K 或 512K。
--raid-devices=N  ：使用幾個磁碟 (partition) 作為磁碟陣列的裝置
--spare-devices=N ：使用幾個磁碟作為備用 (spare) 裝置
--level=[015]     ：設定這組磁碟陣列的等級。支援很多，不過建議只要用 0, 1, 5 即可
--detail          ：後面所接的那個磁碟陣列裝置的詳細資訊</span>
</pre></td></tr></tbody></table>

		<p>上面的語法中，最後面會接許多的裝置檔名，這些裝置檔名可以是整顆磁碟，例如 /dev/sdb ，
		也可以是分割槽，例如 /dev/sdb1 之類。不過，這些裝置檔名的總數必須要等於 --raid-devices 
		與 --spare-devices 的個數總和才行！鳥哥利用我的測試機來建置一個 RAID 5 的軟體磁碟陣列給您瞧瞧！
		底下是鳥哥希望做成的 RAID 5 環境：</p>

		<ul>
		<li>利用 4 個 partition 組成 RAID 5；</li>
		<li>每個 partition 約為 1GB 大小，需確定每個 partition 一樣大較佳；</li>
		<li>利用 1 個 partition 設定為 spare disk</li>
		<li>chunk 設定為 256K 這麼大即可！</li>
		<li>這個 spare disk 的大小與其他 RAID 所需 partition 一樣大！</li>
		<li>將此 RAID 5 裝置掛載到 /srv/raid 目錄下</li>
		</ul>

		<p>最終我需要 5 個 1GB 的 partition。在鳥哥的測試機中，根據前面的章節實做下來，包括課後的情境模擬題目，目前應該還有 8GB 可供利用！
		因此就利用這部測試機的 /dev/vda 切出 5 個 1G 的分割槽。實際的流程鳥哥就不一一展示了，自己透過 gdisk /dev/vda 實作一下！
		最終這部測試機的結果應該如下所示：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">gdisk -l /dev/vda</span>
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048            6143   2.0 MiB     EF02
   2            6144         2103295   1024.0 MiB  0700
   3         2103296        65026047   30.0 GiB    8E00
   4        65026048        67123199   1024.0 MiB  8300  Linux filesystem
<span class="term_write">   5        67123200        69220351   1024.0 MiB  FD00  Linux RAID
   6        69220352        71317503   1024.0 MiB  FD00  Linux RAID
   7        71317504        73414655   1024.0 MiB  FD00  Linux RAID
   8        73414656        75511807   1024.0 MiB  FD00  Linux RAID
   9        75511808        77608959   1024.0 MiB  FD00  Linux RAID</span>
<span class="term_say"># 上面特殊字體的部份就是我們需要的那 5 個 partition 囉！注意注意！</span>

[root@study ~]# <span class="term_command">lsblk</span>
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
vda             252:0    0   40G  0 disk
|-vda1          252:1    0    2M  0 part
|-vda2          252:2    0    1G  0 part /boot
|-vda3          252:3    0   30G  0 part
| |-centos-root 253:0    0   10G  0 lvm  /
| |-centos-swap 253:1    0    1G  0 lvm  [SWAP]
| `-centos-home 253:2    0    5G  0 lvm  /home
|-vda4          252:4    0    1G  0 part /srv/myproject
<span class="term_write">|-vda5          252:5    0    1G  0 part
|-vda6          252:6    0    1G  0 part
|-vda7          252:7    0    1G  0 part
|-vda8          252:8    0    1G  0 part
`-vda9          252:9    0    1G  0 part</span>
</pre></td></tr></tbody></table>

		<ul class="toplist"><li>以 mdadm 建置 RAID</li></ul>

		<p>接下來就簡單啦！透過 mdadm 來建立磁碟陣列先！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mdadm --create /dev/md0 --auto=yes --level=5 --chunk=256K \</span>
&gt; <span class="term_command"> --raid-devices=4 --spare-devices=1 /dev/vda{5,6,7,8,9}</span>
mdadm: /dev/vda5 appears to contain an ext2fs file system
       size=1048576K  mtime=Thu Jun 25 00:35:01 2015   <span class="term_note"># 某些時刻會出現這個東西！沒關係的！</span>
Continue creating array? <span class="term_command">y</span>
mdadm: Defaulting to version 1.2 metadata
mdadm: array /dev/md0 started.
<span class="term_say"># 詳細的參數說明請回去前面看看囉！這裡我透過 {} 將重複的項目簡化！
# 此外，因為鳥哥這個系統經常在建置測試的環境，因此系統可能會抓到之前的 filesystem 
# 所以就會出現如上前兩行的訊息！那沒關係的！直接按下 y 即可刪除舊系統</span>

[root@study ~]# <span class="term_command">mdadm --detail /dev/md0</span>
/dev/md0:                                           <span class="term_note"># RAID 的裝置檔名</span>
        Version : 1.2
  Creation Time : Mon Jul 27 15:17:20 2015          <span class="term_note"># 建置 RAID 的時間</span>
     Raid Level : raid5                             <span class="term_note"># 這就是 RAID5 等級！</span>
     Array Size : 3142656 (3.00 GiB 3.22 GB)        <span class="term_note"># 整組 RAID 的可用容量</span>
  Used Dev Size : 1047552 (1023.17 MiB 1072.69 MB)  <span class="term_note"># 每顆磁碟(裝置)的容量</span>
   Raid Devices : 4                                 <span class="term_note"># 組成 RAID 的磁碟數量</span>
  Total Devices : 5                                 <span class="term_note"># 包括 spare 的總磁碟數</span>
    Persistence : Superblock is persistent

    Update Time : Mon Jul 27 15:17:31 2015
          <span class="term_write">State : clean</span>                             <span class="term_note"># 目前這個磁碟陣列的使用狀態</span>
 Active Devices : 4                                 <span class="term_note"># 啟動(active)的裝置數量</span>
Working Devices : 5                                 <span class="term_note"># 目前使用於此陣列的裝置數</span>
 Failed Devices : 0                                 <span class="term_note"># 損壞的裝置數</span>
  Spare Devices : 1                                 <span class="term_note"># 預備磁碟的數量</span>

         Layout : left-symmetric
     Chunk Size : 256K                              <span class="term_note"># 就是 chunk 的小區塊容量</span>

           Name : study.centos.vbird:0  (local to host study.centos.vbird)
           UUID : 2256da5f:4870775e:cf2fe320:4dfabbc6
         Events : 18

    Number   Major   Minor   <span class="term_write">RaidDevice State</span>
       0     252        5        0      active sync   /dev/vda5
       1     252        6        1      active sync   /dev/vda6
       2     252        7        2      active sync   /dev/vda7
       5     252        8        3      active sync   /dev/vda8

       4     252        9        -      spare   /dev/vda9
<span class="term_say"># 最後五行就是這五個裝置目前的情況，包括四個 active sync 一個 spare ！
# 至於 RaidDevice  指的則是此 RAID 內的磁碟順序</span>
</pre></td></tr></tbody></table>

		<p>由於磁碟陣列的建置需要一些時間，所以你最好等待數分鐘後再使用『 mdadm --detail /dev/md0 』去查閱你的磁碟陣列詳細資訊！
		否則有可能看到某些磁碟正在『spare rebuilding』之類的建置字樣！透過上面的指令，
		你就能夠建立一個 RAID5 且含有一顆 spare disk 的磁碟陣列囉！非常簡單吧！
		除了指令之外，你也可以查閱如下的檔案來看看系統軟體磁碟陣列的情況：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">cat /proc/mdstat</span>
Personalities : [raid6] [raid5] [raid4]
md0 : active raid5 vda8[5] vda9[4](S) vda7[2] vda6[1] vda5[0]                <span class="term_note">&lt;==第一行</span>
      3142656 blocks super 1.2 level 5, 256k chunk, algorithm 2 [4/4] [UUUU] <span class="term_note">&lt;==第二行</span>

unused devices: &lt;none&gt;
</pre></td></tr></tbody></table>

		<p>上述的資料比較重要的在特別指出的第一行與第二行部分(<a href="http://linux.vbird.org/linux_basic/0420quota.php#ps3">註3</a>)：</p>
		<ul>
		<li>第一行部分：指出 md0 為 raid5 ，且使用了 vda8, vda7, vda6, vda5 等四顆磁碟裝置。每個裝置後面的中括號 []
			內的數字為此磁碟在 RAID 中的順序 (RaidDevice)；至於 vda9 後面的 [S] 則代表 vda9 為 spare 之意。<br><br></li>
		<li>第二行：此磁碟陣列擁有 3142656 個block(每個 block 單位為 1K)，所以總容量約為 3GB，
			使用 RAID 5 等級，寫入磁碟的小區塊 (chunk) 大小為 256K，使用 algorithm 2 磁碟陣列演算法。 [m/n]
			代表此陣列需要 m 個裝置，且 n 個裝置正常運作。因此本 md0 需要 4 個裝置且這 4 個裝置均正常運作。
			後面的 [UUUU] 代表的是四個所需的裝置 (就是 [m/n] 裡面的 m) 的啟動情況，U 代表正常運作，若為 _ 則代表不正常。</li>
		</ul>

		<p>這兩種方法都可以知道目前的磁碟陣列狀態啦！</p>

		<ul class="toplist"><li>格式化與掛載使用 RAID</li></ul>

		<p>接下來就是開始使用格式化工具啦！這部分就需要注意喔！因為涉及到 xfs 檔案系統的優化！還記得第七章的內容吧？我們這裡的參數為：</p>
		<ul>
		<li>srtipe (chunk) 容量為 256K，所以 su=256k</li>
		<li>共有 4 顆組成 RAID5 ，因此容量少一顆，所以 sw=3 喔！</li>
		<li>由上面兩項計算出資料寬度為： 256K*3=768k</li>
		</ul>

		<p>所以整體來說，要優化這個 XFS 檔案系統就變成這樣：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mkfs.xfs -f -d su=256k,sw=3 -r extsize=768k /dev/md0</span>
<span class="term_say"># 有趣吧！是 /dev/md0 做為裝置被格式化呢！</span>

[root@study ~]# <span class="term_command">mkdir /srv/raid</span>
[root@study ~]# <span class="term_command">mount /dev/md0 /srv/raid</span>
[root@study ~]# <span class="term_command">df -Th /srv/raid</span>
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/md0       xfs   3.0G   33M  3.0G   2% /srv/raid
<span class="term_say"># 看吧！多了一個 /dev/md0 的裝置，而且真的可以讓你使用呢！還不賴！</span>
</pre></td></tr></tbody></table>
	<br></div><br>

	<a id="raid_rescue"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.2.4 模擬 RAID 錯誤的救援模式</h2>

		<p>俗話說『天有不測風雲、人有旦夕禍福』，誰也不知道你的磁碟陣列內的裝置啥時會出差錯，因此，
		瞭解一下軟體磁碟陣列的救援還是必須的！底下我們就來玩一玩救援的機制吧！首先來瞭解一下 mdadm 
		這方面的語法：</p>

<a id="mdadm_manage"></a>
<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mdadm --manage /dev/md[0-9] [--add 裝置] [--remove 裝置] [--fail 裝置] </span>
<span class="term_say">選項與參數：
--add    ：會將後面的裝置加入到這個 md 中！
--remove ：會將後面的裝置由這個 md 中移除
--fail   ：會將後面的裝置設定成為出錯的狀態</span>
</pre></td></tr></tbody></table>

		<ul class="toplist"><li>設定磁碟為錯誤 (fault)</li></ul>

		<p>首先，我們來處理一下，該如何讓一個磁碟變成錯誤，然後讓 spare disk 自動的開始重建系統呢？</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 0. 先複製一些東西到 /srv/raid 去，假設這個 RAID 已經在使用了</span>
[root@study ~]# <span class="term_command">cp -a /etc /var/log /srv/raid</span>
[root@study ~]# <span class="term_command">df -Th /srv/raid ; du -sm /srv/raid/*</span>
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/md0       xfs   3.0G  144M  2.9G   5% /srv/raid
28      /srv/raid/etc  <span class="term_note">&lt;==看吧！確實有資料在裡面喔！</span>
51      /srv/raid/log

<span class="term_hd"># 1. 假設 /dev/vda7 這個裝置出錯了！實際模擬的方式：</span>
[root@study ~]# <span class="term_command">mdadm --manage /dev/md0 --fail /dev/vda7</span>
mdadm: set /dev/vda7 faulty in /dev/md0      <span class="term_note"># 設定成為錯誤的裝置囉！</span>
/dev/md0:
<span class="term_say">.....(中間省略).....</span>
    Update Time : Mon Jul 27 15:32:50 2015
          State : clean, <span class="term_write">degraded, recovering</span>
 Active Devices : 3
Working Devices : 4
 Failed Devices : 1      <span class="term_note">&lt;==出錯的磁碟有一個！</span>
  Spare Devices : 1
<span class="term_say">.....(中間省略).....</span>

    Number   Major   Minor   RaidDevice State
       0     252        5        0      active sync   /dev/vda5
       1     252        6        1      active sync   /dev/vda6
       4     252        9        2      <span class="term_write">spare rebuilding   /dev/vda9</span>
       5     252        8        3      active sync   /dev/vda8

       2     252        7        -      <span class="term_write">faulty   /dev/vda7</span>
<span class="term_say"># 看到沒！這的動作要快做才會看到！ /dev/vda9 啟動了而 /dev/vda7 死掉了</span>
</pre></td></tr></tbody></table>

		<p>上面的畫面你得要快速的連續輸入那些 mdadm 的指令才看的到！因為你的 RAID 5 正在重建系統！
		若你等待一段時間再輸入後面的觀察指令，則會看到如下的畫面了：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 2. 已經藉由 spare disk 重建完畢的 RAID 5 情況</span>
[root@study ~]# <span class="term_command">mdadm --detail /dev/md0</span>
<span class="term_say">....(前面省略)....</span>
    Number   Major   Minor   RaidDevice State
       0     252        5        0      active sync   /dev/vda5
       1     252        6        1      active sync   /dev/vda6
       4     252        9        2      active sync   /dev/vda9
       5     252        8        3      active sync   /dev/vda8

       2     252        7        -      faulty   /dev/vda7
</pre></td></tr></tbody></table>

		<p>看吧！又恢復正常了！真好！我們的 /srv/raid 檔案系統是完整的！並不需要卸載！很棒吧！</p>

		<ul class="toplist"><li>將出錯的磁碟移除並加入新磁碟</li></ul>

		<p>因為我們的系統那個 /dev/vda7 實際上沒有壞掉啊！只是用來模擬而已啊！因此，如果有新的磁碟要替換，其實替換的名稱會一樣啊！
		也就是我們需要：</p>

		<ol>
		<li>先從 /dev/md0 陣列中移除 /dev/vda7 這顆『磁碟』</li>
		<li>整個 Linux 系統關機，拔出 /dev/vda7 這顆『磁碟』，並安裝上新的 /dev/vda7 『磁碟』，之後開機</li>
		<li>將新的 /dev/vda7 放入 /dev/md0 陣列當中！</li>
		</ol>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 3. 拔除『舊的』/dev/vda7 磁碟</span>
[root@study ~]# <span class="term_command">mdadm --manage /dev/md0 --remove /dev/vda7</span>
<span class="term_say"># 假設接下來你就進行了上面談到的第 2, 3 個步驟，然後重新開機成功了！</span>

<span class="term_hd"># 4. 安裝『新的』/dev/vda7 磁碟</span>
[root@study ~]# <span class="term_command">mdadm --manage /dev/md0 --add /dev/vda7</span>
[root@study ~]# <span class="term_command">mdadm --detail /dev/md0</span>
<span class="term_say">....(前面省略)....</span>
    Number   Major   Minor   RaidDevice State
       0     252        5        0      active sync   /dev/vda5
       1     252        6        1      active sync   /dev/vda6
       4     252        9        2      active sync   /dev/vda9
       5     252        8        3      active sync   /dev/vda8

       6     252        7        -      spare   /dev/vda7
</pre></td></tr></tbody></table>

		<p>嘿嘿！你的磁碟陣列內的資料不但一直存在，而且你可以一直順利的運作 /srv/raid 內的資料，即使 /dev/vda7
		損毀了！然後透過管理的功能就能夠加入新磁碟且拔除壞掉的磁碟！注意，這一切都是在上線 (on-line) 的情況下進行！
		所以，您說這樣的咚咚好不好用啊！ ^_^</p>
	<br></div><br>

	<a id="raid_auto"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.2.5 開機自動啟動 RAID 並自動掛載</h2>

		<p>新的 distribution 大多會自己搜尋 /dev/md[0-9] 然後在開機的時候給予設定好所需要的功能。不過鳥哥還是建議你，
		修改一下設定檔吧！ ^_^。software RAID 也是有設定檔的，這個設定檔在 /etc/mdadm.conf ！這個設定檔內容很簡單，
		你只要知道 /dev/md0 的 UUID 就能夠設定這個檔案啦！這裡鳥哥僅介紹他最簡單的語法：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mdadm --detail /dev/md0 | grep -i uuid</span>
           UUID : 2256da5f:4870775e:cf2fe320:4dfabbc6
<span class="term_say"># 後面那一串資料，就是這個裝置向系統註冊的 UUID 識別碼！</span>

<span class="term_hd"># 開始設定 mdadm.conf</span>
[root@study ~]# <span class="term_command">vim /etc/mdadm.conf</span>
<span class="term_write">ARRAY /dev/md0 UUID=2256da5f:4870775e:cf2fe320:4dfabbc6</span>
<span class="term_say">#     RAID裝置      識別碼內容</span>

<span class="term_hd"># 開始設定開機自動掛載並測試</span>
[root@study ~]# <span class="term_command">blkid /dev/md0</span>
/dev/md0: UUID="494cb3e1-5659-4efc-873d-d0758baec523" TYPE="xfs"

[root@study ~]# <span class="term_command">vim /etc/fstab</span>
<span class="term_write">UUID=494cb3e1-5659-4efc-873d-d0758baec523  /srv/raid xfs defaults 0 0</span>

[root@study ~]# <span class="term_command">umount /dev/md0; mount -a</span>
[root@study ~]# <span class="term_command">df -Th /srv/raid</span>
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/md0       xfs   3.0G  111M  2.9G   4% /srv/raid
<span class="term_say"># 你得確定可以順利掛載，並且沒有發生任何錯誤！</span>
</pre></td></tr></tbody></table>

		<p>如果到這裡都沒有出現任何問題！接下來就請 reboot 你的系統並等待看看能否順利的啟動吧！ ^_^</p>
	<br></div><br>

	<a id="raid_stop"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.2.6 關閉軟體 RAID(重要！)</h2>

		<p>除非你未來就是要使用這顆 software RAID (/dev/md0)，否則你勢必要跟鳥哥一樣，將這個 /dev/md0 關閉！
		因為他畢竟是我們在這個測試機上面的練習裝置啊！為什麼要關掉他呢？因為這個 /dev/md0 其實還是使用到我們系統的磁碟分割槽，
		在鳥哥的例子裡面就是 /dev/vda{5,6,7,8,9}，如果你只是將 /dev/md0 卸載，然後忘記將 RAID 關閉，
		結果就是....未來你在重新分割 /dev/vdaX 時可能會出現一些莫名的錯誤狀況啦！所以才需要關閉 software RAID 的步驟！
		那如何關閉呢？也是簡單到爆炸！(請注意，確認你的 /dev/md0 確實不要用且要關閉了才進行底下的玩意兒)</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先卸載且刪除設定檔內與這個 /dev/md0 有關的設定：</span>
[root@study ~]# <span class="term_command">umount /srv/raid</span>
[root@study ~]# <span class="term_command">vim /etc/fstab</span>
<span style="text-decoration: line-through">UUID=494cb3e1-5659-4efc-873d-d0758baec523  /srv/raid xfs defaults 0 0</span>
<span class="term_say"># 將這一行刪除掉！或者是註解掉也可以！</span>

<span class="term_hd"># 2. 先覆蓋掉 RAID 的 metadata 以及 XFS 的 superblock，才關閉 /dev/md0 的方法</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/dev/md0 bs=1M count=50</span>
[root@study ~]# <span class="term_command">mdadm --stop /dev/md0</span>
mdadm: stopped /dev/md0  <span class="term_note">&lt;==不囉唆！這樣就關閉了！</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/dev/vda5 bs=1M count=10</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/dev/vda6 bs=1M count=10</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/dev/vda7 bs=1M count=10</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/dev/vda8 bs=1M count=10</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/dev/vda9 bs=1M count=10</span>

[root@study ~]# <span class="term_command">cat /proc/mdstat</span>
Personalities : [raid6] [raid5] [raid4]
unused devices: &lt;none&gt;  <span class="term_note">&lt;==看吧！確實不存在任何陣列裝置！</span>

[root@study ~]# <span class="term_command">vim /etc/mdadm.conf</span>
<span style="text-decoration: line-through">#ARRAY /dev/md0 UUID=2256da5f:4870775e:cf2fe320:4dfabbc6</span>
<span class="term_say"># 一樣啦！刪除他或是註解他！</span>
</pre></td></tr></tbody></table>

		<p>你可能會問，鳥哥啊，為啥上面會有數個 dd 的指令啊？幹麻？這是因為 RAID 的相關資料其實也會存一份在磁碟當中，因此，如果你只是將設定檔移除，
		同時關閉了 RAID，但是分割槽並沒有重新規劃過，那麼重新開機過後，系統還是會將這顆磁碟陣列建立起來，只是名稱可能會變成 /dev/md127 就是了！
		因此，移除掉 Software RAID 時，上述的 dd 指令不要忘記！但是...千千萬萬不要 dd 到錯誤的磁碟～那可是會欲哭無淚耶～</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		在這個練習中，鳥哥使用同一顆磁碟進行軟體 RAID 的實驗。不過朋友們要注意的是，如果真的要實作軟體磁碟陣列，
		最好是由多顆不同的磁碟來組成較佳！因為這樣才能夠使用到不同磁碟的讀寫，效能才會好！
		而資料分配在不同的磁碟，當某顆磁碟損毀時資料才能夠藉由其他磁碟挽救回來！這點得特別留意呢！
		</fieldset><br>	</div>
</div>


<a id="lvm"></a>
<div class="block1">
<h2>14.3 邏輯捲軸管理員 (Logical Volume Manager)</h2>

	<p>想像一個情況，你在當初規劃主機的時候將 /home 只給他 50G ，等到使用者眾多之後導致這個 filesystem 不夠大，
	此時你能怎麼作？多數的朋友都是這樣：再加一顆新硬碟，然後重新分割、格式化，將 /home 的資料完整的複製過來，
	然後將原本的 partition 卸載重新掛載新的 partition 。啊！好忙碌啊！若是第二次分割卻給的容量太多！導致很多磁碟容量被浪費了！
	你想要將這個 partition 縮小時，又該如何作？將上述的流程再搞一遍！唉～煩死了，尤其複製很花時間ㄟ～有沒有更簡單的方法呢？
	有的！那就是我們這個小節要介紹的 LVM 這玩意兒！</p>

	<p>LVM 的重點在於『<span class="text_import2">可以彈性的調整 filesystem 的容量！</span>』而並非在於效能與資料保全上面。
	需要檔案的讀寫效能或者是資料的可靠性，請參考前面的 RAID 小節。
	<span class="text_import2">LVM 可以整合多個實體 partition 在一起，
	讓這些 partitions 看起來就像是一個磁碟一樣！而且，還可以在未來新增或移除其他的實體 partition
	到這個 LVM 管理的磁碟當中。</span> 如此一來，整個磁碟空間的使用上，實在是相當的具有彈性啊！
	既然 LVM 這麼好用，那就讓我們來瞧瞧這玩意吧！</p>

	<a id="lvm_whatis"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.3.1 什麼是 LVM： PV, PE, VG, LV 的意義</h2>

		<p>LVM 的全名是 Logical Volume Manager，中文可以翻譯作邏輯捲軸管理員。之所以稱為『捲軸』可能是因為可以將 
		filesystem 像捲軸一樣伸長或縮短之故吧！LVM 的作法是將幾個實體的 partitions (或 disk) 
		透過軟體組合成為一塊看起來是獨立的大磁碟 (VG) ，然後將這塊大磁碟再經過分割成為可使用分割槽 (LV)，
		最終就能夠掛載使用了。但是為什麼這樣的系統可以進行 filesystem 的擴充或縮小呢？其實與一個稱為 PE 的項目有關！
		底下我們就得要針對這幾個項目來好好聊聊！</p>

		<div class="illus">

		<ul><li>Physical Volume, PV, 實體捲軸</li></ul>

		<p>我們實際的 partition (或 Disk) 需要調整系統識別碼 (system ID) 成為 8e (LVM 的識別碼)，然後再經過
		pvcreate 的指令將他轉成 LVM 最底層的實體捲軸 (PV) ，之後才能夠將這些 PV 加以利用！
		調整 system ID 的方是就是透過 <a href="http://linux.vbird.org/linux_basic/0230filesystem.php#gdisk">gdisk</a> 啦！</p>

		<ul><li>Volume Group, VG, 捲軸群組</li></ul>

		<p>所謂的 LVM 大磁碟就是將許多 PV 整合成這個 VG 的東西就是啦！所以 VG 就是 LVM 組合起來的大磁碟！這麼想就好了。
		那麼這個大磁碟最大可以到多少容量呢？這與底下要說明的 PE 以及 LVM 的格式版本有關喔～在預設的情況下，
		使用 32位元的 Linux 系統時，基本上 LV 最大僅能支援到 65534 個 PE 而已，若使用預設的 PE 為 4MB 的情況下，
		最大容量則僅能達到約 256GB 而已～不過，這個問題在 64位元的 Linux 系統上面已經不存在了！LV 幾乎沒有啥容量限制了！</p>

		<ul><li><a id="20120614"></a>Physical Extent, PE, 實體範圍區塊</li></ul>

		<p>LVM 預設使用 4MB 的 PE 區塊，而 LVM 的 LV 在 32 位元系統上最多僅能含有 65534 個 PE (lvm1 的格式)，因此預設的 LVM 的 LV 會有 
		4M*65534/(1024M/G)=256G。這個 PE 很有趣喔！他是整個 LVM 最小的儲存區塊，也就是說，其實我們的檔案資料都是藉由寫入 
		PE 來處理的。簡單的說，<span class="text_import2">這個 PE 就有點像檔案系統裡面的 block 大小啦</span>。
		這樣說應該就比較好理解了吧？所以調整 PE 會影響到 LVM 的最大容量喔！不過，在 CentOS 6.x 以後，由於直接使用 lvm2
		的各項格式功能，以及系統轉為 64 位元，因此這個限制已經不存在了。</p>

		<ul><li>Logical Volume, LV, 邏輯捲軸</li></ul>

		<p>最終的 VG 還會被切成 LV，這個 LV 就是最後可以被格式化使用的類似分割槽的咚咚了！那麼 LV 是否可以隨意指定大小呢？
		當然不可以！既然 PE 是整個 LVM 的最小儲存單位，那麼 LV 的大小就與在此 LV 內的 PE 總數有關。
		為了方便使用者利用 LVM 來管理其系統，因此 LV 的裝置檔名通常指定為『<span class="text_import2">
		/dev/vgname/lvname</span> 』的樣式！</p>

		<p>此外，我們剛剛有談到 LVM 可彈性的變更 filesystem 的容量，那是如何辦到的？其實他就是透過『交換 PE 』來進行資料轉換，
		將原本 LV 內的 PE 移轉到其他裝置中以降低 LV 容量，或將其他裝置的 PE 加到此 LV 中以加大容量！
		VG、LV 與 PE 的關係有點像下圖：</p>

	<a id="fig14.3.1"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/pe_vg.gif" alt="PE 與 VG 的相關性圖示" title="PE 與 VG 的相關性圖示" style="border: 0px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.3.1、PE 與 VG 的相關性圖示</div>

		<p>如上圖所示，VG 內的 PE 會分給虛線部分的 LV，如果未來這個 VG 要擴充的話，加上其他的 PV 即可。
		而最重要的 LV 如果要擴充的話，也是透過加入 VG 內沒有使用到的 PE 來擴充的！</p>

		</div>

		<ul class="toplist"><li>實作流程</li></ul>

		<p>透過 PV, VG, LV 的規劃之後，再利用 <a href="http://linux.vbird.org/linux_basic/0230filesystem.php#mkfs">mkfs</a>
		就可以將你的 LV 格式化成為可以利用的檔案系統了！而且這個檔案系統的容量在未來還能夠進行擴充或減少，
		而且裡面的資料還不會被影響！實在是很『福氣啦！』那實作方面要如何進行呢？很簡單呢！
		整個流程由基礎到最終的結果可以這樣看：</p>

	<a id="fig14.3.2"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/centos7_lvm.jpg" alt="LVM 各元件的實現流程圖示" title="LVM 各元件的實現流程圖示" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.3.2、LVM 各元件的實現流程圖示</div>

		<p>如此一來，我們就可以利用 LV 這個玩意兒來進行系統的掛載了。不過，你應該要覺得奇怪的是，
		<span class="text_import2">那麼我的資料寫入這個 LV 時，到底他是怎麼寫入硬碟當中的？</span>
		呵呵！好問題～其實，依據寫入機制的不同，而有兩種方式：</p>

		<ul>
		<li>線性模式 (linear)：假如我將 /dev/vda1, /dev/vdb1 這兩個 partition 加入到 VG 當中，並且整個 VG 
			只有一個 LV 時，那麼所謂的線性模式就是：當 /dev/vda1 的容量用完之後，/dev/vdb1 的硬碟才會被使用到，
			這也是我們所建議的模式。<br><br></li>

		<li>交錯模式 (triped)：那什麼是交錯模式？很簡單啊，就是我將一筆資料拆成兩部分，分別寫入 /dev/vda1 與 /dev/vdb1 
		的意思，感覺上有點像 RAID 0 啦！如此一來，一份資料用兩顆硬碟來寫入，理論上，讀寫的效能會比較好。</li>
		</ul>

		<p>基本上，<span class="text_import2">LVM 最主要的用處是在實現一個可以彈性調整容量的檔案系統上，
		而不是在建立一個效能為主的磁碟上</span>，所以，我們應該利用的是 LVM 可以彈性管理整個 partition 
		大小的用途上，而不是著眼在效能上的。因此， LVM 預設的讀寫模式是線性模式啦！
		如果你使用 triped 模式，要注意，當任何一個 partition 『歸天』時，所有的資料都會『損毀』的！
		所以啦，不是很適合使用這種模式啦！如果要強調效能與備份，那麼就直接使用 RAID 即可，
		不需要用到 LVM 啊！</p>
	<br></div><br>

	<a id="lvm_flow"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.3.2 LVM 實作流程</h2>

		<p>LVM 必需要核心有支援且需要安裝 lvm2 這個軟體，好佳在的是， CentOS 與其他較新的 distributions 
		已經預設將 lvm 的支援與軟體都安裝妥當了！所以你不需要擔心這方面的問題！用就對了！</p>

		<p>假設你剛剛也是透過同樣的方法來處理鳥哥的測試機 RAID 實作，那麼現在應該有 5 個可用的分割槽才對！
		不過，建議你還是得要修改一下 system ID 比較好！將 RAID 的 fd 改為 LVM 的 8e 吧！現在，我們實作 LVM 有點像底下的模樣：</p>

		<ul>
		<li>使用 4 個 partition ，每個 partition 的容量均為 1GB 左右，且 system ID 需要為 8e；</li>
		<li>全部的 partition 整合成為一個 VG，VG 名稱設定為 vbirdvg；且 PE 的大小為 16MB；</li>
		<li>建立一個名為 vbirdlv 的 LV，容量大約 2G 好了！</li>
		<li>最終這個 LV 格式化為 xfs 的檔案系統，且掛載在 /srv/lvm 中</li>
		</ul>

		<ul class="toplist"><li>0. Disk 階段 (實際的磁碟)</li></ul>

		<p>鳥哥就不仔細的介紹實體分割了，請您自行參考<a href="http://linux.vbird.org/linux_basic/0230filesystem.php#gdisk">第七章的 gdisk</a>
		來達成底下的範例：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">gdisk -l /dev/vda</span>
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048            6143   2.0 MiB     EF02
   2            6144         2103295   1024.0 MiB  0700
   3         2103296        65026047   30.0 GiB    8E00
   4        65026048        67123199   1024.0 MiB  8300  Linux filesystem
<span class="term_write">   5        67123200        69220351   1024.0 MiB  8E00  Linux LVM
   6        69220352        71317503   1024.0 MiB  8E00  Linux LVM
   7        71317504        73414655   1024.0 MiB  8E00  Linux LVM
   8        73414656        75511807   1024.0 MiB  8E00  Linux LVM
   9        75511808        77608959   1024.0 MiB  8E00  Linux LVM</span>
<span class="term_say"># 其實 system ID 不改變也沒關係！只是為了讓我們管理員清楚知道該 partition 的內容，
# 所以這裡建議還是修訂成正確的磁碟內容較佳！</span>
</pre></td></tr></tbody></table>

		<p>上面的 /dev/vda{5,6,7,8} 這 4 個分割槽就是我們的實體分割槽！也就是底下會實際用到的資訊！至於 /dev/vda9 則先保留下來不使用。
		注意看，那個 8e 的出現會導致 system 變成『 Linux LVM 』哩！其實沒有設定成為 8e 也沒關係，
		不過某些 LVM 的偵測指令可能會偵測不到該 partition 就是了！接下來，就一個一個的處理各流程吧！</p>

		<a id="the_pv"></a>
		<ul class="toplist"><li>1. PV 階段</li></ul>

		<p>要建立 PV 其實很簡單，只要直接使用 pvcreate 即可！我們來談一談與 PV 有關的指令吧！</p>
		<ul>
		<li>pvcreate ：將實體 partition 建立成為 PV ；</li>
		<li>pvscan ：搜尋目前系統裡面任何具有 PV 的磁碟；</li>
		<li>pvdisplay ：顯示出目前系統上面的 PV 狀態；</li>
		<li>pvremove ：將 PV 屬性移除，讓該 partition 不具有 PV 屬性。</li>
		</ul>
		<p>那就直接來瞧一瞧吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 檢查有無 PV 在系統上，然後將 /dev/vda{5-8} 建立成為 PV 格式</span>
[root@study ~]# <span class="term_command">pvscan</span>
  PV /dev/vda3   VG centos   lvm2 [30.00 GiB / 14.00 GiB free]
  Total: 1 [30.00 GiB] / in use: 1 [30.00 GiB] / in no VG: 0 [0   ]
<span class="term_say"># 其實安裝的時候，我們就有使用 LVM 了喔！所以會有 /dev/vda3 存在的！</span>

[root@study ~]# <span class="term_command">pvcreate /dev/vda{5,6,7,8}</span>
  Physical volume "/dev/vda5" successfully created
  Physical volume "/dev/vda6" successfully created
  Physical volume "/dev/vda7" successfully created
  Physical volume "/dev/vda8" successfully created
<span class="term_say"># 這個指令可以一口氣建立這四個 partition 成為 PV 啦！注意大括號的用途</span>

[root@study ~]# <span class="term_command">pvscan</span>
  PV /dev/vda3   VG centos   lvm2 [30.00 GiB / 14.00 GiB free]
<span class="term_write">  PV /dev/vda8               lvm2 [1.00 GiB]
  PV /dev/vda5               lvm2 [1.00 GiB]
  PV /dev/vda7               lvm2 [1.00 GiB]
  PV /dev/vda6               lvm2 [1.00 GiB]</span>
  Total: 5 [34.00 GiB] / in use: 1 [30.00 GiB] / in no VG: 4 [4.00 GiB]
<span class="term_say"># 這就分別顯示每個 PV 的資訊與系統所有 PV 的資訊。尤其最後一行，顯示的是：
# 整體 PV 的量 / 已經被使用到 VG 的 PV 量 / 剩餘的 PV 量</span>

<span class="term_hd"># 2. 更詳細的列示出系統上面每個 PV 的個別資訊：</span>
[root@study ~]# <span class="term_command">pvdisplay /dev/vda5</span>
  "/dev/vda5" is a new physical volume of "1.00 GiB"
  --- NEW Physical volume ---
  PV Name               /dev/vda5  <span class="term_note">&lt;==實際的 partition 裝置名稱</span>
  VG Name                          <span class="term_note">&lt;==因為尚未分配出去，所以空白！</span>
  PV Size               1.00 GiB   <span class="term_note">&lt;==就是容量說明</span>
  Allocatable           NO         <span class="term_note">&lt;==是否已被分配，結果是 NO</span>
  PE Size               0          <span class="term_note">&lt;==在此 PV 內的 PE 大小</span>
  Total PE              0          <span class="term_note">&lt;==共分割出幾個 PE</span>
  Free PE               0          <span class="term_note">&lt;==沒被 LV 用掉的 PE</span>
  Allocated PE          0          <span class="term_note">&lt;==尚可分配出去的 PE 數量</span>
  PV UUID               Cb717z-lShq-6WXf-ewEj-qg0W-MieW-oAZTR6
<span class="term_say"># 由於 PE 是在建立 VG 時才給予的參數，因此在這裡看到的 PV 裡頭的 PE 都會是 0
# 而且也沒有多餘的 PE 可供分配 (allocatable)。</span>
</pre></td></tr></tbody></table>

		<p>講是很難，作是很簡單！這樣就將 PV 建立了起來囉！簡單到不行吧！ ^_^！繼續來玩 VG 去！</p>

		<a id="the_vg"></a>
		<ul class="toplist"><li>2. VG 階段</li></ul>

		<p>建立 VG 及 VG 相關的指令也不少，我們來看看：</p>

		<ul>
		<li>vgcreate ：就是主要建立 VG 的指令啦！他的參數比較多，等一下介紹。</li>
		<li>vgscan ：搜尋系統上面是否有 VG 存在？</li>
		<li>vgdisplay ：顯示目前系統上面的 VG 狀態；</li>
		<li>vgextend ：在 VG 內增加額外的 PV ；</li>
		<li>vgreduce ：在 VG 內移除 PV；</li>
		<li>vgchange ：設定 VG 是否啟動 (active)；</li>
		<li>vgremove ：刪除一個 VG 啊！</li>
		</ul>

		<p>與 PV 不同的是， VG 的名稱是自訂的！我們知道 PV 的名稱其實就是 partition 的裝置檔名，
		但是這個 VG 名稱則可以隨便你自己取啊！在底下的例子當中，我將 VG 名稱取名為 vbirdvg 。建立這個 
		VG 的流程是這樣的：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">vgcreate [-s N[mgt]] VG名稱 PV名稱</span>
<span class="term_say">選項與參數：
-s ：後面接 PE 的大小 (size) ，單位可以是 m, g, t (大小寫均可)</span>

<span class="term_hd"># 1. 將 /dev/vda5-7 建立成為一個 VG，且指定 PE 為 16MB 喔！</span>
[root@study ~]# <span class="term_command">vgcreate -s 16M vbirdvg /dev/vda{5,6,7}</span>
  Volume group "vbirdvg" successfully created

[root@study ~]# <span class="term_command">vgscan</span>
  Reading all physical volumes.  This may take a while...
  Found volume group "vbirdvg" using metadata type lvm2  <span class="term_note"># 我們手動製作的</span>
  Found volume group "centos" using metadata type lvm2   <span class="term_note"># 之前系統安裝時作的</span>

[root@study ~]# <span class="term_command">pvscan</span>
<span class="term_write">  PV /dev/vda5   VG vbirdvg   lvm2 [1008.00 MiB / 1008.00 MiB free]
  PV /dev/vda6   VG vbirdvg   lvm2 [1008.00 MiB / 1008.00 MiB free]
  PV /dev/vda7   VG vbirdvg   lvm2 [1008.00 MiB / 1008.00 MiB free]</span>
  PV /dev/vda3   VG centos    lvm2 [30.00 GiB / 14.00 GiB free]
  PV /dev/vda8                lvm2 [1.00 GiB]
  Total: 5 [33.95 GiB] / in use: 4 [32.95 GiB] / in no VG: 1 [1.00 GiB]
<span class="term_say"># 嘿嘿！發現沒！有三個 PV 被用去，剩下 1 個 /dev/vda8 的 PV 沒被用掉！</span>

[root@study ~]# <span class="term_command">vgdisplay vbirdvg</span>
  --- Volume group ---
  VG Name               vbirdvg
  System ID
  Format                lvm2
  Metadata Areas        3
  Metadata Sequence No  1
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                3
  Act PV                3
  VG Size               2.95 GiB        <span class="term_note">&lt;==整體的 VG 容量有這麼大</span>
  PE Size               16.00 MiB       <span class="term_note">&lt;==內部每個 PE 的大小</span>
<span class="term_write">  Total PE              189             <span class="term_note">&lt;==總共的 PE 數量共有這麼多！</span>
  Alloc PE / Size       0 / 0
  Free  PE / Size       189 / 2.95 GiB  </span><span class="term_note">&lt;==尚可配置給 LV 的 PE數量/總容量有這麼多！</span>
  VG UUID               Rx7zdR-y2cY-HuIZ-Yd2s-odU8-AkTW-okk4Ea
<span class="term_say"># 最後那三行指的就是 PE 能夠使用的情況！由於尚未切出 LV，因此所有的 PE 均可自由使用。</span>
</pre></td></tr></tbody></table>

		<p>這樣就建立一個 VG 了！假設我們要增加這個 VG 的容量，因為我們還有 /dev/vda8 嘛！此時你可以這樣做：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 2. 將剩餘的 PV (/dev/vda8) 丟給 vbirdvg 吧！</span>
[root@study ~]# <span class="term_command">vgextend vbirdvg /dev/vda8</span>
  Volume group "vbirdvg" successfully extended

[root@study ~]# <span class="term_command">vgdisplay vbirdvg</span>
<span class="term_say">....(前面省略)....</span>
  VG Size               3.94 GiB
  PE Size               16.00 MiB
<span class="term_write">  Total PE              252</span>
  Alloc PE / Size       0 / 0
  Free  PE / Size       252 / 3.94 GiB
<span class="term_say"># 基本上，不難吧！這樣就可以抽換整個 VG 的大小啊！</span>
</pre></td></tr></tbody></table>

		<p>我們多了一個裝置喔！接下來為這個 vbirdvg 進行分割吧！透過 LV 功能來處理！</p>

		<a id="the_lv"></a>
		<ul class="toplist"><li>3. LV 階段</li></ul>

		<p>創造出 VG 這個大磁碟之後，再來就是要建立分割區啦！這個分割區就是所謂的 LV 囉！假設我要將剛剛那個 
		vbirdvg 磁碟，分割成為 vbirdlv ，整個 VG 的容量都被分配到 vbirdlv 裡面去！先來看看能使用的指令後，就直接工作了先！</p>
		<ul>
		<li>lvcreate ：建立 LV 啦！</li>
		<li>lvscan ：查詢系統上面的 LV ；</li>
		<li>lvdisplay ：顯示系統上面的 LV 狀態啊！</li>
		<li>lvextend ：在 LV 裡面增加容量！</li>
		<li>lvreduce ：在 LV 裡面減少容量；</li>
		<li>lvremove ：刪除一個 LV ！</li>
		<li>lvresize ：對 LV 進行容量大小的調整！</li>
		</ul>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">lvcreate [-L N[mgt]] [-n LV名稱] VG名稱</span>
[root@study ~]# <span class="term_command">lvcreate [-l N] [-n LV名稱] VG名稱</span>
<span class="term_say">選項與參數：
-L  ：後面接容量，容量的單位可以是 M,G,T 等，要注意的是，最小單位為 PE，
      因此這個數量必須要是 PE 的倍數，若不相符，系統會自行計算最相近的容量。
-l  ：後面可以接 PE 的『個數』，而不是數量。若要這麼做，得要自行計算 PE 數。
-n  ：後面接的就是 LV 的名稱啦！
更多的說明應該可以自行查閱吧！ man lvcreate </span>

<span class="term_hd"># 1. 將 vbirdvg 分 2GB 給 vbirdlv 喔！</span>
[root@study ~]# <span class="term_command">lvcreate -L 2G -n vbirdlv vbirdvg</span>
  Logical volume "vbirdlv" created
<span class="term_say"># 由於本案例中每個 PE 為 16M ，如果要用 PE 的數量來處理的話，那使用下面的指令也 OK喔！
# lvcreate -l 128 -n vbirdlv vbirdvg</span>

[root@study ~]# <span class="term_command">lvscan</span>
  ACTIVE            '/dev/vbirdvg/vbirdlv' [2.00 GiB] inherit  <span class="term_note">&lt;==新增加的一個 LV 囉！</span>
  ACTIVE            '/dev/centos/root' [10.00 GiB] inherit
  ACTIVE            '/dev/centos/home' [5.00 GiB] inherit
  ACTIVE            '/dev/centos/swap' [1.00 GiB] inherit

[root@study ~]# <span class="term_command">lvdisplay /dev/vbirdvg/vbirdlv</span>
  --- Logical volume ---
  LV Path                /dev/vbirdvg/vbirdlv   <span class="term_note"># 這個是 LV 的全名喔！</span>
  LV Name                vbirdlv
  VG Name                vbirdvg
  LV UUID                QJJrTC-66sm-878Y-o2DC-nN37-2nFR-0BwMmn
  LV Write Access        read/write
  LV Creation host, time study.centos.vbird, 2015-07-28 02:22:49 +0800
  LV Status              available
  # open                 0
  LV Size                2.00 GiB               <span class="term_note"># 容量就是這麼大！</span>
  Current LE             128
  Segments               3
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:3
</pre></td></tr></tbody></table>

		<p>如此一來，整個 LV partition 也準備好啦！接下來，就是針對這個 LV 來處理啦！要特別注意的是， VG 的名稱為 vbirdvg ，
		但是 LV 的名稱<span class="text_import2">必須使用全名！亦即是 /dev/vbirdvg/vbirdlv</span> 才對喔！
		後續的處理都是這樣的！這點初次接觸 LVM 的朋友很容易搞錯！</p>

		<a id="the_file"></a>
		<ul class="toplist"><li>檔案系統階段</li></ul>

		<p>這個部分鳥哥我就不再多加解釋了！直接來進行吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 格式化、掛載與觀察我們的 LV 吧！</span>
[root@study ~]# <span class="term_command">mkfs.xfs /dev/vbirdvg/vbirdlv</span> <span class="term_note">&lt;==注意 LV 全名！</span>
[root@study ~]# <span class="term_command">mkdir /srv/lvm</span>
[root@study ~]# <span class="term_command">mount /dev/vbirdvg/vbirdlv /srv/lvm</span>
[root@study ~]# <span class="term_command">df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv xfs   2.0G   33M  2.0G   2% /srv/lvm

[root@study ~]# <span class="term_command">cp -a /etc /var/log /srv/lvm</span>
[root@study ~]# <span class="term_command">df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv xfs   2.0G  152M  1.9G   8% /srv/lvm  <span class="term_note">&lt;==確定是可用的啊！</span>
</pre></td></tr></tbody></table>

		<p>透過這樣的功能，我們現在已經建置好一個 LV 了！你可以自由的應用 /srv/lvm 內的所有資源！</p>
	<br></div><br>

	<a id="lvm_large"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.3.3 放大 LV 容量</h2>

		<p>我們不是說 LVM 最大的特色就是彈性調整磁碟容量嗎？好！那我們就來處理一下，如果要放大 LV 的容量時，
		該如何進行完整的步驟呢？其實一點都不難喔！如果你回去看<a href="http://linux.vbird.org/linux_basic/0420quota.php#fig14.3.2">圖 14.3.2</a> 的話，那麼你會知道放大檔案系統時，
		需要底下這些流程的：</p>

		<ol>
		<li><span class="text_import2">VG 階段需要有剩餘的容量</span>：因為需要放大檔案系統，所以需要放大 LV，但是若沒有多的 VG 容量，
			那麼更上層的 LV 與檔案系統就無法放大的。因此，你得要用盡各種方法來產生多的 VG 容量才行。一般來說，如果 VG 容量不足，
			最簡單的方法就是再加硬碟！然後將該硬碟使用上面講過的 pvcreate 及 vgextend 增加到該 VG 內即可！<br><br></li>

		<li><span class="text_import2">LV 階段產生更多的可用容量</span>：如果 VG 的剩餘容量足夠了，
			此時就可以利用 lvresize 這個指令來將剩餘容量加入到所需要增加的 LV 裝置內！過程相當簡單！<br><br></li>

		<li><span class="text_import2">檔案系統階段的放大</span>：我們的 Linux 實際使用的其實不是 LV 啊！而是 LV 這個裝置內的檔案系統！
			所以一切最終還是要以檔案系統為依歸！目前在 Linux 環境下，鳥哥測試過可以放大的檔案系統有 XFS 以及 EXT 家族！
			至於縮小僅有 EXT 家族，目前 XFS 檔案系統並不支援檔案系統的容量縮小喔！要注意！要注意！XFS 放大檔案系統透過簡單的
			xfs_growfs 指令即可！</li>
		</ol>

		<p>其中最後一個步驟最重要！我們在<a href="http://linux.vbird.org/linux_basic/0230filesystem.php">第七章</a>當中知道，
		整個檔案系統在最初格式化的時候就建立了 inode/block/superblock 等資訊，要改變這些資訊是很難的！
		不過因為檔案系統格式化的時候建置的是多個 block group ，因此我們可以透過在檔案系統當中增加 block group 
		的方式來增減檔案系統的量！而增減 block group 就是利用 xfs_growfs 囉！所以最後一步是針對檔案系統來處理的，
		前面幾步則是針對 LVM 的實際容量大小！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		因此，嚴格說起來，放大檔案系統並不是沒有進行『格式化』喔！放大檔案系統時，格式化的位置在於該裝置後來新增的部份，裝置的前面已經存在的檔案系統則沒有變化。
		而新增的格式化過的資料，再反饋回原本的 supberblock 這樣而已！
		</fieldset><br>
		<p>讓我們來實作個範例，假設我們想要針對 /srv/lvm 再增加 500M 的容量，該如何處置？</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 由前面的過程我們知道 /srv/lvm 是 /dev/vbirdvg/vbirdlv 這個裝置，所以檢查 vbirdvg 吧！</span>
[root@study ~]# <span class="term_command">vgdisplay vbirdvg</span>
  --- Volume group ---
  VG Name               vbirdvg
  System ID
  Format                lvm2
  Metadata Areas        4
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                1
  Open LV               1
  Max PV                0
  Cur PV                4
  Act PV                4
  VG Size               3.94 GiB
  PE Size               16.00 MiB
  Total PE              252
  Alloc PE / Size       128 / 2.00 GiB
<span class="term_write">  Free  PE / Size       124 / 1.94 GiB</span>    <span class="term_note"># 看起來剩餘容量確實超過 500M 的！</span>
  VG UUID               Rx7zdR-y2cY-HuIZ-Yd2s-odU8-AkTW-okk4Ea
<span class="term_say"># 既然 VG 的容量夠大了！所以直接來放大 LV 吧！！</span>

<span class="term_hd"># 2. 放大 LV 吧！利用 lvresize 的功能來增加！</span>
[root@study ~]# <span class="term_command">lvresize -L +500M /dev/vbirdvg/vbirdlv</span>
  Rounding size to boundary between physical extents: 512.00 MiB
  Size of logical volume vbirdvg/vbirdlv changed from 2.00 GiB (128 extents) to 2.50 GiB 
(160 extents).
  Logical volume vbirdlv successfully resized
<span class="term_say"># 這樣就增加了 LV 了喔！lvresize 的語法很簡單，基本上同樣透過 -l 或 -L 來增加！
# 若要增加則使用 + ，若要減少則使用 - ！詳細的選項請參考 man lvresize 囉！</span>

[root@study ~]# <span class="term_command">lvscan</span>
<span class="term_write">  ACTIVE            '/dev/vbirdvg/vbirdlv' [2.50 GiB] inherit</span>
  ACTIVE            '/dev/centos/root' [10.00 GiB] inherit
  ACTIVE            '/dev/centos/home' [5.00 GiB] inherit
  ACTIVE            '/dev/centos/swap' [1.00 GiB] inherit
<span class="term_say"># 可以發現 /dev/vbirdvg/vbirdlv 容量由 2G 增加到 2.5G 囉！</span>

[root@study ~]# <span class="term_command">df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv xfs   <span class="term_write">2.0G</span>  111M  1.9G   6% /srv/lvm
</pre></td></tr></tbody></table>

		<p>看到了吧？最終的結果中 LV 真的有放大到 2.5GB 喔！但是檔案系統卻沒有相對增加！而且，我們的 LVM 可以線上直接處理，並不需要特別給他 umount 哩！真是人性化！
		但是還是得要處理一下檔案系統的容量啦！開始觀察一下檔案系統，然後使用 xfs_growfs 來處理一下吧！</p>

<a id="xfs_growfs"></a>
<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 3.1 先看一下原本的檔案系統內的 superblock 記錄情況吧！</span>
[root@study ~]# <span class="term_command">xfs_info /srv/lvm</span>
meta-data=/dev/mapper/vbirdvg-vbirdlv isize=256    <span class="term_write">agcount=4</span>, agsize=131072 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=0        finobt=0
data     =                       bsize=4096   <span class="term_write">blocks=524288</span>, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0

[root@study ~]# <span class="term_command">xfs_growfs /srv/lvm</span>  <span class="term_note"># 這一步驟才是最重要的！</span>
[root@study ~]# <span class="term_command">xfs_info /srv/lvm</span>
meta-data=/dev/mapper/vbirdvg-vbirdlv isize=256    <span class="term_write">agcount=5</span>, agsize=131072 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=0        finobt=0
data     =                       bsize=4096   <span class="term_write">blocks=655360</span>, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0

[root@study ~]# <span class="term_command">df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv xfs   <span class="term_write">2.5G</span>  111M  2.4G   5% /srv/lvm

[root@study ~]# <span class="term_command">ls -l /srv/lvm</span>
drwxr-xr-x. 131 root root 8192 Jul 28 00:12 etc
drwxr-xr-x.  16 root root 4096 Jul 28 00:01 log
<span class="term_say"># 剛剛複製進去的資料可還是存在的喔！並沒有消失不見！</span>
</pre></td></tr></tbody></table>

		<p>在上表中，注意看兩次 xfs_info 的結果，你會發現到 1)整個 block group (agcount) 的數量增加一個！那個 block group 就是紀錄新的裝置容量之檔案系統所在！
		而你也會 2)發現整體的 block 數量增加了！這樣整個檔案系統就給他放大了！同時，使用 df 去查閱時，就真的看到增加的量了吧！
		檔案系統的放大可以在 On-line 的環境下實作耶！超棒的！</p>

		<p>最後，請注意！目前的 XFS 檔案系統中，並沒有縮小檔案系統容量的設計！也就是說，檔案系統只能放大不能縮小喔！如果你想要保有放大、縮小的本事，
		那還請回去使用 EXT 家族最新的 EXT4 檔案系統囉！XFS 目前是辦不到的！</p>

	<br></div><br>

	<a id="lvm_thin"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.3.4 使用 LVM thin Volume 讓 LVM 動態自動調整磁碟使用率</h2>

		<p>想像一個情況，你有個目錄未來會使用到大約 5T 的容量，但是目前你的磁碟僅有 3T，問題是，接下來的兩個月你的系統都還不會超過 3T 的容量，
		不過你想要讓用戶知道，就是他最多有 5T 可以使用就是了！而且在一個月內你確實可以將系統提升到 5T 以上的容量啊！
		你又不想要在提升容量後才放大到 5T！那可以怎麼辦？呵呵！這時可以考慮『實際用多少才分配多少容量給 LV 的 LVM Thin Volume 』功能！</p>

		<p>另外，再想像一個環境，如果你需要有 3 個 10GB 的磁碟來進行某些測試，問題是你的環境僅有 5GB 的剩餘容量，再傳統的 LVM 環境下，
		LV 的容量是一開始就分配好的，因此你當然沒有辦法在這樣的環境中產生出 3 個 10GB 的裝置啊！而且更嘔的是，那個 10GB 的裝置其實每個實際使用率都沒有超過 10%，
		也就是總用量目前僅會到 3GB 而已！但...我實際就有 5GB 的容量啊！為何不給我做出 3 個只用 1GB 的 10GB 裝置呢？有啊！就還是 LVM thin Volume 啊！</p>

		<p>什麼是 LVM thin Volume 呢？這東西其實挺好玩的，他的概念是：先建立一個可以實支實付、用多少容量才分配實際寫入多少容量的磁碟容量儲存池 (thin pool)，
		然後再由這個 thin pool 去產生一個『指定要固定容量大小的 LV 裝置』，這個 LV 就有趣了！雖然你會看到『宣告上，他的容量可能有 10GB ，但實際上，
		該裝置用到多少容量時，才會從 thin pool 去實際取得所需要的容量』！就如同上面的環境說的，可能我們的 thin pool 僅有 1GB 的容量，
		但是可以分配給一個 10GB 的 LV 裝置！而該裝置實際使用到 500M 時，整個 thin pool 才分配 500M 給該 LV 的意思！當然啦！
		在所有由 thin pool 所分配出來的 LV 裝置中，總實際使用量絕不能超過 thin pool 的最大實際容量啊！如這個案例說的， thin pool 僅有 1GB，
		那所有的由這個 thin pool 建置出來的 LV 裝置內的實際用量，就絕不能超過 1GB 啊！</p>

		<p>我們來實作個環境好了！剛剛鳥哥的 vbirdvg 應該還有剩餘容量，那麼請這樣作看看：</p>

		<ol>
		<li>由 vbirdvg 的剩餘容量取出 1GB 來做出一個名為 vbirdtpool 的 thin pool LV 裝置，這就是所謂的磁碟容量儲存池 (thin pool)</li>
		<li>由 vbirdvg 內的 vbirdtpool 產生一個名為 vbirdthin1 的 10GB LV 裝置</li>
		<li>將此裝置實際格式化為 xfs 檔案系統，並且掛載於 /srv/thin 目錄內！</li>
		</ol>

		<p>話不多說，我們來實驗看看！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先以 lvcreate 來建立 vbirdtpool 這個 thin pool 裝置：</span>
[root@study ~]# <span class="term_command">lvcreate -L 1G -T vbirdvg/vbirdtpool</span>  <span class="term_note"># 最重要的建置指令</span>
[root@study ~]# <span class="term_command">lvdisplay /dev/vbirdvg/vbirdtpool</span>
  --- Logical volume ---
  LV Name                vbirdtpool
  VG Name                vbirdvg
  LV UUID                p3sLAg-Z8jT-tBuT-wmEL-1wKZ-jrGP-0xmLtk
  LV Write Access        read/write
  LV Creation host, time study.centos.vbird, 2015-07-28 18:27:32 +0800
  LV Pool metadata       vbirdtpool_tmeta
  LV Pool data           vbirdtpool_tdata
  LV Status              available
  # open                 0
<span class="term_write">  LV Size                1.00 GiB   <span class="term_note"># 總共可分配出去的容量</span>
  Allocated pool data    0.00%      <span class="term_note"># 已分配的容量百分比</span>
  Allocated metadata     0.24%</span>      <span class="term_note"># 已分配的中介資料百分比</span>
  Current LE             64
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:6
<span class="term_say"># 非常有趣吧！竟然在 LV 裝置中還可以有再分配 (Allocated) 的項目耶！果然是儲存池！</span>

[root@study ~]# <span class="term_command">lvs vbirdvg</span>  <span class="term_note"># 語法為 lvs VGname</span>
  LV         VG      Attr       LSize Pool Origin <span class="term_write">Data%  Meta%</span>  Move Log Cpy%Sync Convert
  vbirdlv    vbirdvg -wi-ao---- 2.50g
  vbirdtpool vbirdvg twi-a-tz-- 1.00g             <span class="term_write">0.00   0.24</span>
<span class="term_say"># 這個 lvs 指令的輸出更加簡單明瞭！直接看比較清晰！</span>

<span class="term_hd"># 2. 開始建立 vbirdthin1 這個有 10GB 的裝置，注意！必須使用 --thin 與 vbirdtpool 連結喔！</span>
[root@study ~]# <span class="term_command">lvcreate -V 10G -T vbirdvg/vbirdtpool -n vbirdthin1</span>

[root@study ~]# <span class="term_command">lvs vbirdvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  vbirdlv    vbirdvg -wi-ao----  2.50g
<span class="term_write">  vbirdthin1 vbirdvg Vwi-a-tz-- 10.00g vbirdtpool        0.00</span>
  vbirdtpool vbirdvg twi-aotz--  1.00g                   0.00   0.27
<span class="term_say"># 很有趣吧！明明連 vbirdvg 這個 VG 都沒有足夠大到 10GB 的容量，透過 thin pool
# 竟然就產生了 10GB 的 vbirdthin1 這個裝置了！好有趣！</span>

<span class="term_hd"># 3. 開始建立檔案系統</span>
[root@study ~]# <span class="term_command">mkfs.xfs /dev/vbirdvg/vbirdthin1</span>
[root@study ~]# <span class="term_command">mkdir /srv/thin</span>
[root@study ~]# <span class="term_command">mount /dev/vbirdvg/vbirdthin1 /srv/thin</span>
[root@study ~]# <span class="term_command">df -Th /srv/thin</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdthin1 xfs    <span class="term_write">10G</span>   33M   10G   1% /srv/thin
<span class="term_say"># 真的有 10GB 耶！！</span>

<span class="term_hd"># 4. 測試一下容量的使用！建立 500MB 的檔案，但不可超過 1GB 的測試為宜！</span>
[root@study ~]# <span class="term_command">dd if=/dev/zero of=/srv/thin/test.img bs=1M count=500</span>
[root@study ~]# <span class="term_command">lvs vbirdvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  vbirdlv    vbirdvg -wi-ao----  2.50g
  vbirdthin1 vbirdvg Vwi-aotz-- 10.00g vbirdtpool        4.99
  vbirdtpool vbirdvg twi-aotz--  1.00g                   <span class="term_write">49.93</span>  1.81
<span class="term_say"># 很要命！這時已經分配出 49% 以上的容量了！而 vbirdthin1 卻只看到用掉 5% 而已！
# 所以鳥哥認為，這個 thin pool 非常好用！但是在管理上，得要特別特別的留意！</span>
</pre></td></tr></tbody></table>

		<p>這就是用多少算多少的 thin pool 實作方式！基本上，用來騙人挺嚇人的！小小的一個磁碟可以模擬出好多容量！但實際上，真的可用容量就是實際的磁碟儲存池內的容量！
		如果突破該容量，這個 thin pool 可是會爆炸而讓資料損毀的！要注意！要注意！</p>

	<br></div><br>

	<a id="lvm_snapshot"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.3.5 LVM 的 LV 磁碟快照</h2>

		<p>現在你知道 LVM 的好處咯，未來如果你有想要增加某個 LVM 的容量時，就可以透過這個放大的功能來處理。
		那麼 LVM 除了這些功能之外，還有什麼能力呢？其實他還有一個重要的能力，那就是 LV 磁碟的快照 (snapshot)。
		什麼是 LV 磁碟快照啊？<span class="text_import2">快照就是將當時的系統資訊記錄下來，就好像照相記錄一般！
		未來若有任何資料更動了，則原始資料會被搬移到快照區，沒有被更動的區域則由快照區與檔案系統共享。</span>
		用講的好像很難懂，我們用圖解說明一下好了：</p>

	<a id="fig14.3.3"></a>
	<div style="text-align:center; margin: 0 auto 0 auto; "><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/snapshot.gif" alt="LVM 快照區域的備份示意圖" title="LVM 快照區域的備份示意圖" style="border: 1px solid black; padding: 10px "></div>
	<div style="text-align: center;">圖14.3.3、LVM 快照區域的備份示意圖</div>

		<p>左圖為最初建置 LV 磁碟快照區的狀況，LVM 會預留一個區域 (左圖的左側三個 PE 區塊) 作為資料存放處。
		此時快照區內並沒有任何資料，而<span class="text_import2">快照區與系統區共享所有的 PE 資料，
		因此你會看到快照區的內容與檔案系統是一模一樣的</span>。
		等到系統運作一陣子後，假設 A 區域的資料被更動了 (上面右圖所示)，<span class="text_import2">則更動前系統會將該區域的資料移動到快照區</span>，
		所以在右圖的快照區被佔用了一塊 PE 成為 A，而其他 B 到 I 的區塊則還是與檔案系統共用！</p>

		<p>照這樣的情況來看，LVM 的磁碟快照是非常棒的『備份工具』，因為他只有備份有被更動到的資料，
		檔案系統內沒有被變更的資料依舊保持在原本的區塊內，但是 LVM 快照功能會知道那些資料放置在哪裡，
		因此『快照』當時的檔案系統就得以『備份』下來，且快照所佔用的容量又非常小！所以您說，這不是很棒的工具又是什麼？</p>

		<p>那麼快照區要如何建立與使用呢？首先，由於快照區與原本的 LV 共用很多 PE 區塊，因此<span class="text_import2">快照區與被快照的 LV 必須要在同一個 VG 上頭。</span></p>

		<p>另外，或許你跟鳥哥一樣，會想到說：『咦！
		我們能不能使用 thin pool 的功能來製作快照』呢？老實說，是可以的！不過使用上面的限制非常的多！包括最好要在同一個 thin pool 內的原始 LV 磁碟，
		如果為非 thin pool 內的原始 LV 磁碟快照，則該磁碟快照『不可以寫入』，亦即 LV 磁碟要設定成唯讀才行！同時，
		使用 thin pool 做出來的快照，通常都是不可啟動 (inactive) 的預設情況，啟動又有點麻煩～所以，至少目前 (CentOS 7.x) 的環境下，
		鳥哥還不是很建議你使用 thin pool 快照喔！</p> 

		<p>底下我們針對傳統 LV 磁碟進行快照的建置，大致流程為：</p>

		<ul>
		<li>預計被拿來備份的原始 LV 為 /dev/vbirdvg/vbirdlv 這個東西～</li>
		<li>使用傳統方式快照建置，原始碟為 /dev/vbirdvg/vbirdlv，快照名稱為 vbirdsnap1，容量為 vbirdvg 的所有剩餘容量</li>
		</ul>

		<a id="snapshot_create"></a>
		<ul class="toplist"><li>傳統快照區的建立</li></ul>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先觀察 VG 還剩下多少剩餘容量</span>
[root@study ~]# <span class="term_command">vgdisplay vbirdvg</span>
<span class="term_say">....(其他省略)....</span>
  Total PE              252
  Alloc PE / Size       226 / 3.53 GiB
  Free  PE / Size       <span class="term_write">26</span> / 416.00 MiB
<span class="term_say"># 就只有剩下 26 個 PE 了！全部分配給 vbirdsnap1 囉！</span>

<span class="term_hd"># 2. 利用 lvcreate 建立 vbirdlv 的快照區，快照被取名為 vbirdsnap1，且給予 26 個 PE</span>
[root@study ~]# <span class="term_command">lvcreate -s -l 26 -n vbirdsnap1 /dev/vbirdvg/vbirdlv</span>
  Logical volume "vbirdsnap1" created
<span class="term_say"># 上述的指令中最重要的是那個 -s 的選項！代表是 snapshot 快照功能之意！
# -n 後面接快照區的裝置名稱， /dev/.... 則是要被快照的 LV 完整檔名。
# -l 後面則是接使用多少個 PE 來作為這個快照區使用。</span>

[root@study ~]# <span class="term_command">lvdisplay /dev/vbirdvg/vbirdsnap1</span>
  --- Logical volume ---
  LV Path                /dev/vbirdvg/vbirdsnap1
  LV Name                vbirdsnap1
  VG Name                vbirdvg
  LV UUID                I3m3Oc-RIvC-unag-DiiA-iQgI-I3z9-0OaOzR
  LV Write Access        read/write
  LV Creation host, time study.centos.vbird, 2015-07-28 19:21:44 +0800
  LV snapshot status     active destination for vbirdlv
  LV Status              available
  # open                 0
  LV Size                2.50 GiB    <span class="term_note"># 原始碟，就是 vbirdlv 的原始容量</span>
  Current LE             160
  COW-table size         416.00 MiB  <span class="term_note"># 這個快照能夠紀錄的最大容量！</span>
  COW-table LE           26
  Allocated to snapshot  0.00%       <span class="term_note"># 目前已經被用掉的容量！</span>
  Snapshot chunk size    4.00 KiB
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:11
</pre></td></tr></tbody></table>

		<p>您看看！這個 /dev/vbirdvg/vbirdsnap1 快照區就被建立起來了！而且他的 VG 量竟然與原本的 /dev/vbirdvg/vbirdlv 
		相同！也就是說，如果你真的掛載這個裝置時，看到的資料會跟原本的 vbirdlv 相同喔！我們就來測試看看：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mkdir /srv/snapshot1</span>
[root@study ~]# <span class="term_command">mount -o nouuid /dev/vbirdvg/vbirdsnap1 /srv/snapshot1</span>
[root@study ~]# <span class="term_command">df -Th /srv/lvm /srv/snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv    xfs   2.5G  111M  2.4G   5% /srv/lvm
/dev/mapper/vbirdvg-vbirdsnap1 xfs   2.5G  111M  2.4G   5% /srv/snapshot1
<span class="term_say"># 有沒有看到！這兩個咚咚竟然是一模一樣喔！我們根本沒有動過
# /dev/vbirdvg/vbirdsnap1 對吧！不過這裡面會主動記錄原 vbirdlv 的內容！</span>
</pre></td></tr></tbody></table>

		<p>因為 XFS 不允許相同的 UUID 檔案系統的掛載，因此我們得要加上那個 nouuid 的參數，讓檔案系統忽略相同的 UUID 所造成的問題！
		沒辦法啊！因為快照出來的檔案系統當然是會一模一樣的！</p>

		<a id="snapshot_rescue"></a>
		<ul class="toplist"><li>利用快照區復原系統</li></ul>

		<p>首先，我們來玩一下，如何利用快照區復原系統吧！不過你要注意的是，<span class="text_import2">你要復原的資料量不能夠高於快照區所能負載的實際容量。</span>由於原始資料會被搬移到快照區，
		如果你的快照區不夠大，若原始資料被更動的實際資料量比快照區大，那麼快照區當然容納不了，這時候快照功能會失效喔！</p>

		<p>我們的 /srv/lvm 已經有 /srv/lvm/etc, /srv/lvm/log 等目錄了，接下來我們將這個檔案系統的內容作個變更，
		然後再以快照區資料還原看看：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 1. 先將原本的 /dev/vbirdvg/vbirdlv 內容作些變更，增增減減一些目錄吧！</span>
[root@study ~]# <span class="term_command">df -Th /srv/lvm /srv/snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv    xfs   2.5G  111M  2.4G   5% /srv/lvm
/dev/mapper/vbirdvg-vbirdsnap1 xfs   2.5G  111M  2.4G   5% /srv/snapshot1

[root@study ~]# <span class="term_command">cp -a /usr/share/doc /srv/lvm</span>
[root@study ~]# <span class="term_command">rm -rf /srv/lvm/log</span>
[root@study ~]# <span class="term_command">rm -rf /srv/lvm/etc/sysconfig</span>
[root@study ~]# <span class="term_command">df -Th /srv/lvm /srv/snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/vbirdvg-vbirdlv    xfs   2.5G  146M  2.4G   6% /srv/lvm
/dev/mapper/vbirdvg-vbirdsnap1 xfs   2.5G  111M  2.4G   5% /srv/snapshot1
[root@study ~]# <span class="term_command">ll /srv/lvm /srv/snapshot1</span>
/srv/lvm:
total 60
drwxr-xr-x. 887 root root 28672 Jul 20 23:03 doc
drwxr-xr-x. 131 root root  8192 Jul 28 00:12 etc

/srv/snapshot1:
total 16
drwxr-xr-x. 131 root root 8192 Jul 28 00:12 etc
drwxr-xr-x.  16 root root 4096 Jul 28 00:01 log
<span class="term_say"># 兩個目錄的內容看起來已經不太一樣了喔！檢測一下快照 LV 吧！</span>

[root@study ~]# <span class="term_command">lvdisplay /dev/vbirdvg/vbirdsnap1</span>
  --- Logical volume ---
  LV Path                /dev/vbirdvg/vbirdsnap1
<span class="term_say">....(中間省略)....</span>
<span class="term_write">  Allocated to snapshot  21.47%</span>
<span class="term_say"># 鳥哥僅列出最重要的部份！就是全部的容量已經被用掉了 21.4% 囉！</span>

<span class="term_hd"># 2. 利用快照區將原本的 filesystem 備份，我們使用 xfsdump 來處理！</span>
[root@study ~]# <span class="term_command">xfsdump -l 0 -L lvm1 -M lvm1 -f /home/lvm.dump /srv/snapshot1</span>
<span class="term_say"># 此時你就會有一個備份資料，亦即是 /home/lvm.dump 了！</span>
</pre></td></tr></tbody></table>

		<p>為什麼要備份呢？為什麼不可以直接格式化 /dev/vbirdvg/vbirdlv 然後將 /dev/vbirdvg/vbirdsnap1 直接複製給 vbirdlv  呢？
		要知道 vbirdsnap1 其實是 vbirdlv 的快照，因此如果你格式化整個 vbirdlv 時，原本的檔案系統所有資料都會被搬移到 vbirdsnap1。
		那如果 vbirdsnap1 的容量不夠大 (通常也真的不夠大)，那麼部分資料將無法複製到 vbirdsnap1  內，資料當然無法全部還原啊！
		所以才要在上面表格中製作出一個備份檔案的！瞭解乎？</p>

		<p>而快照還有另外一個功能，就是你可以比對 /srv/lvm 與 /srv/snapshot1 的內容，就能夠發現到最近你到底改了啥咚咚！
		這樣也是很不賴啊！您說是吧！ ^_^！接下來讓我們準備還原 vbirdlv 的內容吧！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd"># 3. 將 vbirdsnap1 卸載並移除 (因為裡面的內容已經備份起來了)</span>
[root@study ~]# <span class="term_command">umount /srv/snapshot1</span>
[root@study ~]# <span class="term_command">lvremove /dev/vbirdvg/vbirdsnap1</span>
Do you really want to remove active logical volume "vbirdsnap1"? [y/n]: <span class="term_command">y</span>
  Logical volume "vbirdsnap1" successfully removed

[root@study ~]# <span class="term_command">umount /srv/lvm</span>
[root@study ~]# <span class="term_command">mkfs.xfs -f /dev/vbirdvg/vbirdlv</span>
[root@study ~]# <span class="term_command">mount /dev/vbirdvg/vbirdlv /srv/lvm</span>
[root@study ~]# <span class="term_command">xfsrestore -f /home/lvm.dump -L lvm1 /srv/lvm</span>
[root@study ~]# <span class="term_command">ll /srv/lvm</span>
drwxr-xr-x. 131 root root 8192 Jul 28 00:12 etc
drwxr-xr-x.  16 root root 4096 Jul 28 00:01 log
<span class="term_say"># 是否與最初的內容相同啊！這就是透過快照來還原的一個簡單的方法囉！</span>
</pre></td></tr></tbody></table>

		<a id="snapshot_test"></a>
		<ul class="toplist"><li>利用快照區進行各項練習與測試的任務，再以原系統還原快照</li></ul>

		<p>換個角度來想想，<span class="text_import2">我們將原本的 vbirdlv 當作備份資料，然後將 vbirdsnap1 當作實際在運作中的資料，
		任何測試的動作都在 vbirdsnap1 這個快照區當中測試，那麼當測試完畢要將測試的資料刪除時，只要將快照區刪去即可！
		而要複製一個 vbirdlv 的系統，再作另外一個快照區即可</span>！這樣是否非常方便啊？
		這對於教學環境中每年都要幫學生製作一個練習環境主機的測試，非常有幫助呢！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		以前鳥哥老是覺得使用 LVM 的快照來進行備份不太合理，因為還要製作一個備份檔！後來仔細研究並參考徐秉義老師的教材(<a href="http://linux.vbird.org/linux_basic/0420quota.php#ps4">註4</a>)後，才發現 LVM 的快照實在是一個棒到不行的工具！尤其是在虛擬機器當中建置多份給同學使用的測試環境，
		你只要有一個基礎的環境保持住，其他的環境使用快照來提供即可。即時同學將系統搞爛了，你只要將快照區刪除，
		再重建一個快照區！這樣環境就恢復了！天吶！實在是太棒了！ ^_^
		</fieldset><br>
	<br></div><br>

	<a id="lvm_hint"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0420quota.php#top">Top</a></div>
	<h2>14.3.6 LVM 相關指令彙整與 LVM 的關閉</h2>

		<p>好了，我們將上述用過的一些指令給他彙整一下，提供給您參考參考：</p>

<table class="news" style="width: 95%">
<tbody><tr class="theader"><td style="width: 20%">任務</td><td style="width: 16%">PV 階段</td><td style="width:16%">VG 階段</td><td style="width: 20%">LV 階段</td><td colspan="2">filesystem<br>(XFS / EXT4)</td></tr>
<tr><td style="background-color: lightblue">搜尋(scan)</td><td>pvscan</td><td>vgscan</td><td>lvscan</td><td colspan="2">lsblk, blkid</td></tr>
<tr><td style="background-color: lightblue">建立(create)</td><td>pvcreate</td><td>vgcreate</td><td>lvcreate</td><td style="width: 14%">mkfs.xfs</td><td>mkfs.ext4</td></tr>
<tr><td style="background-color: lightblue">列出(display)</td><td>pvdisplay</td><td>vgdisplay</td><td>lvdisplay</td><td colspan="2">df, mount</td></tr>
<tr><td style="background-color: lightblue">增加(extend)</td><td>　</td><td>vgextend</td><td>lvextend (lvresize)</td><td>xfs_growfs</td><td>resize2fs</td></tr>
<tr><td style="background-color: lightblue">減少(reduce)</td><td>　</td><td>vgreduce</td><td>lvreduce (lvresize)</td><td>不支援</td><td>resize2fs</td></tr>
<tr><td style="background-color: lightblue">刪除(remove)</td><td>pvremove</td><td>vgremove</td><td>lvremove</td><td colspan="2">umount, 重新格式化</td></tr>
<tr><td style="background-color: lightblue">改變容量(resize)</td><td>　</td><td>　</td><td>lvresize</td><td>xfs_growfs</td><td>resize2fs</td></tr>
<tr><td style="background-color: lightblue">改變屬性(attribute)</td><td>pvchange</td><td>vgchange</td><td>lvchange</td><td colspan="2">/etc/fstab, remount</td></tr>
</tbody></table>

		<p>至於檔案系統階段 (filesystem  的格式化處理) 部分，還需要以 xfs_growfs 來修訂檔案系統實際的大小才行啊！ ^_^
		。至於雖然 LVM 可以彈性的管理你的磁碟容量，但是要注意，如果你想要使用 LVM 
		管理您的硬碟時，那麼在安裝的時候就得要做好 LVM 的規劃了，
		否則未來還是需要先以傳統的磁碟增加方式來增加後，移動資料後，才能夠進行 LVM 的使用啊！</p>

		<p>會玩 LVM 還不行！你必須要會移除系統內的 LVM 喔！因為你的實體 partition 已經被使用到 LVM 去，
		如果你還沒有將 LVM 關閉就直接將那些 partition 刪除或轉為其他用途的話，系統是會發生很大的問題的！
		所以囉，你必須要知道如何將 LVM 的裝置關閉並移除才行！會不會很難呢？其實不會啦！
		依據以下的流程來處理即可：</p>

		<ol class="text_import2">
		<li>先卸載系統上面的 LVM 檔案系統 (包括快照與所有 LV)；</li>
		<li>使用 lvremove 移除 LV ；</li>
		<li>使用 vgchange -a n VGname 讓 VGname 這個 VG 不具有 Active 的標誌；</li>
		<li>使用 vgremove 移除 VG：</li>
		<li>使用 pvremove 移除 PV；</li>
		<li>最後，使用 fdisk 修改 ID 回來啊！</li>
		</ol>

		<p>好吧！那就實際的將我們之前建立的所有 LVM 資料給刪除吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">umount /srv/lvm /srv/thin /srv/snapshot1</span>
[root@study ~]# <span class="term_command">lvs vbirdvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync 
  vbirdlv    vbirdvg -wi-a-----  2.50g
  vbirdthin1 vbirdvg Vwi-a-tz-- 10.00g vbirdtpool        4.99
  vbirdtpool vbirdvg twi-aotz--  1.00g                   49.93  1.81
<span class="term_say"># 要注意！先刪除 vbirdthin1 --&gt; vbirdtpool --&gt; vbirdlv 比較好！</span>

[root@study ~]# <span class="term_command">lvremove /dev/vbirdvg/vbirdthin1 /dev/vbirdvg/vbirdtpool</span>
[root@study ~]# <span class="term_command">lvremove /dev/vbirdvg/vbirdlv</span>
[root@study ~]# <span class="term_command">vgchange -a n vbirdvg</span>
  0 logical volume(s) in volume group "vbirdvg" now active

[root@study ~]# <span class="term_command">vgremove vbirdvg</span>
  Volume group "vbirdvg" successfully removed

[root@study ~]# <span class="term_command">pvremove /dev/vda{5,6,7,8}</span>
</pre></td></tr></tbody></table>

		<p>最後再用 <a href="http://linux.vbird.org/linux_basic/0230filesystem.php#gdisk">gdisk</a> 將磁碟的 ID 給他改回來 83 就好啦！整個過程就這樣的啦！ ^_^</p>
	<br></div>
</div>


<a id="hint"></a>
<div class="block1">
<h2>14.4 重點回顧</h2>
<ul class="text_import2">
	<li>Quota 可公平的分配系統上面的磁碟容量給使用者；分配的資源可以是磁碟容量(block)或可建立檔案數量(inode)；</li>
	<li>Quota 的限制可以有 soft/hard/grace time 等重要項目；</li>
	<li>Quota 是針對整個 filesystem 進行限制，XFS 檔案系統可以限制目錄！</li>
	<li>Quota 的使用必須要核心與檔案系統均支援。檔案系統的參數必須含有 usrquota, grpquota, prjquota</li>
	<li>Quota 的 xfs_quota 實作的指令有 report, print, limit, timer... 等指令；</li>
	<li>磁碟陣列 (RAID) 有硬體與軟體之分，Linux 作業系統可支援軟體磁碟陣列，透過 mdadm 套件來達成；</li>
	<li>磁碟陣列建置的考量依據為『容量』、『效能』、『資料可靠性』等；</li>
	<li>磁碟陣列所建置的等級常見有的 raid0, raid1, raid1+0, raid5 及 raid6</li>
	<li>硬體磁碟陣列的裝置檔名與 SCSI 相同，至於 software RAID 則為 /dev/md[0-9]</li>
	<li>軟體磁碟陣列的狀態可藉由 /proc/mdstat 檔案來瞭解；</li>
	<li>LVM 強調的是『彈性的變化檔案系統的容量』；</li>
	<li>與 LVM 有關的元件有： PV/VG/PE/LV 等元件，可以被格式化者為 LV</li>
	<li>新的 LVM 擁有 LVM thin volume 的功能，能夠動態調整磁碟的使用率！</li>
	<li>LVM 擁有快照功能，快照可以記錄 LV 的資料內容，並與原有的 LV 共享未更動的資料，備份與還原就變的很簡單；</li>
	<li>XFS 透過 xfs_growfs 指令，可以彈性的調整檔案系統的大小</li>
</ul>
</div>


<a id="ex"></a>
<div class="block1">
<h2>14.5 本章習題</h2>
( 要看答案請將滑鼠移動到『答：』底下的空白處，按下左鍵圈選空白處即可察看 )
<ul>
	<li>情境模擬題一：由於 LVM 可以彈性調整 filesystem 的大小，但是缺點是可能沒有加速與硬體備份(與快照不同)的功能。
	而磁碟陣列則具有效能與備份的功能，但是無法提供類似 LVM 的優點。在此情境中，我們想利用『<span class="text_import2">在 RAID 上面建置 LVM</span>』的功能，以達到兩者兼顧的能力。<br><br>

	<ul>
		<li>目標：測試在 RAID 磁碟上面架構 LVM 系統；</li>
		<li>需求：需要具有磁碟管理的能力，包括 RAID 與 LVM；</li>
		<li>前提：會用到本章建立出來的 /dev/vda5, /dev/vda6, /dev/vda7 三個分割槽！</li>
	</ul><br>

	那要如何處理呢？如下的流程一個步驟一個步驟的實施看看吧：<br><br>

	<ol>
	<li>重新處理系統，我們在這個練習當中，需要 /dev/vda5, /dev/vda6, /dev/vda7 建置成一個 RAID5 的 /dev/md0 磁碟！詳細的作法這裡就不談了！
		你得要使用 gdisk 來處理成為如下的模樣：<br><br>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">gdisk -l /dev/vda</span>
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048            6143   2.0 MiB     EF02
   2            6144         2103295   1024.0 MiB  0700
   3         2103296        65026047   30.0 GiB    8E00
   4        65026048        67123199   1024.0 MiB  8300  Linux filesystem
<span class="term_write">   5        67123200        69220351   1024.0 MiB  FD00  Linux RAID
   6        69220352        71317503   1024.0 MiB  FD00  Linux RAID
   7        71317504        73414655   1024.0 MiB  FD00  Linux RAID</span>
</pre></td></tr></tbody></table><br></li>

		<li>開始使用 mdadm 來建立一個簡單的 RAID5 陣列！簡易的流程如下：<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mdadm --create /dev/md0 --auto=yes  --level=5  \</span>
&gt; <span class="term_command">--raid-devices=3 /dev/vda{5,6,7}</span>
[root@study ~]# <span class="term_command">mdadm --detail /dev/md0 | grep -i uuid</span>
           UUID : efc7add0:d12ee9ca:e5cb0baa:fbdae4e6
[root@study ~]# <span class="term_command">vim /etc/mdadm.conf</span>
ARRAY /dev/md0 UUID=efc7add0:d12ee9ca:e5cb0baa:fbdae4e6
</pre></td></tr></tbody></table>

		若無出現任何錯誤訊息，此時你已經具有 /dev/md0 這個磁碟陣列裝置了！接下來讓我們處理 LVM 吧！<br><br></li>

		<li>開始處理 LVM ，現在我們假設所有的參數都使用預設值，包括 PE ，然後 VG 名為 raidvg ，LV 名為
		raidlv ，底下為基本的流程：<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">pvcreate /dev/md0                 </span> <span class="term_note">&lt;==建立 PV</span>
[root@study ~]# <span class="term_command">vgcreate raidvg /dev/md0          </span> <span class="term_note">&lt;==建立 VG</span>
[root@study ~]# <span class="term_command">lvcreate -L 1.5G -n raidlv raidvg </span> <span class="term_note">&lt;==建立 LV</span>
[root@study ~]# <span class="term_command">lvscan</span>
  ACTIVE            '/dev/raidvg/raidlv' [1.50 GiB] inherit
</pre></td></tr></tbody></table>

		這樣就搞定了 LVM 了！而且這個 LVM 是架構在 /dev/md0 上面的喔！然後就是檔案系統的建立與掛載了！<br><br></li>

		<li>嘗試建立成為 XFS 檔案系統，且掛載到 /srv/raidlvm 目錄下：<br>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">mkfs.xfs /dev/raidvg/raidlv</span>
[root@study ~]# <span class="term_command">blkid /dev/raidvg/raidlv</span>
/dev/raidvg/raidlv: UUID="4f6a587d-3257-4049-afca-7da1d405117d" TYPE="xfs"
[root@study ~]# <span class="term_command">vim /etc/fstab</span>
UUID="4f6a587d-3257-4049-afca-7da1d405117d" /srv/raidlvm xfs    defaults 0 0

[root@study ~]# <span class="term_command">mkdir /srv/raidlvm</span>
[root@study ~]# <span class="term_command">mount -a</span>
[root@study ~]# <span class="term_command">df -Th /srv/raidlvm</span>
Filesystem                Type  Size  Used Avail Use% Mounted on
/dev/mapper/raidvg-raidlv xfs   1.5G   33M  1.5G   3% /srv/raidlvm
</pre></td></tr></tbody></table><br></li>

		<li>上述就是 LVM 架構在 RAID 上面的技巧，之後的動作都能夠使用本章的其他管理方式來管理，
		包括 RAID 熱拔插機制、LVM 放大縮小機制等等。</li>
	</ol></li>
</ul>

<hr>簡答題部分：
<ul>
	<li>在前一章的<a href="http://linux.vbird.org/linux_basic/0410accountmanager.php#manual_account_1">第一個大量新增帳號範例</a>中，
	如果我想要讓每個用戶均具有 soft/hard 各為 40MB/50MB 的容量時，應該如何修改這個 script ？
	<div class="blockex">
		你得先要依據本章的作法，先將 /home 製作好 quota 的環境然後，
		你可以在 do...done 內的最後一行，新增一行內容為：<br>
		xfs_quota -x -c "limit -u bsoft=40M bhard=50M ${username}" /home<br>
		這樣就可以在製作用戶時，指定更新密碼且給予 quota 的限制！
	</div></li>

	<li>如果我想要讓 RAID 具有保護資料的功能，防止因為硬體損毀而導致資料的遺失，那我應該要選擇的 RAID 等級可能有哪些？
	(請以本章談到的等級來思考即可)
	<div class="blockex">
		具有備份資料的有： RAID-1, RAID-5, RAID-6 
	</div></li>

	<li>在預設的 LVM 設定中，請問 LVM 能否具有『備份』的功能？
	<div class="blockex">
		是有的，就是那個快照 (snopshot) 的功能，此功能即可進行資料的備份！
	</div></li>

	<li>如果你的電腦主機有提供 RAID 0 的功能，你將你的三顆硬碟全部在 BIOS 階段使用 RAID 晶片整合成為一顆大磁碟，
	則此磁碟在 Linux 系統當中的檔名為何？
	<div class="blockex">
		由於硬體磁碟陣列是在 BIOS 階段完成的，因此 Linux 系統會捉到一個完整的大的 RAID 磁碟，此磁碟的檔名就會是『 /dev/sda 』！
		但如果是 Intel 的晶片組，則還是可能會成為 /dev/md127 等相關的檔名！
	</div></li>
</ul>
</div>


<a id="reference"></a>
<div class="block1">
<h2>14.6 參考資料與延伸閱讀</h2>
<ul>
	<li><a id="ps1"></a>註1：相關的 XFS 檔案系統的 quota 說明，可以參考底下的文件：
		<ul>
		<li>XFS 官網說明：<a href="http://xfs.org/docs/xfsdocs-xml-dev/XFS_User_Guide/tmp/en-US/html/xfs-quotas.html" target="_blank">http://xfs.org/docs/xfsdocs-xml-dev/XFS_User_Guide/tmp/en-US/html/xfs-quotas.html</a></li>
		</ul></li>
	<li><a id="ps2"></a>註2：若想對 RAID 有更深入的認識，可以參考底下的連結與書目：<br>
		<a href="http://www.tldp.org/HOWTO/Software-RAID-HOWTO.html" target="_blank">http://www.tldp.org/HOWTO/Software-RAID-HOWTO.html</a><br>
		楊振和、『作業系統導論：第十一章』、學貫出版社，2006<br></li>
	<li><a id="ps3"></a>註3：詳細的 mdstat 說明也可以參考如下網頁：<br>
		<a href="https://raid.wiki.kernel.org/index.php/Mdstat" target="_blank">https://raid.wiki.kernel.org/index.php/Mdstat</a></li>
	<li><a id="ps4"></a>註4：徐秉義老師在網管人雜誌的文章，文章篇名分別是：
		<ul>
		<li>磁碟管理：SoftRAID 與 LVM 綜合實做應用 (上)</li>
		<li>磁碟管理：SoftRAID 與 LVM 綜合實做應用 (下)</li></ul>
		目前文章已經找不到了～可能需要 google 一下舊文章的備份才能看到了！</li>
</ul>
</div>


<div class="block1" style="margin-bottom: 32px; padding-left: 10px; line-height: 1">
<span class="text_history">
2002/07/14：第一次完成<br>
2003/02/10：重新編排與加入 FAQ<br>
2003/09/02：加入 <a href="http://linux.vbird.org/linux_basic/0420quota.php#quotacheck">quotacheck</a> 發生錯誤時的解決方法。<br>
2005/09/06：將舊的文章移動到 <a href="http://linux.vbird.org/linux_basic/0420quota/0420quota.php">此處</a> 。<br>
2005/09/06：進行版面風格的轉換，並且進行資料的查詢，加入 repquota 的簡單說明而已！<br>
2009/03/04：將原本舊的基於 FC4 的文件移動到 <a href="http://linux.vbird.org/linux_basic/0420quota/0420quota-fc4.php">此處</a> 。<br>
2009/03/06：加入 <a href="http://linux.vbird.org/linux_basic/0420quota.php#warnquota">warnquota</a> 這玩意兒！挺有趣的哩！<br>
2009/03/12：加入了 software RAID 與 LVM 的加強說明，尤其是 LVM 的快照 (snapshot) 的說明！<br>
2009/09/10：修改一些字樣之外，增加情境模擬，以及後續的簡答題部分題目。<br>
2012/06/14：在解釋 PE 的部分有錯誤！是 <a href="http://linux.vbird.org/linux_basic/0420quota.php#20120614">Physical Extent 而不是 Physical Extend</a> ！真抱歉！<br>
2017/03/29：將 RAID 的名稱做個修訂～感謝網友的建議。<br><br>
</span>
<span class="text_date">2002/05/06以來統計人數</span><br>
<img src="./鳥哥的 Linux 私房菜 -- 第14章、磁碟配額(Quota)與進階檔案系統管理_files/Count(3).cgi" style="height: 15px; width: 60px; " alt="計數器" title="計數器"><br>
</div>


<div class="rightarea">
<a href="http://linux.vbird.org/linux_basic/0430cron.php">&gt;&gt;</a>
</div>

<div style="position: relative; text-align:center; margin-top: -20px; margin-bottom: 40px; width: 100%;">
	<div style="width: 100px; text-align:center; display: inline-block;">
		<a href="http://linux.vbird.org/linux_basic/index.php">HOME</a>
	</div>
		<div style="width: 100px; float: left;">
		<a href="http://linux.vbird.org/linux_basic/0410accountmanager.php">PrePage</a>
	</div>
			<div style="width: 100px; float: right;">
		<a href="http://linux.vbird.org/linux_basic/0430cron.php">NextPage</a>
	</div>
	</div>

</div>	<!-- mainarea -->
</div>  <!-- tablearea -->

<div class="bottomarea">
<ul>
	<li><a href="http://linux.vbird.org/linux_basic/0420quota.php#top" title="Top">Top</a></li>
	<li><a href="http://linux.vbird.org/index_old.php" title="前往鳥哥的 Linux 私房菜首頁">前往舊站</a></li>
	<!--li><a href="http://vbird.dic.ksu.edu.tw" target="_blank" title="前往鳥哥的 Linux 私房菜首頁">簡體主站</a></li-->
	<li><a href="http://phorum.vbird.org/" target="_blank" title="鳥站新手討論板">討論板</a></li>
	<li><a href="http://phorum.study-area.org/" target="_blank" title="酷！學園討論板">酷學園</a></li>
	<li><a href="http://www.dic.ksu.edu.tw/" target="_blank" title="崑山資傳">崑山資傳</a></li>
</ul>
&nbsp;&nbsp; <a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的首頁">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="聯絡鳥哥(我不要廣告信！)">VBird</a>
		during 2001-2017. <!--a href="http://www.ksu.edu.tw" target="_blank">ksu.edu</a-->

</div>



</body></html>