<!DOCTYPE html>
<!-- saved from url=(0047)http://linux.vbird.org/linux_basic/0430cron.php -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="Author" content="VBird, 鳥哥">
	<meta name="Description" content="包括了 crontab 與 at 這兩支程式啦！">
	<title>鳥哥的 Linux 私房菜 -- 第十五章、例行性工作排程(crontab)</title>
	<style>
	</style>
	<link href="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/style_2013.css" rel="stylesheet" type="text/css">
</head>
<body>

<!--最上方的一些連結與網站介紹 -->
<div class="toparea">
<span style="text-shadow: 1px 1px 2px black;">鳥哥的 Linux 私房菜</span>
<ul>
		<li class="topareali"><a href="http://linux.vbird.org/linux_basic/0430cron.php#">第十五章、例行性工作排程(crontab)</a></li>
		<li><a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的 Linux 私房菜首頁">繁體主站</a></li>
	<li><a href="http://linux.vbird.org/linux_basic/" title="Linux 基礎學習篇，從頭學習 Linux">基礎篇</a></li>
	<li><a href="http://linux.vbird.org/linux_server/" title="Linux 伺服器架設篇">伺服器</a></li>
	<li><a href="http://linux.vbird.org/linux_enterprise/" title="Linux 企業應用篇">企業應用</a></li>
	<li><a href="http://linux.vbird.org/linux_desktop/" title="Linux 桌面應用篇">桌面應用</a></li>
	<li><a href="http://linux.vbird.org/linux_security/" title="Linux 安全管理篇">安全管理</a></li>
	<li><a href="http://linux.vbird.org/book/" title="書籍勘誤">書籍勘誤</a></li>
	<li><a href="http://linux.vbird.org/vbird/" title="關於鳥哥的一些事情">鳥哥我</a></li>
</ul>
<iframe src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/index_2013.html" style="height: 29px; width: 150px; border:0; padding:0; margin: 0;
		position: relative; float: right; overflow: hidden"></iframe>
</div>

<div class="leftarea">
<a href="http://linux.vbird.org/linux_basic/0420quota.php">&lt;&lt;</a>
</div>

<!-- 正中央的 1000 像素的內容 -->
<div class="tablearea">
<!-- 左邊的連結東東 -->
<div class="nav">
	<div style="text-align:center; line-height:1; font-size: 9pt; font-family: &#39;Times New Roman&#39;; color: #ff6600;
	padding: 5px; margin: 2px;">
		<img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/Count.cgi" alt="鳥站的上線人數統計" height="26" width="110"><br>
		since 2002/01/01
	</div>
<ul>
	<li><a href="http://linux.vbird.org/new_linux.php">新手建議</a></li>
	<li><a href="http://linux.vbird.org/howtoread.php">開始閱讀之前</a></li>
	<li><a href="http://linux.vbird.org/aboutmysite.php">網站導覽</a></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_basic">Linux 基礎文件</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/">基礎文件彙整表</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0105computers.php">0.計算機概論</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0110whatislinux.php">1.Linux是什麼</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0130designlinux.php">2.主機規劃與磁碟分割</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0157installcentos7.php">3.安裝CentOS 7.x</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0160startlinux.php">4.首次登入與man page</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0210filepermission.php">5.檔案權限與目錄配置</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0220filemanager.php">6.檔案與目錄管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0230filesystem.php">7.磁碟與檔案系統</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0240tarcompress.php">8.壓縮指令的運用</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0310vi.php">9.vim程式編輯器</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0320bash.php">10.認識與學習BASH</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0330regularex.php">11.正規表示法與文件格式化</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0340bashshell-scripts.php">12.學習shell scripts</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0410accountmanager.php">13.帳號管理與ACL</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0420quota.php">14.Quota, RAID, LVM</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php">15.at, crontab, anacron</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0440processcontrol.php">16.程序管理與 SELinux</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0560daemons.php">17.認識系統服務(daemon)</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0570syslog.php">18.認識與分析登錄檔</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0510osloader.php">19.開機流程模組管理與Loader</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0610hardware.php">20.基礎系統設定與備份策略</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0520source_code_and_tarball.php">21.原始碼與 Tarball</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0520rpm_and_srpm.php">22.RPM/YUM/SRPM</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0590xwindow.php">23.X-Window 設定</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0540kernel.php">24.Linux 核心編譯</a></li>
		<li>底下尚未更新</li>
		<li><a href="http://linux.vbird.org/linux_basic/1010index.php">27.快速索引</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/1010appendix_A.php">附錄 A: GPL 條文</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/1010appendix_B.php">附錄 B: ext2/ext3</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0140spfdisk.php">SPFDISK 範例</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0150installredhat.php">安裝 RedHat 7.2</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0155installmdk.php">安裝 Mandrake 9</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0156installfc4.php">安裝 Fedora IV</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/9999questions.php">Linux 練習題</a></li>

		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/centos5.php">CentOS 5.x(2009-2014)</a>
		</li>

		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/fc4.php">Fedora-4(2005-2008)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/mandrake9.0.php">Mandrake9.0(2001-2004)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_basic/redhat6.1/">RH6.1文件(2001前)</a>
		</li>
	</ul></li>

	<li class="nav_more"><a href="http://linux.vbird.org/linux_basic_train">Linux 基礎訓練</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic_train/">課程章節、授課方式、評分方式</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit01.php">第 01 堂課：指令列模式初探</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit02.php">第 02 堂課：指令下達與檔案管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit03.php">第 03 堂課：檔案管理與 vim</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit04.php">第 04 堂課：檔案權限與帳號管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit05.php">第 05 堂課：權限應用與程序觀察</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit06.php">第 06 堂課：基礎檔案系統管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit07.php">第 07 堂課：bash 與系統救援</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/practice1.php">期中練習</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit08.php">第 08 堂課：連續指令與資料流導向</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit09.php">第 09 堂課：正規表示法與 script</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit10.php">第 10 堂課：使用者管理與 ACL</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit11.php">第 11 堂課：基礎設定、壓縮、排程</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit12.php">第 12 堂課：管理管理與登錄檔</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit13.php">第 13 堂課：服務管理與開機流程</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit14.php">第 14 堂課：進階檔案系統管理</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/practice2.php">期末練習</a></li>
		<li><a href="http://linux.vbird.org/linux_basic_train/unit15.php">第 15 堂課：Linux系統的準備</a></li>
	</ul></li>

	<li class="nav_more"><a href="http://linux.vbird.org/linux_server/">Linux 架站文件</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_server/">伺服器篇文件彙整表</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0104mytalking.php">0. 說說笑笑談 Linux server 規劃</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0107cloudandvm.php">1. 小型雲系統與主機安全強化流程</a></li>



		<li><a href="http://linux.vbird.org/linux_server/0103introduce.php">序篇</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0105beforeserver.php">1.架設伺服器前的準備工作</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0110network_basic.php">2.基礎網路概念</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0120intranet.php">3.區域網路設定</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0130internet_connect.php">4.連上 Internet</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0140networkcommand.php">5.Linux網路指令</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0150detect_network.php">6.Linux網路偵錯</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0210network-secure.php">7.網路安全,port限制,網路升級,SELinux</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0230router.php">8.路由概念與路由器</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0250simple_firewall.php">9.防火牆與 NAT 伺服器</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0270dynamic_dns.php">10.申請合法主機名稱</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0310telnetssh.php">11.遠端連線伺服器</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0340dhcp.php">12.DHCP Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0330nfs.php">13.NFS Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0430nis.php">14.NIS Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0440ntp.php">15.NTP Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0370samba.php">16.SAMBA Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0420squid.php">17.Proxy Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0460iscsi.php">18.iSCSI Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0350dns.php">19.DNS Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0360apache.php">20.WWW Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0410vsftpd.php">21.vsFTPD Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0380mail.php">22.Mail Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0450apt.php">APT/YUM Server</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0520openwebmail.php">OpenWebMail</a></li>
		<li><a href="http://linux.vbird.org/linux_server/0600cluster.php">Cluster System</a></li>
		<li><a href="http://linux.vbird.org/linux_server/1000results.php">來做練習</a></li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/redhat6.1/">RH6.1文件(2001前)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/redhat9.php">Red Hat 9(2002-2005)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/centos4.php">CentOS 4(2006-2010)</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_server/centos5.php">CentOS 5(2010-2011)</a></li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_enterprise/">Linux 企業應用</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_enterprise/">企業應用篇彙整表</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/0110network.php">1. 區域網路軟硬體設定</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/0120installation.php">2. PXE 安裝伺服器與 kickstart</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/xen.php">Xen 虛擬機器</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/cputune.php">CPU 效能優化</a></li>
		<li><a href="http://linux.vbird.org/linux_enterprise/kerberos.php">kerberos 與 NFS 加密</a></li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_security/">Linux 安全管理</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_security/0420rkhunter.php">rkhunter 檢測</a></li>
		<li><a href="http://linux.vbird.org/linux_security/knockd.php">knockd</a></li>
		<li class="nav_more"><a href="http://linux.vbird.org/linux_security/old/">舊的安全文件</a>
		</li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/linux_desktop/">Linux 桌面應用</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_desktop/0110linuxbasic.php">Linux 基礎概念</a></li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/resources.php">鳥哥彙整的資料</a>
	<ul>
		<li><a href="http://linux.vbird.org/resources.php">Linux 資料庫</a></li>
		<li><a href="http://linux.vbird.org/problem">一些問題彙整</a></li>
		<li><a href="http://linux.vbird.org/othersites">網路連結</a></li>
		<li class="nav_more"><a href="http://linux.vbird.org/solaris/">Solaris</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/apache_packages/">Apache 套件安裝</a>
		</li>
		<li class="nav_more"><a href="http://linux.vbird.org/adsl">ADSL 相關文件</a>
		</li>
	</ul></li>
	<li class="nav_more"><a href="http://linux.vbird.org/vbird/index.php">關於鳥哥</a>
	<ul>
		<li><a href="http://linux.vbird.org/vbird/vbird3.php">Why 鳥哥?</a></li>
		<li><a href="http://linux.vbird.org/vbird/vbird.php">關於鳥哥</a></li>
		<li><a href="http://linux.vbird.org/vbird/vbird2.php">關於鳥哥-2</a></li>
		<li><a href="http://linux.vbird.org/vbird/20070718-1.php">2007-07-xx</a></li>
		<li><a href="http://linux.vbird.org/vbird/20070520.php">2007-05-20</a></li>
		<li><a href="http://linux.vbird.org/vbird/20070328.php">2007-03-28</a></li>
		<li><a href="http://linux.vbird.org/vbird/20060701.php">2006-07-01</a></li>
		<li><a href="http://linux.vbird.org/vbird/20060122.php">2006-01-24</a></li>
		<li><a href="http://linux.vbird.org/vbird/20050412.php">2005-04-12</a></li>
		<li><a href="http://linux.vbird.org/vbird/20050401.php">2005-04-01</a></li>
		<li><a href="http://linux.vbird.org/vbird/20041101.php">2004-11-01</a></li>
		<li><a href="http://linux.vbird.org/vbird/20040829.php">2004-08-29</a></li>
		<li><a href="http://linux.vbird.org/vbird/20040417.php">2004-04-17</a></li>
		<li><a href="http://linux.vbird.org/vbird/20040221.php">2004-02-21</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/somepaper">網友分享</a></li>
	<li><a href="http://linux.vbird.org/faq.php">特殊問題解決</a></li>
	<!--li><a href="/download">檔案下載中心</a></li-->
	<li><a href="http://linux.vbird.org/Searching.php">網站資料搜尋</a></li>
</ul>

<p style="text-align:center; margin: 0 0 0 0 ;">
<a href="http://jigsaw.w3.org/css-validator/check/referer" target="_blank">
<img style="border:0;width:66px;height:24px" src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/vcss-blue" alt="Valid CSS!">
</a>
<a href="http://validator.w3.org/check?uri=referer" target="_blank">
<img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/valid-html401" style="border:0;width:66px;height:24px" alt="Valid HTML 5" title="Valid HTML 5"></a>
</p>
<p style="text-align:center; margin: 0 0 0 0 ; line-height:1; font-size: 9pt;color: #333333; ">
今日 <img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/Count(1).cgi" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
昨日 <img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/yestoday.gif" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
本月 <img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/Count(2).cgi" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
上月 <img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/lastmonth.gif" style="height:12px; width:60px; vertical-align:middle;" alt="人數統計"><br>
</p>
</div>

<a id="top"></a>
<div class="mainarea">
<div class="block1">
<!-- 本文的檔頭部分 -->
<h1>第十五章、例行性工作排程(crontab)</h1>
<div style="text-align:right">
	<span class="text_history">最近更新日期：2015/07/31</span>
</div>


<!-- 本文的檔頭部分 -->
<div class="abstract">
	<p>學習了基礎篇也一陣子了，你會發現到為什麼系統常常會主動的進行一些任務？這些任務到底是誰在設定工作的？
	如果你想要讓自己設計的備份程式可以自動的在系統底下執行，而不需要手動來啟動他，又該如何處置？
	這些例行的工作可能又分為『單一』工作與『循環』工作，在系統內又是哪些服務在負責？
	還有還有，如果你想要每年在老婆的生日前一天就發出一封信件提醒自己不要忘記，可以辦的到嗎？
	嘿嘿！這些種種要如何處理，就看看這一章先！</p>
</div>


<!-- 本文的連結區部分 -->
<div class="links">
<ul>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#whatiscron">15.1 什麼是例行性工作排程</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#whatiscron_type">15.1.1 Linux 工作排程的種類： at, crontab</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#whatiscron_linux">15.1.2 CentOS Linux 系統上常見的例行性工作</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#atjob">15.2 僅執行一次的工作排程</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#atjob_how">15.2.1 atd 的啟動與 at 運作的方式</a>： <a href="http://linux.vbird.org/linux_basic/0430cron.php#at_deny">/etc/at.deny</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#atjob_work">15.2.2 實際運作單一工作排程</a>： <a href="http://linux.vbird.org/linux_basic/0430cron.php#at">at</a>,
			<a href="http://linux.vbird.org/linux_basic/0430cron.php#atq_atrm">atq &amp; atrm</a>, <a href="http://linux.vbird.org/linux_basic/0430cron.php#batch">batch</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#cron">15.3 循環執行的例行性工作排程</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#crontab_user">15.3.1 使用者的設定</a>： <a href="http://linux.vbird.org/linux_basic/0430cron.php#cron_deny">/etc/cron.deny</a>, <a href="http://linux.vbird.org/linux_basic/0430cron.php#crontab">crontab</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#etc_crontab1">15.3.2 系統的設定檔</a>： <a href="http://linux.vbird.org/linux_basic/0430cron.php#etc_crontab">/etc/crontab, /etc/cron.d/*</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#security">15.3.3 一些注意事項</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#anacron_1">15.4 可喚醒停機期間的工作任務</a>
	<ul>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#anacron_what">15.4.1 什麼是 anacron</a></li>
		<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#anacron">15.4.2 anacron 與 /etc/anacrontab</a></li>
	</ul></li>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#hint">15.5 重點回顧</a></li>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#ex">15.6 本章習題</a></li>
	<li><a href="http://phorum.vbird.org/viewtopic.php?t=23889" target="_blank">針對本文的建議：http://phorum.vbird.org/viewtopic.php?t=23889</a></li>

</ul>
</div>
</div>


<!-- 本文的正式部分 -->
<a id="whatiscron"></a>
<div class="block1">
<h2>15.1 什麼是例行性工作排程</h2>

	<p>每個人或多或少都有一些約會或者是工作，<span class="text_import2">有的工作是例行性的</span>，
	例如每年一次的加薪、每個月一次的工作報告、每週一次的午餐會報、每天需要的打卡等等；
	<span class="text_import2">有的工作則是臨時發生的</span>，例如剛好總公司有高官來訪，需要你準備演講器材等等！
	用在生活上面，例如每年的愛人的生日、每天的起床時間等等、還有突發性的 3C 用品大降價 (啊！真希望天天都有！) 
	等等囉。</p>

	<p>像上面這些例行性工作，通常你得要記錄在行事曆上面才能避免忘記！不過，由於我們常常在電腦前面的緣故，
	如果電腦系統能夠主動的通知我們的話，那麼不就輕鬆多了！嘿嘿！這個時候 Linux 的例行性工作排程就可以派上場了！
	在不考慮硬體與我們伺服器的連結狀態下，我們的 Linux 可以幫你提醒很多任務，例如：每一天早上 
	8:00 鐘要伺服器連接上音響，並啟動音樂來喚你起床；而中午
	12:00 希望 Linux 可以發一封信到你的郵件信箱，提醒你可以去吃午餐了；
	另外，在每年的你愛人生日的前一天，先發封信提醒你，以免忘記這麼重要的一天。</p>

	<p>那麼 Linux 的例行性工作是如何進行排程的呢？所謂的排程就是將這些工作安排執行的流程之意！
	咱們的 Linux 排程就是透過 crontab 與 at 這兩個東西！這兩個玩意兒有啥異同？就讓我們來瞧瞧先！</p>

	<a id="whatiscron_type"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.1.1 Linux 工作排程的種類： at, cron</h2>

		<p>從上面的說明當中，我們可以很清楚的發現兩種工作排程的方式：</p>

		<ul>
		<li>一種是例行性的，就是每隔一定的週期要來辦的事項；</li>
		<li>一種是突發性的，就是這次做完以後就沒有的那一種 ( 3C 大降價...)</li>
		</ul>

		<p>那麼在 Linux 底下如何達到這兩個功能呢？那就得使用 at 與 crontab 這兩個好東西囉！</p>

		<ul>
		<li><span class="text_import1">at</span> ：at 是個可以處理僅執行一次就結束排程的指令，不過要執行 at 時，
		必須要有 atd 這個<a href="http://linux.vbird.org/linux_basic/0560daemons.php">服務 (第十七章)</a> 的支援才行。在某些新版的 distributions 
		中，atd 可能預設並沒有啟動，那麼 at 這個指令就會失效呢！不過我們的 CentOS 預設是啟動的！<br><br></li>

		<li><span class="text_import1">crontab</span> ：crontab 這個指令所設定的工作將會循環的一直進行下去！
		可循環的時間為分鐘、小時、每週、每月或每年等。crontab 除了可以使用指令執行外，亦可編輯 /etc/crontab 來支援。
		至於讓 crontab 可以生效的服務則是 crond 這個服務喔！</li>
		</ul>

		<p>底下我們先來談一談 Linux 的系統到底在做什麼事情，怎麼有若干多的工作排程在進行呢？然後再回來談一談
		at 與 crontab 這兩個好東西！</p>
	<br></div><br>

	<a id="whatiscron_linux"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.1.2 CentOS Linux 系統上常見的例行性工作</h2>

		<p>如果你曾經使用過 Linux 一陣子了，那麼你大概會發現到 Linux 會主動的幫我們進行一些工作呢！
		比方說自動的進行線上更新 (on-line update)、自動的進行 updatedb (<a href="http://linux.vbird.org/linux_basic/0220filemanager.php#locate">第六章談到的 locate 指令</a>) 更新檔名資料庫、自動的作登錄檔分析
		(所以 root 常常會收到標題為 logwatch 的信件) 等等。這是由於系統要正常運作的話，
		某些在背景底下的工作必須要定時進行的緣故。基本上 Linux 系統常見的例行性任務有：</p>

		<ul style="padding-left: 25px">
		<li><span class="text_import2">進行登錄檔的輪替 (log rotate)</span>：<br>
		Linux 會主動的將系統所發生的各種資訊都記錄下來，這就是<a href="http://linux.vbird.org/linux_basic/0570syslog.php">登錄檔 (第十八章)</a>。
		由於系統會一直記錄登錄資訊，所以登錄檔將會越來越大！我們知道大型檔案不但佔容量還會造成讀寫效能的困擾，
		因此適時的將登錄檔資料挪一挪，讓舊的資料與新的資料分別存放，則比較可以有效的記錄登錄資訊。這就是 log rotate 
		的任務！這也是系統必要的例行任務；<br><br></li>

		<li><span class="text_import2">登錄檔分析 logwatch 的任務</span>：<br>
		如果系統發生了軟體問題、硬體錯誤、資安問題等，絕大部分的錯誤資訊都會被記錄到登錄檔中，
		因此系統管理員的重要任務之一就是分析登錄檔。但你不可能手動透過 vim 等軟體去檢視登錄檔，因為資料太複雜了！
		我們的 CentOS 提供了一隻程式『 logwatch 』來主動分析登錄資訊，所以你會發現，你的 root 老是會收到標題為 logwatch
		的信件，那是正常的！你最好也能夠看看該信件的內容喔！<br><br></li>

		<li><span class="text_import2">建立 locate 的資料庫</span>：<br>
		在第六章我們談到的 <a href="http://linux.vbird.org/linux_basic/0220filemanager.php#locate">locate</a> 指令時，
		我們知道該指令是透過已經存在的檔名資料庫來進行系統上檔名的查詢。我們的檔名資料庫是放置到 /var/lib/mlocate/ 中。
		問題是，這個資料庫怎麼會自動更新啊？嘿嘿！這就是系統的例行性工作所產生的效果啦！系統會主動的進行
		updatedb 喔！<br><br></li>

		<li><span class="text_import2">man page 查詢資料庫的建立</span>：<br>
		與 locate 資料庫類似的，可提供快速查詢的 man page db 也是個資料庫，但如果要使用 man page 資料庫時，就得要執行 mandb 才能夠建立好啊！
		而這個 man page 資料庫也是透過系統的例行性工作排程來自動執行的哩！<br><br></li>

		<li><span class="text_import2">RPM 軟體登錄檔的建立</span>：<br>
		RPM (<a href="http://linux.vbird.org/linux_basic/0520rpm_and_srpm.php">第二十二章</a>) 是一種軟體管理的機制。由於系統可能會常常變更軟體，
		包括軟體的新安裝、非經常性更新等，都會造成軟體檔名的差異。為了方便未來追蹤，系統也幫我們將檔名作個排序的記錄呢！
		有時候系統也會透過排程來幫忙 RPM 資料庫的重新建置喔！<br><br></li>

		<li><span class="text_import2">移除暫存檔</span>：<br>
		某些軟體在運作中會產生一些暫存檔，但是當這個軟體關閉時，這些暫存檔可能並不會主動的被移除。
		有些暫存檔則有時間性，如果超過一段時間後，這個暫存檔就沒有效用了，此時移除這些暫存檔就是一件重要的工作！
		否則磁碟容量會被耗光。系統透過例行性工作排程執行名為 tmpwatch 的指令來刪除這些暫存檔呢！<br><br></li>

		<li><span class="text_import2">與網路服務有關的分析行為</span>：<br>
		如果你有安裝類似 WWW 伺服器軟體 (一個名為 apache 的軟體)，那麼你的 Linux 系統通常就會主動的分析該軟體的登錄檔。
		同時某些憑證與認證的網路資訊是否過期的問題，我們的 Linux 系統也會很親和的幫你進行自動檢查！</li>
		</ul>

		<p>其實你的系統會進行的例行性工作與你安裝的軟體多寡有關，如果你安裝過多的軟體，某些服務功能的軟體都會附上分析工具，
		那麼你的系統就會多出一些例行性工作囉！像鳥哥的主機還多加了很多自己撰寫的分析工具，以及其他第三方協力軟體的分析軟體，
		嘿嘿！俺的 Linux 工作量可是非常大的哩！因為有這麼多的工作需要進行，所以我們當然得要瞭解例行性工作的處理方式囉！</p>
	<br></div><br>
</div>


<a id="atjob"></a>
<div class="block1">
<h2>15.2 僅執行一次的工作排程</h2>

	<p>首先，我們先來談談單一工作排程的運作，那就是 at 這個指令的運作！</p>

	<a id="atjob_how"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.2.1 atd 的啟動與 at 運作的方式</h2>

		<p>要使用單一工作排程時，我們的 Linux 系統上面必須要有負責這個排程的服務，那就是 atd 這個玩意兒。
		不過並非所有的 Linux distributions 都預設會把他打開的，所以呢，某些時刻我們必須要手動將他啟用才行。
		啟用的方法很簡單，就是這樣：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">systemctl restart atd</span>  <span class="term_note"># 重新啟動 atd 這個服務</span>
[root@study ~]# <span class="term_command">systemctl enable atd </span>  <span class="term_note"># 讓這個服務開機就自動啟動</span>
[root@study ~]# <span class="term_command">systemctl status atd </span>  <span class="term_note"># 查閱一下 atd 目前的狀態</span>
atd.service - Job spooling tools
   Loaded: loaded (/usr/lib/systemd/system/atd.service; <span class="term_write">enabled</span>)       <span class="term_note"># 是否開機啟動</span>
   Active: <span class="term_write">active (running)</span> since Thu 2015-07-30 19:21:21 CST; 23s ago <span class="term_note"># 是否正在運作中</span>
 Main PID: 26503 (atd)
   CGroup: /system.slice/atd.service
           └─26503 /usr/sbin/atd -f

Jul 30 19:21:21 study.centos.vbird systemd[1]: Starting Job spooling tools...
Jul 30 19:21:21 study.centos.vbird systemd[1]: Started Job spooling tools.
</pre></td></tr></tbody></table>

		<p>重點就是要看到上表中的特殊字體，包括『 enabled 』以及『 running 』時，這才是 atd 真的有在運作的意思喔！這部份我們在<a href="http://linux.vbird.org/linux_basic/0560daemons.php">第十七章</a>會談及。</p>

		<ul class="toplist"><li>at 的運作方式</li></ul>

		<p>既然是工作排程，那麼應該會有產生工作的方式，並且將這些工作排進行程表中囉！OK！那麼產生工作的方式是怎麼進行的？
		事實上，<span class="text_import2">我們使用 at 這個指令來產生所要運作的工作，並將這個工作以文字檔的方式寫入
		/var/spool/at/ 目錄內，該工作便能等待 atd 這個服務的取用與執行了</span>。就這麼簡單。</p>

		<p>不過，並不是所有的人都可以進行 at 工作排程喔！為什麼？因為安全的理由啊～
		很多主機被所謂的『綁架』後，最常發現的就是他們的系統當中多了很多的怪客程式 (cracker program)，
		這些程式非常可能運用工作排程來執行或蒐集系統資訊，並定時的回報給怪客團體！
		所以囉，除非是你認可的帳號，否則先不要讓他們使用 at 吧！那怎麼達到使用 at 的列管呢？</p>

		<a id="at_deny"></a>
		<p>我們可以利用 /etc/at.allow 與 /etc/at.deny 這兩個檔案來進行 at 的使用限制呢！
		加上這兩個檔案後， at 的工作情況其實是這樣的：</p>

		<ol class="text_import2">
		<li>先找尋 <strong>/etc/at.allow</strong> 這個檔案，寫在這個檔案中的使用者才能使用 at
		，沒有在這個檔案中的使用者則不能使用 at (即使沒有寫在 at.deny 當中)；<br><br></li>
		<li>如果 /etc/at.allow 不存在，就尋找<strong> /etc/at.deny</strong> 這個檔案，若寫在這個
		at.deny 的使用者則不能使用 at ，而沒有在這個 at.deny 檔案中的使用者，就可以使用
		at 咯；<br><br></li>
		<li>如果兩個檔案都不存在，那麼只有 root 可以使用 at 這個指令。</li>
		</ol>

		<p>透過這個說明，我們知道 /etc/at.allow 是管理較為嚴格的方式，而 /etc/at.deny 則較為鬆散 
		(因為帳號沒有在該檔案中，就能夠執行 at 了)。在一般的 distributions 當中，由於假設系統上的所有用戶都是可信任的，
		因此系統通常會保留一個空的 /etc/at.deny 檔案，意思是允許所有人使用 at 指令的意思 (您可以自行檢查一下該檔案)。
		不過，萬一你不希望有某些使用者使用 at 的話，將那個使用者的帳號寫入 /etc/at.deny 即可！
		一個帳號寫一行。</p>
	<br></div><br>

	<a id="atjob_work"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.2.2 實際運作單一工作排程</h2>

		<a id="at"></a>
		<p>單一工作排程的進行就使用 at 這個指令囉！這個指令的運作非常簡單！將 at 加上一個時間即可！基本的語法如下：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">at [-mldv] TIME</span>
[root@study ~]# <span class="term_command">at -c 工作號碼</span>
<span class="term_say">選項與參數：
-m  ：當 at 的工作完成後，即使沒有輸出訊息，亦以 email 通知使用者該工作已完成。
-l  ：at -l 相當於 atq，列出目前系統上面的所有該使用者的 at 排程；
-d  ：at -d 相當於 atrm ，可以取消一個在 at 排程中的工作；
-v  ：可以使用較明顯的時間格式列出 at 排程中的工作列表；
-c  ：可以列出後面接的該項工作的實際指令內容。

TIME：時間格式，這裡可以定義出『什麼時候要進行 at 這項工作』的時間，格式有：
  HH:MM				ex&gt; 04:00
	在今日的 HH:MM 時刻進行，若該時刻已超過，則明天的 HH:MM 進行此工作。
  HH:MM YYYY-MM-DD		ex&gt; 04:00 2015-07-30
	強制規定在某年某月的某一天的特殊時刻進行該工作！
  HH:MM[am|pm] [Month] [Date]	ex&gt; 04pm July 30
	也是一樣，強制在某年某月某日的某時刻進行！
  HH:MM[am|pm] + number [minutes|hours|days|weeks]
	ex&gt; now + 5 minutes	ex&gt; 04pm + 3 days
	就是說，在某個時間點『再加幾個時間後』才進行。</span>
</pre></td></tr></tbody></table>

		<p>老實說，這個 at 指令的下達最重要的地方在於『時間』的指定了！鳥哥喜歡使用『 now + ... 』
		的方式來定義現在過多少時間再進行工作，但有時也需要定義特定的時間點來進行！底下的範例先看看囉！</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd">範例一：再過五分鐘後，將 /root/.bashrc 寄給 root 自己</span>
[root@study ~]# <span class="term_command">at now + 5 minutes</span>  <span class="term_note">&lt;==記得單位要加 s 喔！</span>
at&gt; <span class="term_command">/bin/mail -s "testing at job" root &lt; /root/.bashrc</span>
at&gt; &lt;EOT&gt;   <span class="term_note">&lt;==這裡輸入 [ctrl] + d 就會出現 &lt;EOF&gt; 的字樣！代表結束！</span>
job 2 at Thu Jul 30 19:35:00 2015
<span class="term_say"># 上面這行資訊在說明，第 2 個 at 工作將在 2015/07/30 的 19:35 進行！
# 而執行 at 會進入所謂的 at shell 環境，讓你下達多重指令等待運作！</span>

<span class="term_hd">範例二：將上述的第 2 項工作內容列出來查閱</span>
[root@study ~]# <span class="term_command">at -c 2</span>
#!/bin/sh               <span class="term_note">&lt;==就是透過 bash shell 的啦！</span>
# atrun uid=0 gid=0
# mail root 0
umask 22
<span class="term_say">....(中間省略許多的環境變數項目)....</span>
cd /etc/cron\.d || {
         echo 'Execution directory inaccessible' &gt;&amp;2
         exit 1
}
<span class="term_write">${SHELL:-/bin/sh} &lt;&lt; 'marcinDELIMITER410efc26'
/bin/mail -s "testing at job" root &lt; /root/.bashrc    <span class="term_note"># 這一行最重要！</span>
marcinDELIMITER410efc26</span>
<span class="term_say"># 你可以看到指令執行的目錄 (/root)，還有多個環境變數與實際的指令內容啦！</span>

<span class="term_hd">範例三：由於機房預計於 2015/08/05 停電，我想要在 2015/08/04 23:00 關機？</span>
[root@study ~]# <span class="term_command">at 23:00 2015-08-04</span>
at&gt; <span class="term_write">/bin/sync</span>
at&gt; <span class="term_write">/bin/sync</span>
at&gt; <span class="term_write">/sbin/shutdown -h now</span>
at&gt; &lt;EOT&gt;
job 3 at Tue Aug  4 23:00:00 2015
<span class="term_say"># 您瞧瞧！ at 還可以在一個工作內輸入多個指令呢！不錯吧！</span>
</pre></td></tr></tbody></table>

		<p>事實上，當我們使用 at 時會進入一個 at shell 的環境來讓使用者下達工作指令，此時，<span class="text_import2">建議你最好使用絕對路徑來下達你的指令，比較不會有問題喔</span>！由於指令的下達與 PATH 變數有關，
		同時與當時的工作目錄也有關連 (如果有牽涉到檔案的話)，因此使用絕對路徑來下達指令，會是比較一勞永逸的方法。
		為什麼呢？舉例來說，你在 /tmp 下達『 at now 』然後輸入『 mail -s "test" root &lt; .bashrc 』，
		問一下，那個 .bashrc 的檔案會是在哪裡？答案是『 /tmp/.bashrc 』！因為<span class="text_import2">
		at 在運作時，會跑到當時下達 at 指令的那個工作目錄</span>的緣故啊！</p>

		<p>有些朋友會希望『我要在某某時刻，在我的終端機顯示出 Hello 的字樣』，然後就在 at 裡面下達這樣的資訊『
		echo "Hello" 』。等到時間到了，卻發現沒有任何訊息在螢幕上顯示，這是啥原因啊？<span class="text_import2">這是因為 at 的執行與終端機環境無關，而所有 standard output/standard error output
		都會傳送到執行者的 mailbox 去</span>啦！所以在終端機當然看不到任何資訊。那怎辦？沒關係，
		可以透過終端機的裝置來處理！假如你在 tty1 登入，則可以使用『 echo "Hello" &gt; /dev/tty1 』來取代。</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		要注意的是，如果在 at shell 內的指令並沒有任何的訊息輸出，那麼 at 預設不會發 email 給執行者的。
		如果你想要讓 at 無論如何都發一封 email 告知你是否執行了指令，那麼可以使用『 at -m 時間格式 』來下達指令喔！
		at 就會傳送一個訊息給執行者，而不論該指令執行有無訊息輸出了！
		</fieldset><br>
		<p>at 有另外一個很棒的優點，那就是『背景執行』的功能了！什麼是背景執行啊？很難瞭解嗎？其實與 bash 的 nohup 
		(<a href="http://linux.vbird.org/linux_basic/0440processcontrol.php#nohup">第十六章</a>) 類似啦！
		鳥哥提我自己的幾個例子來給您聽聽，您就瞭了！</p>

		<ul>
		<li><span class="text_import2">離線繼續工作的任務</span>：鳥哥初次接觸 Unix 為的是要跑空氣品質模式，
		那是一種大型的程式，這個程式在當時的硬體底下跑，一個案例要跑 3 天！由於鳥哥也要進行其他研究工作，因此常常使用 Windows
		98 (你沒看錯！鳥哥是老人...) 來連線到 Unix 工作站跑那個 3 天的案例！結果你也該知道， Windows 98 連開三天而不當機的機率是很低的～@_@～
		而當機時，所有在 Windows 上的連線都會中斷！包括鳥哥在跑的那個程式也中斷了～嗚嗚～明明再三個鐘頭就跑完的程式，
		由於當機害我又得跑 3 天！<br><br></li>

		<li>另一個常用的時刻則是例如上面的範例三，由於某個突發狀況導致你必須要進行某項工作時，這個 at 就很好用啦！</li>
		</ul>

		<p><span class="text_import2">由於 at 工作排程的使用上，系統會將該項 at 工作獨立出你的 bash 環境中，
		直接交給系統的 atd 程式來接管，因此，當你下達了 at 的工作之後就可以立刻離線了，
		剩下的工作就完全交給 Linux 管理即可</span>！所以囉，如果有長時間的網路工作時，嘿嘿！
		使用 at 可以讓你免除網路斷線後的困擾喔！ ^_^</p>

		<a id="atq_atrm"></a>
		<ul class="toplist"><li>at 工作的管理</li></ul>

		<p>那麼萬一我下達了 at 之後，才發現指令輸入錯誤，該如何是好？就將他移除啊！利用 atq 與 atrm 吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">atq</span>
[root@study ~]# <span class="term_command">atrm (jobnumber)</span>

<span class="term_hd">範例一：查詢目前主機上面有多少的 at 工作排程？</span>
[root@study ~]# <span class="term_command">atq</span>
3       Tue Aug  4 23:00:00 2015 a root
<span class="term_say"># 上面說的是：『在 2015/08/04 的 23:00 有一項工作，該項工作指令下達者為 
# root』而且，該項工作的工作號碼 (jobnumber) 為 3 號喔！</span>

<span class="term_hd">範例二：將上述的第 3 個工作移除！</span>
[root@study ~]# <span class="term_command">atrm 3</span>
[root@study ~]# <span class="term_command">atq</span>
<span class="term_say"># 沒有任何資訊，表示該工作被移除了！</span>
</pre></td></tr></tbody></table>

		<p>如此一來，你可以利用 atq 來查詢，利用 atrm 來刪除錯誤的指令，利用 at 來直接下達單一工作排程！很簡單吧！
		不過，有個問題需要處理一下。<span class="text_import2">如果你是在一個非常忙碌的系統下運作 at ，
		能不能指定你的工作在系統較閒的時候才進行</span>呢？可以的，那就使用 batch 指令吧！</p>

		<a id="batch"></a>
		<ul class="toplist"><li>batch：系統有空時才進行背景任務</li></ul>

		<p>其實 batch 是利用 at 來進行指令的下達啦！只是加入一些控制參數而已。這個 batch 神奇的地方在於：<span class="text_import2">他會在 CPU 的工作負載小於 0.8 的時候，才進行你所下達的工作任務</span>啦！
		那什麼是工作負載 0.8 呢？這個工作負載的意思是： CPU 在單一時間點所負責的工作數量。不是 CPU 的使用率喔！
		舉例來說，如果我有一隻程式他需要一直使用 CPU 的運算功能，那麼此時 CPU 的使用率可能到達 100% ，
		但是 CPU 的工作負載則是趨近於『 1 』，因為 CPU 僅負責一個工作嘛！如果同時執行這樣的程式兩支呢？
		CPU 的使用率還是 100% ，但是工作負載則變成 2 了！瞭解乎？</p>

		<p>所以也就是說，當 CPU 的工作負載越大，代表 CPU 必須要在不同的工作之間進行頻繁的工作切換。
		這樣的 CPU 運作情況我們在第零章有談過，忘記的話請回去瞧瞧！因為一直切換工作，所以會導致系統忙碌啊！
		系統如果很忙碌，還要額外進行 at ，不太合理！所以才有 batch 指令的產生！</p>

		<p>在 CentOS 7 底下的 batch 已經不再支援時間參數了，因此 batch 可以拿來作為判斷是否要立刻執行背景程式的依據！
		我們底下來實驗一下 batch 好了！為了產生 CPU 較高的工作負載，因此我們用了 12 章裡面計算 pi 的腳本，連續執行 4 次這隻程式，
		來模擬高負載，然後來玩一玩 batch 的工作現象：</p>

<table class="term"><tbody><tr><td class="term"><pre><span class="term_hd">範例一：請執行 pi 的計算，然後在系統閒置時，執行 updatdb 的任務</span>
[root@study ~]# <span class="term_command">echo "scale=100000; 4*a(1)" | bc -lq &amp;</span>
[root@study ~]# <span class="term_command">echo "scale=100000; 4*a(1)" | bc -lq &amp;</span>
[root@study ~]# <span class="term_command">echo "scale=100000; 4*a(1)" | bc -lq &amp;</span>
[root@study ~]# <span class="term_command">echo "scale=100000; 4*a(1)" | bc -lq &amp;</span>
<span class="term_say"># 然後等待個大約數十秒的時間，之後再來確認一下工作負載的情況！</span>
[root@study ~]# <span class="term_command">uptime</span>
 19:56:45 up 2 days, 19:54,  2 users,  <span class="term_write">load average: 3.93, 2.23, 0.96</span>

[root@study ~]# <span class="term_command">batch</span>
at&gt; <span class="term_command">/usr/bin/updatedb</span>
at&gt; &lt;EOT&gt;
job 4 at Thu Jul 30 19:57:00 2015

[root@study ~]# <span class="term_command">date;atq</span>
Thu Jul 30 19:57:47 CST 2015
4       Thu Jul 30 19:57:00 2015 b root
<span class="term_say"># 可以看得到，明明時間已經超過了，卻沒有實際執行 at 的任務！</span>

[root@study ~]# <span class="term_command">jobs</span>
[1]   Running                 echo "scale=100000; 4*a(1)" | bc -lq &amp;
[2]   Running                 echo "scale=100000; 4*a(1)" | bc -lq &amp;
[3]-  Running                 echo "scale=100000; 4*a(1)" | bc -lq &amp;
[4]+  Running                 echo "scale=100000; 4*a(1)" | bc -lq &amp;
[root@study ~]# <span class="term_command">kill -9 %1 %2 %3 %4</span>
<span class="term_say"># 這時先用 jobs 找出背景工作，再使用 kill 刪除掉四個背景工作後，慢慢等待工作負載的下降</span>

[root@study ~]# <span class="term_command">uptime; atq</span>
 20:01:33 up 2 days, 19:59,  2 users,  load average: 0.89, 2.29, 1.40
4       Thu Jul 30 19:57:00 2015 b root
[root@study ~]# <span class="term_command">uptime; atq</span>
 20:02:52 up 2 days, 20:01,  2 users,  load average: 0.23, 1.75, 1.28
<span class="term_say"># 在 19:59 時，由於 loading 還是高於 0.8，因此 atq 可以看得到 at job 還是持續再等待當中喔！
# 但是到了 20:01 時， loading 降低到 0.8 以下了，所以 atq 就執行完畢囉！</span>
</pre></td></tr></tbody></table>

		<p>使用 uptime 可以觀察到 1, 5, 15 分鐘的『平均工作負載』量，因為是平均值，所以當我們如上表刪除掉四個工作後，工作負載不會立即降低，
		需要一小段時間讓這個 1 分鐘平均值慢慢回復到接近 0 啊！當小於 0.8 之後的『整分鐘時間』時，atd 就會將 batch 的工作執行掉了！</p>

		<p>什麼是『整分鐘時間』呢？不論是 at 還是底下要介紹的 crontab，他們最小的時間單位是『分鐘』，所以，基本上，他們的工作是『每分鐘檢查一次』來處理的！
		就是整分 (秒為 0 的時候)，這樣瞭解乎？同時，你會發現其實 batch 也是使用 atq/atrm 來管理的！</p>
	<br></div>
</div>


<a id="cron"></a>
<div class="block1">
<h2>15.3 循環執行的例行性工作排程</h2>

	<p>相對於 at 是僅執行一次的工作，<span class="text_import2">循環執行的例行性工作排程則是由 cron (crond)
	這個系統服務來控制的</span>。剛剛談過 Linux 系統上面原本就有非常多的例行性工作，因此這個系統服務是預設啟動的。另外，
	由於使用者自己也可以進行例行性工作排程，所以囉， Linux 也提供使用者控制例行性工作排程的指令 (crontab)。
	底下我們分別來聊一聊囉！</p>

	<a id="crontab_user"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.3.1 使用者的設定</h2>

		<a id="cron_deny"></a>
		<p>使用者想要建立循環型工作排程時，使用的是 crontab 這個指令啦～不過，為了安全性的問題，
		與 at 同樣的，我們可以限制使用 crontab 的使用者帳號喔！使用的限制資料有：</p>

		<ul>
		<li><span class="text_import2">/etc/cron.allow</span>：<br>
		將可以使用 crontab 的帳號寫入其中，若不在這個檔案內的使用者則不可使用 crontab；<br><br></li>

		<li><span class="text_import2">/etc/cron.deny</span>：<br>
		將不可以使用 crontab 的帳號寫入其中，若未記錄到這個檔案當中的使用者，就可以使用 crontab 。</li></ul>

		<p>與 at 很像吧！同樣的，以優先順序來說， /etc/cron.allow 比 /etc/cron.deny 要優先，
		而判斷上面，這兩個檔案只選擇一個來限制而已，因此，建議你只要保留一個即可，
		免得影響自己在設定上面的判斷！一般來說，系統預設是保留 /etc/cron.deny ，
		你可以將不想讓他執行 crontab 的那個使用者寫入 /etc/cron.deny 當中，一個帳號一行！</p>

		<p><span class="text_import2">當使用者使用 crontab 這個指令來建立工作排程之後，該項工作就會被紀錄到 /var/spool/cron/ 
		裡面去了，而且是以帳號來作為判別的喔</span>！舉例來說， dmtsai 使用 crontab 後，
		他的工作會被紀錄到 /var/spool/cron/dmtsai 裡頭去！但請注意，<span class="text_import2">不要使用 vi 直接編輯該檔案，
		因為可能由於輸入語法錯誤，會導致無法執行 cron 喔</span>！另外， cron 執行的每一項工作都會被紀錄到
		/var/log/cron 這個登錄檔中，所以囉，如果你的 Linux 不知道有否被植入木馬時，也可以搜尋一下 /var/log/cron 
		這個登錄檔呢！</p>

		<a id="crontab"></a>
		<p>好了，那麼我們就來聊一聊 crontab 的語法吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">crontab [-u username] [-l|-e|-r]</span>
<span class="term_say">選項與參數：
-u  ：只有 root 才能進行這個任務，亦即幫其他使用者建立/移除 crontab 工作排程；
-e  ：編輯 crontab 的工作內容
-l  ：查閱 crontab 的工作內容
-r  ：移除所有的 crontab 的工作內容，若僅要移除一項，請用 -e 去編輯。</span>

<span class="term_hd">範例一：用 dmtsai 的身份在每天的 12:00 發信給自己</span>
[dmtsai@study ~]$ <span class="term_command">crontab -e</span>
<span class="term_say"># 此時會進入 vi 的編輯畫面讓您編輯工作！注意到，每項工作都是一行。</span>
<span class="term_write">0   12  *  *  * mail -s "at 12:00" dmtsai &lt; /home/dmtsai/.bashrc</span>
<span class="term_say">#分 時 日 月 週 |&lt;==============指令串========================&gt;|</span>
</pre></td></tr></tbody></table>

		<p>預設情況下，任何使用者只要不被列入 /etc/cron.deny 當中，那麼他就可以直接下達『 crontab -e 
		』去編輯自己的例行性命令了！整個過程就如同上面提到的，會進入 vi 的編輯畫面，
		然後以一個工作一行來編輯，編輯完畢之後輸入『 :wq 』儲存後離開 vi 就可以了！
		而每項工作 (每行) 的格式都是具有六個欄位，這六個欄位的意義為：</p>

<table class="news" style="width: 95%">
<tbody><tr class="theader"><td style="width: 90px">代表意義</td><td style="width: 70px">分鐘</td><td style="width: 70px">小時</td>
	<td style="width: 70px">日期</td><td style="width: 70px">月份</td><td style="width: 70px">週</td><td>指令</td></tr>
<tr class="tcenter"><td style="background-color: lightblue">數字範圍</td><td>0-59</td><td>0-23</td><td>1-31</td><td>1-12</td><td>0-7</td>
	<td>呀就指令啊</td></tr>
</tbody></table>

		<p>比較有趣的是那個『週』喔！週的數字為 0 或 7 時，都代表『星期天』的意思！另外，還有一些輔助的字符，大概有底下這些：</p>

<table class="news" style="width: 95%">
<tbody><tr class="theader"><td style="width: 70px">特殊字符</td><td>代表意義</td></tr>
<tr><td class="tcenter">*(星號)</td><td>代表任何時刻都接受的意思！舉例來說，範例一內那個日、月、週都是 * ，
	就代表著『不論何月、何日的禮拜幾的 12:00 都執行後續指令』的意思！</td></tr>
<tr><td class="tcenter">,(逗號)</td><td>代表分隔時段的意思。舉例來說，如果要下達的工作是 3:00 與 6:00 時，就會是：
	<blockquote class="text_import2" style="font-family: &#39;細明體&#39;; margin-top: 5px; margin-bottom: 5px;">0 3,6 * * * command</blockquote>
	時間參數還是有五欄，不過第二欄是 3,6 ，代表 3 與 6 都適用！</td></tr>
<tr><td class="tcenter">-(減號)</td><td>代表一段時間範圍內，舉例來說， 8 點到 12 點之間的每小時的 20 分都進行一項工作：
	<blockquote class="text_import2" style="font-family: &#39;細明體&#39;; margin-top: 5px; margin-bottom: 5px;">20 8-12 * * * command</blockquote>
	仔細看到第二欄變成 8-12 喔！代表 8,9,10,11,12 都適用的意思！</td></tr>
<tr><td class="tcenter">/n(斜線)</td><td>那個 n 代表數字，亦即是『每隔 n 單位間隔』的意思，例如每五分鐘進行一次，則：<br>
	<blockquote class="text_import2" style="font-family: &#39;細明體&#39;; margin-top: 5px; margin-bottom: 5px;">*/5 * * * * command</blockquote>
	很簡單吧！用 * 與 /5 來搭配，也可以寫成 0-59/5 ，相同意思！</td></tr>
</tbody></table>

		<p>我們就來搭配幾個例子練習看看吧！底下的案例請實際用 dmtsai 
		這個身份作看看喔！後續的動作才能夠搭配起來！</p>

<table class="exam" style="width: 90%"><tbody><tr><td>
例題：<div>
假若你的女朋友生日是 5 月 2 日，你想要在 5 月 1 日的 23:59 發一封信給他，這封信的內容已經寫在
/home/dmtsai/lover.txt 內了，該如何進行？
</div>
答：<div>
直接下達 crontab -e 之後，編輯成為：<blockquote class="text_import2" style="font-family: &#39;細明體&#39;">
59 23 1 5  *  mail kiki &lt; /home/dmtsai/lover.txt</blockquote>
那樣的話，每年 kiki 都會收到你的這封信喔！（當然囉，信的內容就要每年變一變啦！）
</div>
</td></tr></tbody></table><br>

<table class="exam" style="width: 90%"><tbody><tr><td>
例題：<div>
假如每五分鐘需要執行  /home/dmtsai/test.sh 一次，又該如何？
</div>
答：<div>
同樣使用 crontab -e 進入編輯：<blockquote class="text_import2" style="font-family:&#39;細明體&#39;">
*/5 * * * * /home/dmtsai/test.sh</blockquote>
</div>
</td></tr></tbody></table>

		<p>那個 crontab 每個人都只有一個檔案存在，就是在 /var/spool/cron 裡面啊！
		還有建議您：『<span class="text_import2">指令下達時，最好使用絕對路徑，這樣比較不會找不到執行檔喔</span>！』</p>

<table class="exam" style="width: 90%"><tbody><tr><td>
例題：<div>
假如你每星期六都與朋友有約，那麼想要每個星期五下午 4:30 告訴你朋友星期六的約會不要忘記，則：
</div>
答：<div>
還是使用 crontab -e 啊！<blockquote class="text_import2">
30 16 * * 5 mail friend@his.server.name &lt; /home/dmtsai/friend.txt</blockquote>
</div>
</td></tr></tbody></table>

		<p>真的是很簡單吧！呵呵！那麼，該如何查詢使用者目前的 crontab 內容呢？我們可以這樣來看看：</p>

<table class="term"><tbody><tr><td class="term"><pre>[dmtsai@study ~]$ <span class="term_command">crontab -l</span>
0 12 * * * mail -s "at 12:00" dmtsai &lt; /home/dmtsai/.bashrc
59 23 1 5 * mail kiki &lt; /home/dmtsai/lover.txt
*/5 * * * * /home/dmtsai/test.sh
30 16 * * 5 mail friend@his.server.name &lt; /home/dmtsai/friend.txt

<span class="term_say"># 注意，若僅想要移除一項工作而已的話，必須要用 crontab -e 去編輯～
# 如果想要全部的工作都移除，才使用 crontab -r 喔！</span>
[dmtsai@study ~]$ <span class="term_command">crontab -r</span>
[dmtsai@study ~]$ <span class="term_command">crontab -l</span>
no crontab for dmtsai
</pre></td></tr></tbody></table>

		<p>看到了嗎？ crontab 『整個內容都不見了！』所以請注意：『如果只是要刪除某個 crontab 的工作項目，那麼請使用 crontab -e 來重新編輯即可！』如果使用 -r 的參數，是會將所有的 
		crontab 資料內容都刪掉的！千萬注意了！</p>
	<br></div><br>

	<a id="etc_crontab1"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.3.2 系統的設定檔： /etc/crontab, /etc/cron.d/*</h2>

		<p>這個『 crontab -e 』是針對使用者的 cron 來設計的，如果是『系統的例行性任務』時，
		該怎麼辦呢？是否還是需要以 crontab -e 來管理你的例行性工作排程呢？當然不需要，你只要編輯
		<span class="text_import2">/etc/crontab</span> 這個檔案就可以啦！有一點需要特別注意喔！那就是
		crontab -e 這個 crontab 其實是 /usr/bin/crontab 這個執行檔，但是 /etc/crontab
		可是一個『純文字檔』喔！你可以 root 的身份編輯一下這個檔案哩！</p>

		<p>基本上，<span class="text_import2"> cron 這個服務的最低偵測限制是『分鐘』，所以『 cron
		會每分鐘去讀取一次 /etc/crontab 與 /var/spool/cron 裡面的資料內容</span>
		』，因此，只要你編輯完 /etc/crontab 這個檔案，並且將他儲存之後，那麼 
		cron 的設定就自動的會來執行了！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		在 Linux 底下的 crontab 會自動的幫我們每分鐘重新讀取一次 /etc/crontab 
		的例行工作事項，但是某些原因或者是其他的 Unix 系統中，由於 crontab 
		是讀到記憶體當中的，所以在你修改完 /etc/crontab 之後，可能並不會馬上執行，
		這個時候請重新啟動 crond 這個服務吧！『systemctl restart crond』
		</fieldset><br>
		<a id="etc_crontab"></a>
		<p>廢話少說，我們就來看一下這個 /etc/crontab 的內容吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">cat /etc/crontab</span>
SHELL=/bin/bash                     <span class="term_note">&lt;==使用哪種 shell 介面</span>
PATH=/sbin:/bin:/usr/sbin:/usr/bin  <span class="term_note">&lt;==執行檔搜尋路徑</span>
MAILTO=root                         <span class="term_note">&lt;==若有額外STDOUT，以 email將資料送給誰</span>

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed
</pre></td></tr></tbody></table>

		<p>看到這個檔案的內容你大概就瞭解了吧！呵呵，沒錯！這個檔案與將剛剛我們下達 crontab -e 的內容幾乎完全一模一樣！只是有幾個地方不太相同：</p>

		<div class="illus">

		<ul><li>MAILTO=root：</li></ul>

		<p>這個項目是說，當 /etc/crontab 這個檔案中的例行性工作的指令發生錯誤時，或者是該工作的執行結果有 
		STDOUT/STDERR 時，會將錯誤訊息或者是螢幕顯示的訊息傳給誰？預設當然是由系統直接寄發一封 mail 給 root 啦！不過，
		由於 root 並無法在用戶端中以 POP3 之類的軟體收信，因此，鳥哥通常都將這個 e-mail 
		改成自己的帳號，好讓我隨時瞭解系統的狀況！例如：
		<span class="text_import2">MAILTO=dmtsai@my.host.name</span></p>

		<ul><li>PATH=....：</li></ul>

		<p>還記得我們在<a href="http://linux.vbird.org/linux_basic/0320bash.php#env">第十章的 BASH</a> 當中一直提到的執行檔路徑問題吧！
		沒錯啦！這裡就是輸入執行檔的搜尋路徑！使用預設的路徑設定就已經很足夠了！</p>

		<ul><li>『分 時 日 月 周 身份 指令』七個欄位的設定</li></ul>

		<p>這個 /etc/crontab 裡面可以設定的基本語法與 crontab -e 不太相同喔！前面同樣是分、時、日、月、周五個欄位，
		但是在五個欄位後面接的並不是指令，而是一個新的欄位，那就是『<span class="text_import2">執行後面那串指令的身份</span>』為何！這與使用者的 crontab -e 不相同。由於使用者自己的 
		crontab 並不需要指定身份，但 /etc/crontab 裡面當然要指定身份啦！以上表的內容來說，系統預設的例行性工作是以 root
		的身份來進行的。</p>

		</div>

		<ul class="toplist"><li>crond 服務讀取設定檔的位置</li></ul>

		<p>一般來說，crond 預設有三個地方會有執行腳本設定檔，他們分別是：</p>

		<ul class="text_import2">
		<li>/etc/crontab</li>
		<li>/etc/cron.d/*</li>
		<li>/var/spool/cron/*</li>
		</ul>

		<p>這三個地方中，跟系統的運作比較有關係的兩個設定檔是放在 /etc/crontab 檔案內以及 /etc/cron.d/* 目錄內的檔案，
		另外一個是跟用戶自己的工作比較有關的設定檔，就是放在 /var/spool/cron/ 裡面的檔案群。
		現在我們已經知道了 /var/spool/cron 以及 /etc/crontab 的內容，那現在來瞧瞧 /etc/cron.d 裡面的東西吧！</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">ls -l /etc/cron.d</span>
-rw-r--r--. 1 root root 128 Jul 30  2014 0hourly
-rw-r--r--. 1 root root 108 Mar  6 10:12 raid-check
-rw-------. 1 root root 235 Mar  6 13:45 sysstat
-rw-r--r--. 1 root root 187 Jan 28  2014 unbound-anchor
<span class="term_say"># 其實說真的，除了 /etc/crontab 之外，crond 的設定檔還不少耶！上面就有四個設定！
# 先讓我們來瞧瞧 0hourly 這個設定檔的內容吧！</span>

[root@study ~]# <span class="term_command">cat /etc/cron.d/0hourly</span>
# Run the hourly jobs
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
<span class="term_write">01 * * * * root run-parts /etc/cron.hourly</span>
<span class="term_say"># 瞧一瞧，內容跟 /etc/crontab 幾乎一模一樣！但實際上是有設定值喔！就是最後一行！</span>
</pre></td></tr></tbody></table>

		<p>如果你想要自己開發新的軟體，該軟體要擁有自己的 crontab 定時指令時，就可以將『分、時、日、月、周、身份、指令』的設定檔放置到 /etc/cron.d/ 目錄下！
		在此目錄下的檔案是『crontab 的設定檔腳本』。</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		以鳥哥來說，現在鳥哥有在開發一些虛擬化教室的軟體，該軟體需要定時清除一些垃圾防火牆規則，
		那鳥哥就是將要執行的時間與指令設計好，然後直接將設定寫入到 /etc/cron.d/newfile 即可！未來如果這個軟體要升級，
		直接將該檔案覆蓋成新檔案即可！比起手動去分析 /etc/crontab 要單純的多！
		</fieldset><br>
		<p>另外，請注意一下上面表格中提到的最後一行，每個整點的一分會執行『 run-parts /etc/cron.hourly 』這個指令～咦！那什麼是 run-parts 呢？
		如果你有去分析一下這個執行檔，會發現他就是 shell script，<span class="text_import2">run-parts 腳本會在大約 5 分鐘內隨機選一個時間來執行 
		/etc/cron.hourly 目錄內的所有執行檔！因此，放在 /etc/cron.hourly/ 的檔案，必須是能被直接執行的指令腳本，
		而不是分、時、日、月、周的設定值喔</span>！注意注意！</p>

		<p>也就是說，除了自己指定分、時、日、月、周加上指令路徑的 crond 設定檔之外，你也可以直接將指令放置到(或連結到)/etc/cron.hourly/ 目錄下，
		則該指令就會被 crond 在每小時的 1 分開始後的 5 分鐘內，隨機取一個時間點來執行囉！你無須手動去指定分、時、日、月、周就是了。</p>

		<p>但是眼尖的朋友可能還會發現，除了可以直接將指令放到 /etc/cron.hourly/ 讓系統每小時定時執行之外，在 /etc/ 底下其實還有
		/etc/cron.daily/, /etc/cron.weekly/, /etc/cron.monthly/，那三個目錄是代表每日、每週、每月各執行一次的意思嗎？嘿嘿！
		厲害喔！沒錯～是這樣～不過，跟 /etc/cron.hourly/ 不太一樣的是，那三個目錄是由 anacron 所執行的，而 anacron 的執行方式則是放在 
		/etc/cron.hourly/0anacron 裡面耶～跟前幾代 anacron 是單獨的 service 不太一樣喔！這部份留待下個小節再來討論。</p>

		<p>最後，讓我們總結一下吧：</p>

		<ul>
		<li>個人化的行為使用『 crontab -e 』：如果你是依據個人需求來建立的例行工作排程，建議直接使用 crontab -e 來建立你的工作排程較佳！
		這樣也能保障你的指令行為不會被大家看到 (/etc/crontab 是大家都能讀取的權限喔！)；</li>
		<li style="margin-top: 10px">系統維護管理使用『 vim /etc/crontab 』：如果你這個例行工作排程是系統的重要工作，為了讓自己管理方便，同時容易追蹤，建議直接寫入 /etc/crontab 較佳！</li>
		<li style="margin-top: 10px">自己開發軟體使用『 vim /etc/cron.d/newfile 』：如果你是想要自己開發軟體，那當然最好就是使用全新的設定檔，並且放置於 /etc/cron.d/ 目錄內即可。</li>
		<li style="margin-top: 10px">固定每小時、每日、每週、每天執行的特別工作：如果與系統維護有關，還是建議放置到 /etc/crontab 中來集中管理較好。
		如果想要偷懶，或者是一定要再某個週期內進行的任務，也可以放置到上面談到的幾個目錄中，直接寫入指令即可！</li>
		</ul>

	<br></div><br>

	<a id="security"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.3.3 一些注意事項</h2>

		<p>有的時候，我們以系統的 cron 來進行例行性工作的建立時，要注意一些使用方面的特性。
		舉例來說，如果我們有四個工作都是五分鐘要進行一次的，那麼是否這四個動作全部都在同一個時間點進行？
		如果同時進行，該四個動作又很耗系統資源，如此一來，每五分鐘的某個時刻不是會讓系統忙得要死？
		呵呵！此時好好的分配一些執行時間就 OK 啦！所以，注意一下：</p>

		<ul class="toplist"><li>資源分配不均的問題</li></ul>

		<p>當大量使用 crontab 的時候，總是會有問題發生的，最嚴重的問題就是『系統資源分配不均』的問題，
		以鳥哥的系統為例，我有偵測主機流量的資訊，包括：</p>
		<ul>
		<li>流量</li>
		<li>區域內其他 PC 的流量偵測</li>
		<li>CPU 使用率</li>
		<li>RAM 使用率</li>
		<li>線上人數即時偵測</li></ul>
		<p>如果每個流程都在同一個時間啟動的話，那麼在某個時段時，我的系統會變的相當的繁忙，所以，這個時候就必須要分別設定啦！我可以這樣做：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">vim /etc/crontab</span>
1,6,11,16,21,26,31,36,41,46,51,56 * * * * root  CMD1
2,7,12,17,22,27,32,37,42,47,52,57 * * * * root  CMD2
3,8,13,18,23,28,33,38,43,48,53,58 * * * * root  CMD3
4,9,14,19,24,29,34,39,44,49,54,59 * * * * root  CMD4
</pre></td></tr></tbody></table>

		<p>看到了沒？那個『 , 』分隔的時候，請注意，不要有空白字元！（連續的意思）如此一來，
		則可以將每五分鐘工作的流程分別在不同的時刻來工作！則可以讓系統的執行較為順暢呦！</p>

		<ul class="toplist"><li>取消不要的輸出項目</li></ul>

		<p>另外一個困擾發生在『 <span class="text_import2">當有執行成果或者是執行的項目中有輸出的資料時，該資料將會
		mail 給 MAILTO 設定的帳號</span> 』，好啦，那麼當有一個排程一直出錯（例如 DNS
		的偵測系統當中，若 DNS 上層主機掛掉，那麼你就會一直收到錯誤訊息！）怎麼辦？呵呵！還記得<a href="http://linux.vbird.org/linux_basic/0320bash.php#redirect">第十章談到的資料流重導向</a>吧？
		直接以『資料流重導向』將輸出的結果輸出到 <span class="text_import2">/dev/null</span> 這個垃圾桶當中就好了！</p>

		<ul class="toplist"><li>安全的檢驗</li></ul>

		<p>很多時候被植入木馬都是以例行命令的方式植入的，所以可以藉由檢查 /var/log/cron
		的內容來視察是否有『非您設定的 cron 被執行了？』這個時候就需要小心一點囉！</p>

		<ul class="toplist"><li>週與日月不可同時並存</li></ul>

		<p>另一個需要注意的地方在於：『你可以分別以週或者是日月為單位作為循環，但你不可使用「幾月幾號且為星期幾」的模式工作』。
		這個意思是說，你不可以這樣編寫一個工作排程：</p>

<table class="term"><tbody><tr><td class="term"><pre>30 12 11 9 5 root echo "just test"   <span class="term_note">&lt;==這是錯誤的寫法</span>
</pre></td></tr></tbody></table>

		<p>本來你以為九月十一號且為星期五才會進行這項工作，無奈的是，系統可能會判定每個星期五作一次，或每年的 9 月 11 
		號分別進行，如此一來與你當初的規劃就不一樣了～所以囉，得要注意這個地方！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		根據某些人的說法，這個月日、周不可並存的問題已經在新版中被克服了～不過，鳥哥並沒有實際去驗證他！目前也不打算驗證他！
		因為，周就是周，月日就月日，單一執行點就單一執行點，無須使用 crontab 去設定固定的日期啊！您說是吧？
		</fieldset><br>	</div>
</div>


<a id="anacron_1"></a>
<div class="block1">
<h2>15.4 可喚醒停機期間的工作任務</h2>

	<p>想像一個環境，你的 Linux 伺服器有一個工作是需要在每週的星期天凌晨 2 點進行，但是很不巧的，星期六停電了～所以你得要星期一才能進公司去啟動伺服器。
	那麼請問，這個星期天的工作排程還要不要進行？因為你開機的時候已經是星期一，所以星期天的工作當然不會被進行，對吧！</p>

	<p>問題是，若是該工作非常重要 (例如例行備份)，
	所以其實妳還是希望在下個星期天之前的某天還是進行一下比較好～那你該怎辦？自己手動執行？如果你跟鳥哥一樣是個記憶力超差的傢伙，那麼肯定『記不起來某個重要工作要進行』的啦！
	這時候就得要靠 anacron 這個指令的功能了！這傢伙可以主動幫你進行時間到了但卻沒有執行的排程喔！</p>

	<a id="anacron_what"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.4.1 什麼是 anacron</h2>

		<p>anacron 並不是用來取代 crontab 的，anacron 存在的目的就在於我們上頭提到的，在處理非 24 小時一直啟動的 Linux 系統的 crontab 的執行！
		以及因為某些原因導致的超過時間而沒有被執行的排程工作。</p>

		<p>其實 anacron 也是每個小時被 crond 執行一次，然後 anacron 再去檢測相關的排程任務有沒有被執行，如果有超過期限的工作在，
		就執行該排程任務，執行完畢或無須執行任何排程時，anacron 就停止了。</p>

		<p>由於 anacron 預設會以一天、七天、一個月為期去偵測系統未進行的 crontab 任務，因此對於某些特殊的使用環境非常有幫助。
		舉例來說，如果你的 Linux 主機是放在公司給同仁使用的，因為週末假日大家都不在所以也沒有必要開啟，
		因此你的 Linux 是週末都會關機兩天的。但是 crontab 大多在每天的凌晨以及週日的早上進行各項任務，
		偏偏你又關機了，此時系統很多 crontab 的任務就無法進行。 anacron 剛好可以解決這個問題！</p>

		<p>那麼 anacron 又是怎麼知道我們的系統啥時關機的呢？這就得要使用 anacron 讀取的時間記錄檔 (timestamps) 了！
		anacron 會去分析現在的時間與時間記錄檔所記載的上次執行 anacron 的時間，兩者比較後若發現有差異，
		那就是在某些時刻沒有進行 crontab 囉！此時 anacron 就會開始執行未進行的 crontab 任務了！</p>
	<br></div><br>

	<a id="anacron"></a>
	<div class="block2"><div class="gototop"><a href="http://linux.vbird.org/linux_basic/0430cron.php#top">Top</a></div>
	<h2>15.4.2 anacron 與 /etc/anacrontab</h2>

		<p>anacron 其實是一支程式並非一個服務！這支程式在 CentOS 當中已經進入 crontab 的排程喔！同時 anacron 會每個小時被主動執行一次喔！
		咦！每個小時？所以 anacron 的設定檔應該放置在 /etc/cron.hourly 嗎？嘿嘿！您真內行～趕緊來瞧一瞧：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">cat /etc/cron.hourly/0anacron</span>
#!/bin/sh
# Check whether 0anacron was run today already
if test -r /var/spool/anacron/cron.daily; then
    day=`cat /var/spool/anacron/cron.daily`
fi
if [ `date +%Y%m%d` = "$day" ]; then
    exit 0;
fi
<span class="term_say"># 上面的語法在檢驗前一次執行 anacron 時的時間戳記！</span>

# Do not run jobs when on battery power
if test -x /usr/bin/on_ac_power; then
    /usr/bin/on_ac_power &gt;/dev/null 2&gt;&amp;1
    if test $? -eq 1; then
    exit 0
    fi
fi
/usr/sbin/anacron -s
<span class="term_say"># 所以其實也僅是執行 anacron -s 的指令！因此我們得來談談這支程式！</span>
</pre></td></tr></tbody></table>

		<p>基本上， anacron 的語法如下：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">anacron [-sfn] [job]..</span>
[root@study ~]# <span class="term_command">anacron -u [job]..</span>
<span class="term_say">選項與參數：
-s  ：開始一連續的執行各項工作 (job)，會依據時間記錄檔的資料判斷是否進行；
-f  ：強制進行，而不去判斷時間記錄檔的時間戳記；
-n  ：立刻進行未進行的任務，而不延遲 (delay) 等待時間；
-u  ：僅更新時間記錄檔的時間戳記，不進行任何工作。
job ：由 /etc/anacrontab 定義的各項工作名稱。</span>
</pre></td></tr></tbody></table>

		<p>在我們的 CentOS 中，anacron 的進行其實是在每個小時都會被抓出來執行一次，
		但是為了擔心 anacron 誤判時間參數，因此 /etc/cron.hourly/ 裡面的 anacron 才會在檔名之前加個 0 
		(0anacron)，讓 anacron 最先進行！就是為了讓時間戳記先更新！以避免 anacron 誤判 crontab 
		尚未進行任何工作的意思。</p>

		<p>接下來我們看一下 anacron 的設定檔： /etc/anacrontab 的內容好了：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@study ~]# <span class="term_command">cat /etc/anacrontab</span>
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
RANDOM_DELAY=45           <span class="term_note"># 隨機給予最大延遲時間，單位是分鐘</span>
START_HOURS_RANGE=3-22    <span class="term_note"># 延遲多少個小時內應該要執行的任務時間</span>

<span style="text-decoration: underline">1         5        cron.daily         nice run-parts /etc/cron.daily</span>
7        25        cron.weekly        nice run-parts /etc/cron.weekly
@monthly 45        cron.monthly       nice run-parts /etc/cron.monthly
<span class="term_say">天數     延遲時間  工作名稱定義       實際要進行的指令串
# 天數單位為天；延遲時間單位為分鐘；工作名稱定義可自訂，指令串則通常與 crontab 的設定相同！</span>

[root@study ~]# <span class="term_command">more /var/spool/anacron/*</span>
::::::::::::::
/var/spool/anacron/cron.daily
::::::::::::::
<span style="text-decoration: underline">20150731</span>
::::::::::::::
/var/spool/anacron/cron.monthly
::::::::::::::
20150703
::::::::::::::
/var/spool/anacron/cron.weekly
::::::::::::::
20150727
<span class="term_say"># 上面則是三個工作名稱的時間記錄檔以及記錄的時間戳記</span>
</pre></td></tr></tbody></table>

		<p>我們拿 /etc/cron.daily/ 那一行的設定來說明好了。那四個欄位的意義分別是：</p>
		<ul>
		<li>天數：anacron 執行當下與時間戳記 (/var/spool/anacron/ 內的時間紀錄檔) 相差的天數，若超過此天數，就準備開始執行，若沒有超過此天數，則不予執行後續的指令。</li>
		<li>延遲時間：若確定超過天數導致要執行排程工作了，那麼請延遲執行的時間，因為擔心立即啟動會有其他資源衝突的問題吧！</li>
		<li>工作名稱定義：這個沒啥意義，就只是會在 /var/log/cron 裡頭記載該項任務的名稱這樣！通常與後續的目錄資源名稱相同即可。</li>
		<li>實際要進行的指令串：有沒有跟 0hourly 很像啊！沒錯！相同的作法啊！透過 run-parts 來處理的！</li>
		</ul>

		<p>根據上面的設定檔內容，我們大概知道 anacron 的執行流程應該是這樣的 (以 cron.daily 為例)：</p>

		<ol class="text_import2">
		<li>由 /etc/anacrontab 分析到 cron.daily 這項工作名稱的天數為 1 天；</li>
		<li>由 /var/spool/anacron/cron.daily 取出最近一次執行 anacron 的時間戳記；</li>
		<li>由上個步驟與目前的時間比較，若差異天數為 1 天以上 (含 1 天)，就準備進行指令；</li>
		<li>若準備進行指令，根據 /etc/anacrontab 的設定，將延遲 5 分鐘 + 3 小時 (看 START_HOURS_RANGE 的設定)；</li>
		<li>延遲時間過後，開始執行後續指令，亦即『 run-parts /etc/cron.daily 』這串指令；</li>
		<li>執行完畢後， anacron 程式結束。</li>
		</ol>

		<p>如此一來，放置在 /etc/cron.daily/ 內的任務就會在一天後一定會被執行的！因為 anacron 是每個小時被執行一次嘛！
		所以，現在你知道<span class="text_import2">為什麼隔了一陣子才將 CentOS 開機，開機過後約 1 
		小時左右系統會有一小段時間的忙碌！而且硬碟會跑個不停！那就是因為 anacron 正在執行過去 /etc/cron.daily/, /etc/cron.weekly/, /etc/cron.monthly/ 
		裡頭的未進行的各項工作排程啦！</span>這樣對 anacron 有沒有概念了呢？ ^_^</p>

		<p>最後，我們來總結一下本章談到的許多設定檔與目錄的關係吧！這樣我們才能了解 crond 與 anacron 的關係：</p>

		<ol>
		<li>crond 會主動去讀取 /etc/crontab, /var/spool/cron/*, /etc/cron.d/* 等設定檔，並依據『分、時、日、月、周』的時間設定去各項工作排程；</li>
		<li>根據 /etc/cron.d/0hourly 的設定，主動去 /etc/cron.hourly/ 目錄下，執行所有在該目錄下的執行檔；</li>
		<li>因為 /etc/cron.hourly/0anacron 這個指令檔的緣故，主動的每小時執行 anacron ，並呼叫 /etc/anacrontab 的設定檔；</li>
		<li>根據 /etc/anacrontab 的設定，依據每天、每週、每月去分析 /etc/cron.daily/, /etc/cron.weekly/, /etc/cron.monthly/ 內的執行檔，以進行固定週期需要執行的指令。</li>
		</ol>

		<p>也就是說，如果你每個週日的需要執行的動作是放置於 /etc/crontab 的話，那麼該動作只要過期了就過期了，並不會被抓回來重新執行。但如果是放置在
		/etc/cron.weekly/ 目錄下，那麼該工作就會定期，幾乎一定會在一週內執行一次～如果你關機超過一週，那麼一開機後的數個小時內，該工作就會主動的被執行喔！
		真的嗎？對啦！因為 /etc/anacrontab 的定義啦！</p>

		<fieldset class="vbirdface"><legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend><img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/vbird_face.gif" alt="鳥哥的圖示" title="鳥哥的圖示" style="float: right;">		基本上，crontab 與 at 都是『定時』去執行，過了時間就過了！不會重新來一遍～那 anacron 則是『定期』去執行，某一段週期的執行～
		因此，兩者可以並行，並不會互相衝突啦！
		</fieldset><br>	</div>
</div>


<a id="hint"></a>
<div class="block1">
<h2>15.5 重點回顧</h2>
<ul class="text_import2">
	<li>系統可以透過 at 這個指令來排程單一工作的任務！『at TIME』為指令下達的方法，當 at 進入排程後，
	系統執行該排程工作時，會到下達時的目錄進行任務；</li>
	<li>at 的執行必須要有 atd 服務的支援，且 /etc/at.deny 為控制是否能夠執行的使用者帳號；</li>
	<li>透過 atq, atrm 可以查詢與刪除 at 的工作排程；</li>
	<li>batch 與 at 相同，不過 batch 可在 CPU 工作負載小於 0.8 時才進行後續的工作排程；</li>
	<li>系統的循環例行性工作排程使用 crond 這個服務，同時利用 crontab -e 及 /etc/crontab 進行排程的安排；</li>
	<li>crontab -e 設定項目分為六欄，『分、時、日、月、周、指令』為其設定依據；</li>
	<li>/etc/crontab 設定分為七欄，『分、時、日、月、周、執行者、指令』為其設定依據；</li>
	<li>anacron 配合 /etc/anacrontab  的設定，可以喚醒停機期間系統未進行的 crontab 任務！</li>
</ul>
</div>


<a id="ex"></a>
<div class="block1">
<h2>15.6 本章習題</h2>
( 要看答案請將滑鼠移動到『答：』底下的空白處，按下左鍵圈選空白處即可察看 )
簡答題：
<ul>
	<li>今天假設我有一個指令程式，名稱為： ping.sh 這個檔名！我想要讓系統每三分鐘執行這個檔案一次，
	但是偏偏這個檔案會有很多的訊息顯示出來，所以我的
	root 帳號每天都會收到差不多四百多封的信件，光是收信就差不多快要瘋掉了！
	那麼請問應該怎麼設定比較好呢？
	<div class="blockex">
		這個涉及資料流重導向的問題，我們可以將他導入檔案或者直接丟棄！如果該訊息不重要的話，
		那麼就予以丟棄，如果訊息很重要的話，才將他保留下來！假設今天這個命令不重要，
		所以將他丟棄掉！因此，可以這樣寫：<blockquote>
		*/3 * * * * root /usr/local/ping.sh &gt; /dev/null 2&gt;&amp;1</blockquote>
	</div></li>

	<li>您預計要在 2016 年的 2 月 14 日寄出一封給 kiki ，只有該年才寄出！該如何下達指令？
	<div class="blockex">
		at 1am 2016-02-14
	</div></li>

	<li>下達 crontab -e 之後，如果輸入這一行，代表什麼意思？<br>
	* 15 * * 1-5 /usr/local/bin/tea_time.sh
	<div class="blockex">
		在每星期的 1~5 ，下午 3 點的每分鐘，共進行 60 次 /usr/local/bin/tea_time.sh 這個檔案。
		要特別注意的是，每個星期 1~5 的 3 點都會進行 60 次ㄟ！很麻煩吧～是錯誤的寫法啦～
		應該是要寫成：<br>
		30 15 * * 1-5 /usr/local/bin/tea_time.sh
	</div></li>

	<li>我用 vi 編輯 /etc/crontab 這個檔案，我編輯的那一行是這樣的：<br>
	25 00 * * 0   /usr/local/bin/backup.sh<br>
	這一行代表的意義是什麼？
	<div class="blockex">
		這一行代表......沒有任何意義！因為語法錯誤！您必須要瞭解，在 /etc/crontab 
		當中每一行都必須要有使用者才行！所以，應該要將原本那行改成：<br>
		25 00 * * 0 root  /usr/local/bin/backup.sh
	</div></li>

	<li>請問，您的系統每天、每週、每個月各有進行什麼工作？
	<div class="blockex">
		因為 CentOS 系統預設的例行性命令都放置在 /etc/cron.* 裡面，所以，你可以自行去：
		/etc/cron.daily/, /etc/cron.week/, /etc/cron.monthly/ 這三個目錄內看一看，
		就知道啦！ ^_^
	</div></li>

	<li>每個星期六凌晨三點去系統搜尋一下內有 SUID/SGID 的任何檔案！並將結果輸出到 /tmp/uidgid.files
	<div class="blockex">
		vi /etc/crontab<br>
		0 3 * * 6 root find / -perm /6000 &gt; /tmp/uidgid.files
	</div></li>
</ul>
</div>


<div class="block1" style="margin-bottom: 32px; padding-left: 10px; line-height: 1">
<span class="text_history">
2002/05/30：第一次完成<br>
2003/02/10：重新編排與加入 FAQ<br>
2005/09/07：將舊的文章移動到 <a href="http://linux.vbird.org/linux_basic/0430cron/0430cron.php">此處</a> 。<br>
2005/09/07：呼呼！終於完成風格囉～同時加入一些習題練習。<br>
2009/03/12：將舊的文件移動到<a href="http://linux.vbird.org/linux_basic/0430cron/0430cron-fc4.php">此處</a>。<br>
2009/03/14：加入 <a href="http://linux.vbird.org/linux_basic/0430cron.php#batch">batch</a> 這個項目的說明！與 at 有關！<br>
2009/03/15：加入了 anacron  這玩意的簡單說明！<br>
2009/09/11：稍微修訂一下說明語氣與連結資料。<br>
2015/07/31：將舊的基於 CentOS5 的版本移動到<a href="http://linux.vbird.org/linux_basic/0430cron/0430cron-centos5.php">這裡</a>。<br>
</span>
<span class="text_date">2002/05/30以來統計人數</span><br>
<img src="./鳥哥的 Linux 私房菜 -- 第15章、例行性工作排程(crontab)_files/Count(3).cgi" style="height: 15px; width: 60px; " alt="計數器" title="計數器"><br>
</div>

<div class="rightarea">
<a href="http://linux.vbird.org/linux_basic/0440processcontrol.php">&gt;&gt;</a>
</div>

<div style="position: relative; text-align:center; margin-top: -20px; margin-bottom: 40px; width: 100%;">
	<div style="width: 100px; text-align:center; display: inline-block;">
		<a href="http://linux.vbird.org/linux_basic/index.php">HOME</a>
	</div>
		<div style="width: 100px; float: left;">
		<a href="http://linux.vbird.org/linux_basic/0420quota.php">PrePage</a>
	</div>
			<div style="width: 100px; float: right;">
		<a href="http://linux.vbird.org/linux_basic/0440processcontrol.php">NextPage</a>
	</div>
	</div>

</div>	<!-- mainarea -->
</div>  <!-- tablearea -->

<div class="bottomarea">
<ul>
	<li><a href="http://linux.vbird.org/linux_basic/0430cron.php#top" title="Top">Top</a></li>
	<li><a href="http://linux.vbird.org/index_old.php" title="前往鳥哥的 Linux 私房菜首頁">前往舊站</a></li>
	<!--li><a href="http://vbird.dic.ksu.edu.tw" target="_blank" title="前往鳥哥的 Linux 私房菜首頁">簡體主站</a></li-->
	<li><a href="http://phorum.vbird.org/" target="_blank" title="鳥站新手討論板">討論板</a></li>
	<li><a href="http://phorum.study-area.org/" target="_blank" title="酷！學園討論板">酷學園</a></li>
	<li><a href="http://www.dic.ksu.edu.tw/" target="_blank" title="崑山資傳">崑山資傳</a></li>
</ul>
&nbsp;&nbsp; <a href="http://linux.vbird.org/" target="_top" title="前往鳥哥的首頁">http://linux.vbird.org</a>
	is designed by <a href="mailto:vbird@mail.vbird.idv.tw" title="聯絡鳥哥(我不要廣告信！)">VBird</a>
		during 2001-2017. <!--a href="http://www.ksu.edu.tw" target="_blank">ksu.edu</a-->

</div>



</body></html>